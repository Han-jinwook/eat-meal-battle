(()=>{var e={};e.id=846,e.ids=[846],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},80408:()=>{},81630:e=>{"use strict";e.exports=require("http")},85812:(e,t,o)=>{"use strict";o.r(t),o.d(t,{patchFetch:()=>S,routeModule:()=>f,serverHooks:()=>I,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>h});var r={};o.r(r),o.d(r,{GET:()=>d,POST:()=>p});var s=o(48106),a=o(48819),l=o(12050),i=o(4235),n=o(98811),c=o(65208);let m=process.env.NEIS_API_KEY||"";async function u(e,t,o){let r=o;o&&o.includes("-")&&(r=o.replace(/-/g,""),console.log(`API 호출을 위해 날짜 형식 변환: ${o} -> ${r}`));let s=new URLSearchParams({KEY:m,Type:"json",pIndex:"1",pSize:"100",ATPT_OFCDC_SC_CODE:t,SD_SCHUL_CODE:e,MLSV_YMD:r}),a=`https://open.neis.go.kr/hub/mealServiceDietInfo?${s.toString()}`;console.log(`급식 API 요청 URL: ${a}`);let l=await fetch(a);if(!l.ok)throw console.error(`API 응답 상태 코드: ${l.status}`),Error("교육부 급식 API 호출 실패");return await l.json()}function _(e){let t=[];if(e.mealServiceDietInfo&&Array.isArray(e.mealServiceDietInfo)){if(e.mealServiceDietInfo.length>1&&e.mealServiceDietInfo[1].row)for(let o of e.mealServiceDietInfo[1].row){let e=[];o.DDISH_NM&&(e=o.DDISH_NM.replace(/<br\s*\/?>\>/gi,"\n").split("\n").map(e=>e.replace(/\([^)]*\)|\[[^\]]*\]|\{[^}]*\}|<[^>]*>/g,"").split("/").map(e=>e.trim().replace(/[\-\.]?u$/gi,"").replace(/[\-~]?\d*$/,"").trim()).join("/").trim()).filter(e=>e&&e.length>0));let r=o.MLSV_YMD;r&&8===r.length&&(r=`${r.substring(0,4)}-${r.substring(4,6)}-${r.substring(6,8)}`);let s=o.MMEAL_SC_NM;"breakfast"===s||"Breakfast"===s?s="조식":"lunch"===s||"Lunch"===s?s="중식":("dinner"===s||"Dinner"===s)&&(s="석식");let a=o.ORPLC_INFO||null;if(a){let e="string"==typeof a?a:JSON.stringify(a),t=(e=e.replace(/<br\s*\/?>/gi,"\n")).split("\n").map(e=>e.trim()).filter(e=>e&&!e.startsWith("비고")&&e.includes(" : ")&&!e.includes("수산가공품")&&!e.includes("식육가공품")),o=[/비고/i,/가공품/i,/수산가공품/i,/식육가공품/i];a=t.filter(e=>!o.some(t=>t.test(e))).join("\n")}let l=o.NTR_INFO||null;if(l){let e="string"==typeof l?l:JSON.stringify(l);l=e=e.replace(/<br\s*\/?>/gi,"\n")}t.push({school_code:o.SD_SCHUL_CODE,office_code:o.ATPT_OFCDC_SC_CODE,meal_date:r,meal_type:s,menu_items:e,kcal:o.CAL_INFO||"0 kcal",origin_info:a,ntr_info:l,raw_data:o})}}else e.RESULT&&"SUCCESS"!==e.RESULT.CODE&&console.error(`API 오류: ${e.RESULT.CODE} - ${e.RESULT.MESSAGE||"알 수 없는 오류"}`);return t}async function d(e){let t=(0,c.UL)(),o=(0,n.Ri)("https://izkumvvlkrkgiuuczffp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VtdnZsa3JrZ2l1dWN6ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI3NzksImV4cCI6MjA2MDk4ODc3OX0.pQH_znuBuBfLBJdnMagX4_HE37Z8uraCp1_MaJFtEfc",{cookies:{get:e=>t.get(e)?.value,set(e,o,r){t.set(e,o,r)},remove(e,o){t.set(e,"",{...o,maxAge:0})}}}),{searchParams:r}=new URL(e.url),s=r.get("school_code"),a=r.get("office_code"),l=r.get("date");if(!s||!a||!l)return i.NextResponse.json({error:"필수 파라미터가 누락되었습니다 (school_code, office_code, date)"},{status:400});try{let e=l;l&&8===l.length&&!l.includes("-")&&(e=`${l.substring(0,4)}-${l.substring(4,6)}-${l.substring(6,8)}`,console.log(`날짜 형식 변환 (조회 전): ${l} -> ${e}`));let{data:t,error:r}=await o.from("meal_menus").select("*").eq("school_code",s).eq("meal_date",e);if(r)throw Error(`DB 조회 오류: ${r.message}`);if(t&&t.length>0){console.log(`DB에서 ${t.length}개의 급식 정보를 가져왔습니다.`);let o=t.some(e=>"empty"===e.meal_type);return i.NextResponse.json({success:!0,date:e,meals:o?[]:t,source:"database",is_empty_result:o,school_code:s,office_code:a})}console.log("DB에 없는 데이터입니다. API 호출을 시도합니다.");let n=await u(s,a,l),c=_(n);try{console.log(`저장에 사용할 날짜 형식: ${e}`);let{data:t,error:r}=await o.from("meal_menus").select("id, meal_type").eq("school_code",s).eq("meal_date",e);if(r&&console.error("기존 데이터 확인 오류:",r),t&&t.length>0){console.log(`이미 DB에 ${e} 날짜의 급식 정보가 ${t.length}개 있습니다.`);let{data:r,error:l}=await o.from("meal_menus").select("*").eq("school_code",s).eq("meal_date",e);if(l)throw console.error("기존 데이터 조회 오류:",l),Error(`기존 데이터 조회 오류: ${l.message}`);let n=r&&r.some(e=>"empty"===e.meal_type);return i.NextResponse.json({success:!0,date:e,meals:n?[]:r,source:"database",is_empty_result:n,school_code:s,office_code:a})}if(c&&c.length>0){let e=c.map(e=>({school_code:e.school_code,office_code:e.office_code,meal_date:e.meal_date,meal_type:e.meal_type,menu_items:e.menu_items,kcal:e.kcal,origin_info:e.origin_info,ntr_info:e.ntr_info||{}})),{error:t}=await o.from("meal_menus").insert(e);t?console.error("급식 정보 DB 저장 오류:",t):console.log(`${c.length}개의 급식 정보를 DB에 저장했습니다.`)}else{let t={school_code:s,office_code:a,meal_date:e,meal_type:"중식",menu_items:["급식 정보가 없습니다"],kcal:"0 kcal",origin_info:[],ntr_info:{}};try{let{error:e}=await o.from("meal_menus").insert([t]);e?console.error("빈 급식 정보 DB 저장 오류:",e):console.log("빈 급식 정보를 DB에 저장했습니다.")}catch(e){console.error("빈 급식 정보 저장 오류:",e)}n.RESULT&&"INFO-000"!==n.RESULT.CODE&&console.error(`API 오류: ${n.RESULT.CODE} - ${n.RESULT.MESSAGE||"알 수 없는 오류"}`)}}catch(e){console.error("DB 저장 중 오류 발생:",e)}let{data:m,error:d}=await o.from("meal_menus").select("*").eq("school_code",s).eq("meal_date",e);d&&console.error("저장된 데이터 조회 오류:",d);let p=m&&m.length>0?m:c,f=m&&m.length>0?m.some(e=>"empty"===e.meal_type):0===c.length;if(0===p.length&&!f){console.log(`${e} 날짜의 급식 정보가 없습니다. 빈 레코드 저장 시도...`),console.log(`중복 여부 검사: ${s}, ${a}, ${e}`);let{data:t,error:r}=await o.from("meal_menus").select("id").eq("school_code",s).eq("office_code",a).eq("meal_date",e);if(r&&console.error("중복 확인 오류:",r),t&&t.length>0){console.log(`이미 ${t.length}개의 동일한 레코드가 있어 저장하지 않습니다.`),console.log("DB 쿼리 조건:",{school_code:s,office_code:a,meal_date:e});let{data:r}=await o.from("meal_menus").select("*").eq("school_code",s).eq("office_code",a).eq("meal_date",e);r&&r.length>0&&(p=r,f=r.some(e=>"empty"===e.meal_type))}else{let t={school_code:s,office_code:a,meal_date:e,meal_type:"중식",menu_items:["급식 정보가 없습니다 (주말 또는 공휴일)"],kcal:"0 kcal",origin_info:[],ntr_info:{}};try{let{data:e,error:r}=await o.from("meal_menus").insert([t]).select();r?console.error("빈 급식 정보 DB 저장 오류:",r):(console.log("빈 급식 정보를 DB에 성공적으로 저장했습니다."),f=!0,p=e||[])}catch(e){console.error("빈 급식 정보 저장 오류:",e)}}}let g=e||l;return i.NextResponse.json({success:!0,date:g,meals:f?[]:p,source:f||m&&m.length>0?"database":"api",is_empty_result:f,school_code:s,office_code:a})}catch(e){return console.error("급식 정보 API 오류:",e),i.NextResponse.json({error:"급식 정보를 가져오는 중 오류가 발생했습니다"},{status:500})}}async function p(e){let t=(0,c.UL)(),o=(0,n.Ri)("https://izkumvvlkrkgiuuczffp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VtdnZsa3JrZ2l1dWN6ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI3NzksImV4cCI6MjA2MDk4ODc3OX0.pQH_znuBuBfLBJdnMagX4_HE37Z8uraCp1_MaJFtEfc",{cookies:{get:e=>t.get(e)?.value,set(e,o,r){t.set(e,o,r)},remove(e,o){t.set(e,"",{...o,maxAge:0})}}}),r=function(e){let t=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${t}${o}${r}`}(new Date);try{let{data:e,error:t}=await o.from("school_infos").select("school_code, region").order("school_code");if(t)throw Error(`학교 정보 조회 실패: ${t.message}`);if(!e||0===e.length)return i.NextResponse.json({message:"등록된 학교가 없습니다"});let s=new Map;e.forEach(e=>{let t=`${e.school_code}-B10`;s.has(t)||s.set(t,{school_code:e.school_code,office_code:"B10"})}),console.log(`총 ${s.size}개 학교의 급식 정보를 가져옵니다...`);let a=[],l=[];for(let[e,t]of s.entries()){try{let e=await u(t.school_code,t.office_code,r),o=_(e);o.length>0&&a.push(...o)}catch(o){console.error(`${e} 학교 급식 정보 가져오기 실패:`,o),l.push({school_code:t.school_code,office_code:t.office_code,error:o.message})}await new Promise(e=>setTimeout(e,300))}if(!(a.length>0))return i.NextResponse.json({success:!1,message:"저장할 급식 정보가 없습니다",errors:l,date:r});{let e=a.map(e=>({school_code:e.school_code,office_code:e.office_code,meal_date:e.meal_date,meal_type:e.meal_type,menu_items:e.menu_items,kcal:e.kcal,origin_info:e.origin_info,ntr_info:e.ntr_info})),t=0;for(let r of e)try{let{data:e,error:s}=await o.from("meal_menus").select("id").eq("school_code",r.school_code).eq("meal_date",r.meal_date).eq("meal_type",r.meal_type).maybeSingle();if(s&&"PGRST116"!==s.code){console.error(`급식 데이터 조회 오류: ${s.message}`),t++;continue}if(e){let{error:s}=await o.from("meal_menus").update({menu_items:r.menu_items,kcal:r.kcal,origin_info:r.origin_info,ntr_info:r.ntr_info,updated_at:new Date().toISOString()}).eq("id",e.id);s&&(console.error(`급식 데이터 업데이트 오류: ${s.message}`),t++)}else{let{error:e}=await o.from("meal_menus").insert([r]);e&&(console.error(`급식 데이터 추가 오류: ${e.message}`),t++)}}catch(e){console.error(`급식 데이터 처리 중 예외 발생: ${e.message}`),t++}return i.NextResponse.json({success:!0,message:`${a.length}개의 급식 정보가 성공적으로 저장되었습니다`,errors:l.length>0?l:void 0,date:r})}}catch(e){return console.error("급식 정보 처리 오류:",e),i.NextResponse.json({success:!1,error:`급식 정보 처리 중 오류가 발생했습니다: ${e.message}`},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/meals/route",pathname:"/api/meals",filename:"route",bundlePath:"app/api/meals/route"},resolvedPagePath:"D:\\Windsurf\\eat-meal-battle\\apps\\app\\src\\app\\api\\meals\\route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:g,workUnitAsyncStorage:h,serverHooks:I}=f;function S(){return(0,l.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:h})}},87032:()=>{},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[50,744,156,811,208],()=>o(85812));module.exports=r})();