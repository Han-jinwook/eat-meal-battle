(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{3955:e=>{e.exports={container:"StarRating_container__wcvPj",starRating:"StarRating_starRating__1zTCK",star:"StarRating_star__QCP0_",small:"StarRating_small__LixRz",medium:"StarRating_medium__lZz_C",large:"StarRating_large__lmltq",filled:"StarRating_filled__5rpji",halfFilled:"StarRating_halfFilled__9vrBQ",empty:"StarRating_empty__CGeAC",positive:"StarRating_positive__kbCSb",neutral:"StarRating_neutral__Ty9Xe",negative:"StarRating_negative__Xz_Do",ratingInfo:"StarRating_ratingInfo__ihrMI",ratingValue:"StarRating_ratingValue__f82Mo",ratingCount:"StarRating_ratingCount__kNgMm"}},4605:(e,t,a)=>{Promise.resolve().then(a.bind(a,9566))},9566:(e,t,a)=>{"use strict";let l;a.r(t),a.d(t,{default:()=>T});var r=a(4568),s=a(7620),n=a(2942),i=a(1525),o=a(6202);let c=e=>{if(!e||""===e.trim())return"/images/placeholder.jpg";if(e.startsWith("/api/image-proxy")||(/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(\/|$)/.test(e)&&!e.startsWith("http")&&(e="https://".concat(e)),e.startsWith("/")&&!e.startsWith("//")))return e;try{if(e.startsWith("//"))e="https:".concat(e);else if(!e.startsWith("http"))return"/images/placeholder.jpg";if(e.includes("supabase.co")&&e.includes("/storage/")||e.startsWith("http")){let t=encodeURIComponent(e);return"/api/image-proxy?url=".concat(t)}return"/images/placeholder.jpg"}catch(e){return console.warn("이미지 URL 처리 오류:",e),"/images/placeholder.jpg"}},d=e=>{try{let t=e.currentTarget;if(t.style.display="none",t.parentElement&&(t.parentElement.style.backgroundColor="#f3f4f6",!t.parentElement.querySelector(".image-fallback"))){let e=document.createElement("div");e.innerText="이미지를 불러올 수 없습니다",e.className="image-fallback flex items-center justify-center h-full w-full text-gray-500 text-sm",t.parentElement.appendChild(e)}e.preventDefault()}catch(e){console.warn("이미지 에러 처리 중 오류 발생",e)}},m=e=>{let{src:t,alt:a,className:l="",style:s={}}=e,n=(null==t?void 0:t.startsWith("data:"))?t:c(t);return(0,r.jsx)("img",{src:n,alt:a,className:l,style:s,onError:d,loading:"lazy"})};function u(e){let{schoolCode:t,mealDate:a,mealType:l,onUploadSuccess:n,onUploadError:o}=e,c=(0,i.UU)(),[d,u]=(0,s.useState)(!1),[g,h]=(0,s.useState)(null),[f,x]=(0,s.useState)(null),[p,_]=(0,s.useState)(!1),[y,v]=(0,s.useState)(null),[w,b]=(0,s.useState)(null),[j,N]=(0,s.useState)(null),[S,k]=(0,s.useState)(!1),[C,I]=(0,s.useState)("none"),[A,E]=(0,s.useState)(!1),L=(0,s.useRef)(null);(0,s.useEffect)(()=>{(async()=>{let{data:{user:e}}=await c.auth.getUser();e&&N(e.id)})()},[c]),(0,s.useEffect)(()=>{let e=async()=>{if(!t){console.log("schoolCode가 없음, AI 버튼 비활성화"),E(!1);return}console.log("학교 코드 확인:",t);let e=new Date,a=e.toLocaleString("en-CA",{timeZone:"Asia/Seoul",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}),[l,r]=a.split(", "),[s,n]=r.split(":"),i=parseInt(s),o=parseInt(n);console.log("현재 시간 정보:",{utcNow:e.toISOString(),koreaTimeString:a,today:l,hour:i,minute:o});try{let{data:e,error:a}=await c.from("meal_menus").select("id, meal_date, menu_items").eq("id",mealId).maybeSingle();if(console.log("급식 정보 조회 결과:",{today:l,schoolCode:t,mealData:e,error:a}),a){console.error("급식 정보 조회 오류:",a),E(!1);return}if(!e){console.log("오늘 날짜의 해당 학교 급식 정보가 없음 - AI 버튼 비활성화"),E(!1);return}let r=e.id;console.log("획득한 mealId:",r);let s=Array.isArray(e.menu_items)&&e.menu_items.length>0&&!e.menu_items.some(e=>"string"==typeof e&&e.includes("급식 정보가 없습니다"));if(console.log("급식 정보 상세:",{menu_items:e.menu_items,menu_items_count:Array.isArray(e.menu_items)?e.menu_items.length:0,hasValidMeal:s}),!s){console.log("AI 이미지 생성 버튼 비활성화: 급식 정보가 없거나 메뉴가 비어있음"),E(!1);return}if(!s){console.log("AI 이미지 생성 버튼 비활성화: 유효한 급식 정보가 없음"),E(!1);return}let n=i>12||12===i&&o>=30;if(console.log("시간 조건 확인:",{hour:i,minute:o,isPastCutoffTime:n}),!n){console.log("AI 이미지 생성 버튼 비활성화: 12:30 이전"),E(!1);return}}catch(e){console.error("급식 정보 조회 중 예외 발생:",e),E(!1);return}try{console.log("이미지 조회 시도 - 파라미터:",{currentMealId,테이블:"meal_images",조회필드:"id, status",조건필드:"meal_id"});let{data:e,error:t}=await c.from("meal_images").select("id, status").eq("meal_id",currentMealId).eq("status","approved"),{data:a,error:l}=await c.from("meal_images").select("id, status").eq("meal_id",currentMealId);if(console.log("이미지 조회 결과:",{approvedImages:e,approvedImagesError:t,allImages:a,allImagesError:l}),t||l){console.error("이미지 조회 오류:",{approvedImagesError:t,allImagesError:l}),E(!1);return}let r=e&&e.length>0,s=!r;console.log("AI 이미지 생성 버튼 표시 여부:",{hasAllImages:a&&a.length>0,allImageStatuses:a?a.map(e=>e.status):[],hasApprovedImages:e&&e.length>0,approvedImageCount:e?e.length:0,hasApprovedImage:r,shouldShow:s}),E(s)}catch(e){console.error("이미지 조회 중 예외 발생:",e),E(!1)}};mealId&&e()},[mealId,c]),(0,s.useEffect)(()=>{w&&(console.log("이미지 업로드 완료: AI 이미지 생성 버튼 비활성화"),E(!1))},[w]);let q=(0,s.useCallback)(async()=>{let e=new Date().toLocaleString("en-CA",{timeZone:"Asia/Seoul",year:"numeric",month:"2-digit",day:"2-digit",hour12:!1}).split(", ")[0];console.log("승인된 이미지 조회 시작:",{today:e,schoolCode:t});let{data:a,error:l}=await c.from("meal_menus").select("id").eq("meal_date",e).eq("school_code",t).maybeSingle();if(l||!a)return void console.log("오늘 날짜의 급식 정보가 없음:",l);let r=a.id;console.log("승인된 이미지 조회 - mealId:",r);let{data:s,error:n}=await c.from("meal_images").select("*").eq("meal_id",r).eq("status","approved").maybeSingle();if(n){"PGRST116"!==n.code&&console.debug("기존 승인 이미지 조회 오류:",n);return}if(s){if(console.log("승인된 이미지 발견:",s.id),s.uploaded_by){let{data:e,error:t}=await c.from("users").select("nickname").eq("id",s.uploaded_by).single();!t&&e&&(console.log("AI 이미지 생성 - 사용자 정보 조회 성공:",e),s.uploader_nickname=e.nickname)}b(s),E(!1)}},[t,c]);(0,s.useEffect)(()=>{q()},[q]),(0,s.useEffect)(()=>{if(!t)return;console.log("실시간 이미지 구독 설정:",t);let e=c.channel("meal-images-".concat(t)).on("postgres_changes",{event:"*",schema:"public",table:"meal_images"},e=>{console.log("이미지 실시간 업데이트 수신:",e),e.new&&("approved"===e.new.status||e.old&&"approved"!==e.old.status&&"approved"===e.new.status)&&(console.log("승인된 이미지 변경 감지, 이미지 다시 가져오기"),q())}).subscribe();return()=>{console.log("이미지 실시간 구독 해제:",t),c.removeChannel(e)}},[t,c,q]);let R=async()=>{try{let e;console.log("AI 이미지 생성 버튼 클릭!"),h(null),L.current&&(L.current.value=""),u(!1),x(null),_(!1),I("generating"),console.log("메뉴 정보 조회 시도:",{schoolCode:t,mealDate:a,mealType:l});let{data:r,error:s}=await c.from("meal_menus").select("id, menu_items, meal_date, meal_type, school_code").eq("school_code",t).eq("meal_date",a).eq("meal_type",l).single();if(s)throw console.error("메뉴 정보 조회 오류:",s),Error("메뉴 정보를 찾을 수 없습니다.");if(!r||!r.menu_items||0===r.menu_items.length)throw console.error("메뉴 정보가 없습니다:",r),Error("급식 메뉴 정보가 없습니다.");console.log("메뉴 정보 조회 성공:",{menuItems:r.menu_items,menuCount:r.menu_items.length,mealDate:r.meal_date,mealType:r.meal_type,schoolCode:r.school_code});let i="/.netlify/functions/generate-meal-image";console.log("AI 이미지 생성 API 요청 URL:",i);let d=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({menu_items:r.menu_items,meal_id:mealId,school_code:r.school_code||t,meal_date:r.meal_date||a,meal_type:r.meal_type||l,user_id:j})});console.log("AI 이미지 생성 API 응답 상태 코드:",d.status,d.statusText);let m=await d.text();console.log("AI 이미지 생성 API 응답 텍스트(처음 200자):",m.substring(0,200));try{e=JSON.parse(m),console.log("AI 이미지 생성 API 응답 파싱 결과:",e)}catch(e){throw console.error("AI 이미지 생성 API 응답 파싱 오류:",e),console.error("파싱 오류 발생한 응답의 처음 부분:",m.substring(0,50)),Error("응답 처리 중 오류가 발생했습니다. 상태 코드: ".concat(d.status))}if(!e.success)throw Error(e.error||"AI 이미지 생성에 실패했습니다.");if(console.log("AI 이미지 생성 성공:",e.image),e.image&&e.image.uploaded_by)try{let{data:t,error:a}=await c.from("users").select("nickname, profile_image").eq("id",e.image.uploaded_by).single();!a&&t&&(console.log("AI 이미지 생성 - 사용자 정보 조회 성공:",t),e.image.uploader_nickname=t.nickname,e.image.users={nickname:t.nickname,profile_image:t.profile_image})}catch(e){console.error("AI 이미지 생성 - 사용자 정보 조회 예외:",e)}b(e.image),v({isMatch:!0,matchScore:1,explanation:"AI가 생성한 이미지입니다. 메뉴에 맞게 자동 생성되었습니다."}),I("complete"),console.log("⏱️ 이미지 업로드 후 콜백 호출 대기 중..."),setTimeout(()=>{console.log("⏱️ 콜백 호출 타이머 완료, onUploadSuccess 호출"),n&&n()},4e3);let g=f&&"object"==typeof f&&f.message?f.message:"AI 이미지 생성 중 오류가 발생했습니다.";x(g),I("error"),o&&o(g)}finally{u(!1)}},U=async e=>{try{let t;_(!0);let a=/^(localhost|127\.|\/api)/.test(window.location.hostname)?"/api/meal-images/verify":"/.netlify/functions/verify-meal-image";console.log("검증 API 요청 URL:",a);let l=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageId:e})}),r=await l.text();try{t=JSON.parse(r),console.log("검증 API 응답:",t)}catch(e){if(console.error("검증 API 응답 파싱 오류:",e,r),l.ok)throw Error("응답 파싱 오류: 올바른 JSON 응답이 아닙니다");throw Error("검증 API 오류: ".concat(l.status," ").concat(l.statusText))}if(!l.ok)throw Error((null==t?void 0:t.error)||"이미지 검증 중 오류가 발생했습니다.");return v(t),t}catch(e){throw console.error("이미지 검증 오류:",e),x(e.message||"이미지 검증 중 오류가 발생했습니다."),e}finally{_(!1)}},T=async()=>{var e,r;if(!(null==(r=L.current)||null==(e=r.files)?void 0:e[0]))return void x("업로드할 이미지를 선택해주세요.");console.log("업로드 시도:",{fileName:L.current.files[0].name,fileSize:L.current.files[0].size,mealId:mealId||"undefined",preview:!!g}),u(!0),x(null),v(null);let s="";try{let e,r=L.current.files[0],{data:{user:i}}=await c.auth.getUser();if(!i)throw Error("로그인이 필요합니다.");let o=new FormData;o.append("file",r),o.append("meal_id",mealId),o.append("school_code",t),o.append("meal_date",a),o.append("meal_type",l),o.append("user_id",i.id),console.log("서버 사이드 업로드 시도...",{meal_id:mealId,school_code:t,meal_date:a,meal_type:l,file_name:r.name,file_size:r.size});let d=/^(localhost|127\.|\/api)/.test(window.location.hostname)?"/api/meal-images/upload":"/.netlify/functions/upload-meal-image";console.log("업로드 API 요청 URL:",d);let m=await fetch(d,{method:"POST",body:o});if(!m.ok){let e=await m.text(),t="서버 오류: ".concat(m.status," ").concat(m.statusText);try{if(e.trim().startsWith("{")){let a=JSON.parse(e);a.error&&(t=a.error)}}catch(e){console.error("응답 파싱 오류:",e)}throw x(t),Error(t)}try{let t=await m.text();e=JSON.parse(t)}catch(e){throw console.error("성공 응답 파싱 오류:",e),x("응답 데이터 파싱 중 오류가 발생했습니다"),Error("응답 데이터 파싱 오류")}console.log("업로드 성공:",e),s=e.id;try{let e=await U(s);console.log("검증 결과:",e);let{data:t}=await c.from("meal_images").select("*").eq("id",s).single();if(t){let a=null;if(t.uploaded_by)try{let{data:e}=await c.from("users").select("nickname").eq("id",t.uploaded_by).single();a=(null==e?void 0:e.nickname)||null}catch(e){console.error("사용자 정보 조회 오류:",e)}let l={...t,uploader_nickname:a,status:e.isMatch?"approved":"rejected",match_score:e.matchScore||0,explanation:e.explanation||null};b(l)}console.log("⏱️ 이미지 업로드 후 콜백 호출 대기 중..."),setTimeout(()=>{console.log("⏱️ 콜백 호출 타이머 완료, onUploadSuccess 호출"),n&&n()},2e3)}catch(e){console.error("검증 오류:",e);try{let{data:e}=await c.from("meal_images").select("*").eq("id",s).single();if(e){let t=null;if(e.uploaded_by)try{let{data:a}=await c.from("users").select("nickname").eq("id",e.uploaded_by).single();t=(null==a?void 0:a.nickname)||null}catch(e){console.error("사용자 정보 조회 오류:",e)}let a={...e,uploader_nickname:t,status:"rejected",explanation:"이미지 검증 중 오류가 발생했습니다."};b(a)}}catch(e){console.error("이미지 정보 조회 오류:",e)}n&&n()}L.current&&(L.current.value=""),h(null)}catch(e){console.error("이미지 업로드 오류:",e),x(e.message||"이미지 업로드 중 오류가 발생했습니다."),o&&o(e.message||"이미지 업로드 중 오류가 발생했습니다.")}finally{u(!1)}},M=async()=>{if(w)try{let{data:e}=await c.from("meal_images").select("*").eq("id",w.id).single();if(!e)throw Error("이미지를 찾을 수 없습니다.");if("approved"===e.status)return void x("승인되거나 공유된 이미지는 삭제할 수 없습니다.");let{error:t}=await c.from("meal_images").delete().eq("id",w.id);if(t)throw t;try{let t=new URL(e.image_url).pathname.split("/"),a=t[t.length-1];console.log("삭제할 파일 경로:",a);let{error:l}=await c.storage.from("meal-images").remove([a]);l&&console.error("스토리지 이미지 삭제 오류:",l)}catch(e){console.error("파일 경로 추출 오류:",e)}b(null),v(null),h(null),L.current&&(L.current.value=""),n&&n()}catch(e){console.error("이미지 삭제 오류:",e),x(e.message||"이미지 삭제 중 오류가 발생했습니다.")}};return(0,r.jsx)("div",{className:"p-0 mb-0 max-w-xl mx-auto",children:w?(0,r.jsx)("div",{children:(0,r.jsxs)("div",{className:"overflow-hidden rounded-lg",children:[(0,r.jsx)("div",{className:"relative w-full h-auto",children:(0,r.jsx)(m,{src:w.image_url,alt:"급식 이미지",style:{width:"100%",height:"auto",maxHeight:"80vh",display:"block"}})}),(0,r.jsxs)("div",{className:"px-0 py-1 text-xs",children:[(0,r.jsxs)("div",{className:"flex justify-end items-center",children:["user_ai"===w.source&&w.uploader_nickname&&(0,r.jsxs)("span",{className:"text-xs text-gray-500 text-right",children:["AI로 생성한 이미지 (",w.uploader_nickname,")"]}),"user_ai"===w.source&&!w.uploader_nickname&&(0,r.jsx)("span",{className:"text-xs text-gray-500 text-right",children:"AI로 생성한 이미지"}),"auto_ai"===w.source&&(0,r.jsx)("span",{className:"text-xs text-gray-500 text-right",children:"AI로 생성한 이미지"}),"user"===w.source&&w.uploader_nickname&&(0,r.jsxs)("span",{className:"text-xs text-gray-500 text-right",children:["(",w.uploader_nickname,")"]})]}),"rejected"===w.status&&(0,r.jsx)("div",{className:"text-sm mb-2",children:"rejected"===w.status&&(0,r.jsx)("span",{className:"text-orange-600 ml-1",children:"(매칭실패, 업로드 불가)"})}),"rejected"===w.status&&w.explanation&&(0,r.jsxs)("div",{className:"text-sm text-gray-700 mb-2",children:[(0,r.jsx)("span",{className:"font-semibold",children:"사유:"})," ",w.explanation]}),"approved"!==w.status&&(0,r.jsx)("button",{onClick:M,className:"mt-2 text-sm text-red-600 hover:text-red-800",children:"삭제"})]})]})}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"오늘의 급식 사진을 공유해보세요!"}),(0,r.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var t,a,l;let r=null==(t=e.target.files)?void 0:t[0];if(!r)return;if(console.log("파일 선택됨:",{fileName:r.name,fileSize:r.size,mealId:mealId||"undefined",fileType:r.type}),!r.type.startsWith("image/"))return void x("이미지 파일만 업로드할 수 있습니다.");if(r.size>5242880)return void x("파일 크기는 5MB 이하여야 합니다.");k(!1),I("processing"),console.log("버튼 타이머 시작"),setTimeout(()=>{k(!0),console.log("버튼 활성화 타이머 완료")},6e3);let s=new FileReader;s.onload=e=>{var t;h(null==(t=e.target)?void 0:t.result)},s.readAsDataURL(r),x(null),v(null),u(!1),_(!1),console.log("파일 로드 완료, 상태:",{file:!!r,previewSet:!!(null==(l=e.target)||null==(a=l.files)?void 0:a[0]),uploading:!1,verifying:!1,isButtonReady:!1,imageStatus:"processing"})},ref:L,className:"block w-full text-sm text-gray-500   file:mr-4 file:py-2 file:px-4   file:rounded-md file:border-0   file:text-sm file:font-semibold   file:bg-blue-50 file:text-blue-700   hover:file:bg-blue-100"})]}),g&&(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"미리보기:"}),(0,r.jsx)("div",{className:"relative w-full h-64 bg-gray-100 rounded-md overflow-hidden",children:(0,r.jsx)(m,{src:g,alt:"업로드 이미지 미리보기",style:{objectFit:"contain",position:"absolute",width:"100%",height:"100%"}})})]}),f&&(0,r.jsx)("div",{className:"mb-4 p-3 bg-red-50 text-red-700 rounded-md text-sm",children:f}),(0,r.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,r.jsx)("button",{disabled:d||p||!g||!S,onClick:()=>{console.log("업로드 버튼 클릭, 상태:",{uploading:d,verifying:p,preview:!!g,isDisabled:d||p||!g}),T()},className:"px-4 py-2 rounded-md text-white ".concat(d||p||!g||!S?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"),children:d||p?(0,r.jsxs)("span",{className:"flex items-center",children:[(0,r.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"AI 분석 중..."]}):!S&&g?(0,r.jsxs)("span",{className:"flex items-center",children:[(0,r.jsxs)("svg",{className:"animate-pulse -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"AI 분석 준비 중..."]}):"업로드 및 AI 검증"}),(0,r.jsx)("button",{onClick:R,disabled:!A||"generating"===C,className:"px-4 py-2 rounded-md text-white ".concat(A&&"generating"!==C?"bg-green-600 hover:bg-green-700":"bg-gray-400 cursor-not-allowed"," flex items-center"),children:"generating"===C?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"AI 이미지 생성 중..."]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})}),"AI 이미지 생성"]})})]})]})})}var g=a(8556),h=a(3955),f=a.n(h);let x=e=>{let{value:t=0,onChange:a,interactive:l=!1,size:n="medium",showValue:i=!1,ratingCount:o}=e,c=(0,s.useRef)(!0),[d,m]=(0,s.useState)(!1),u=(0,s.useRef)(null),h=Math.round(10*t)/10,x={small:f().small,medium:f().medium,large:f().large}[n],p=h>=4?f().positive:h>=3?f().neutral:f().negative,_=e=>{let t=h>=e+1,a=h>=e+.5&&h<e+1;return t?(0,r.jsx)(g.gt3,{className:"".concat(f().star," ").concat(f().filled," ").concat(p)}):a?(0,r.jsx)(g.gVl,{className:"".concat(f().star," ").concat(f().halfFilled," ").concat(p)}):(0,r.jsx)(g.wei,{className:"".concat(f().star," ").concat(f().empty)})};(0,s.useEffect)(()=>()=>{c.current=!1,null!==u.current&&(window.clearTimeout(u.current),u.current=null)},[]);let y=(0,s.useCallback)(e=>{if(!d&&l)try{if(m(!0),!c.current)return;a&&a(e+1),null!==u.current&&clearTimeout(u.current),u.current=window.setTimeout(()=>{c.current&&m(!1)},300)}catch(e){console.error("별점 클릭 처리 중 오류:",e),c.current&&m(!1)}},[l,a,d]),v=s.useMemo(()=>[0,1,2,3,4].map(e=>(0,r.jsx)("span",{onClick:t=>{t.stopPropagation(),y(e)},style:{cursor:l&&!d?"pointer":"default",opacity:d?.7:1,transition:"opacity 0.2s ease-in-out"},role:"button","aria-label":"".concat(e+1,"점 평가하기"),children:_(e)},e)),[l,d,_,y]);return(0,r.jsxs)("div",{className:f().container,children:[(0,r.jsx)("div",{className:"".concat(f().starRating," ").concat(x),children:v}),i&&h>0&&(0,r.jsxs)("div",{className:f().ratingInfo,children:[(0,r.jsx)("span",{className:"".concat(f().ratingValue," ").concat(p),children:h.toFixed(1)}),void 0!==o&&(0,r.jsxs)("span",{className:f().ratingCount,children:["(",o,"명)"]})]})]})},p=(0,i.UU)(),_=e=>{let{mealId:t}=e,[a,l]=(0,s.useState)(null),[n,i]=(0,s.useState)(null),[o,c]=(0,s.useState)(!0),d=(0,s.useRef)(!0);(0,s.useEffect)(()=>((async()=>{let{data:e}=await p.auth.getUser();d.current&&l(null==e?void 0:e.user)})(),()=>{d.current=!1}),[]);let m=async()=>{if(t&&a)try{c(!0);let{data:e,error:l}=await p.from("meal_ratings").select("rating").eq("meal_id",t).eq("user_id",a.id).maybeSingle();if(!d.current)return;if(l&&"PGRST116"!==l.code)return void console.error("내 급식 평점 조회 오류:",l.message);e?i(e.rating):i(null)}catch(e){console.error("내 급식 평점 조회 중 오류 발생:",e)}finally{d.current&&c(!1)}};(0,s.useEffect)(()=>{a&&t&&m()},[a,t]),(0,s.useEffect)(()=>{if(!t||!a)return;let e=[{table:"menu_item_ratings",filter:""},{table:"menu_item_rating_stats",filter:""},{table:"meal_rating_stats",filter:"meal_id=eq.".concat(t)}].map(e=>{let{table:a,filter:l}=e;return p.channel("".concat(a,":").concat(t)).on("postgres_changes",{event:"*",schema:"public",table:a,...l?{filter:l}:{}},async()=>{await u(),m()}).subscribe()});return()=>{e.forEach(e=>p.removeChannel(e))}},[t,a]),(0,s.useEffect)(()=>{if(!t)return;let e=p.channel("meal_rating_stats:".concat(t)).on("postgres_changes",{event:"*",schema:"public",table:"meal_rating_stats",filter:"meal_id=eq.".concat(t)},e=>{m()}).subscribe();return()=>{p.removeChannel(e)}},[t]);let u=async()=>{let{data:e,error:l}=await p.from("menu_item_ratings").select("rating").eq("user_id",a.id).eq("meal_id",t);if(l||!e||0===e.length)return;let r=e.reduce((e,t)=>e+(t.rating||0),0)/e.length;await p.from("meal_ratings").upsert({meal_id:t,user_id:a.id,rating:r})};return o?(0,r.jsx)("div",{className:"my-4",children:(0,r.jsx)("div",{className:"text-lg font-medium",children:"오늘 나의 평가는?"})}):(0,r.jsx)("div",{className:"my-4",children:(0,r.jsxs)("div",{className:"text-lg font-medium",children:["오늘 나의 평가는?",a&&null!==n&&(0,r.jsxs)("span",{className:"ml-1",children:["(",n.toFixed(1),")"]})]})})};function y(e){let{schoolCode:t,mealId:a,className:l=""}=e,[n,o]=(0,s.useState)(null),[c,d]=(0,s.useState)(0),[m,u]=(0,s.useState)(""),[g,h]=(0,s.useState)(null),f=(0,i.UU)();return((0,s.useEffect)(()=>{if(async function(){if(t)try{let{data:e,error:l}=await f.from("meal_rating_stats").select("\n            avg_rating, \n            rating_count, \n            grade1_avg, \n            grade1_count,\n            grade2_avg, \n            grade2_count,\n            grade3_avg, \n            grade3_count,\n            grade4_avg, \n            grade4_count,\n            grade5_avg, \n            grade5_count,\n            grade6_avg, \n            grade6_count\n          ").eq("school_code",t).eq("meal_id",a).order("updated_at",{ascending:!1}).limit(1);if(l)return void console.error("별점 통계 데이터를 가져오는 중 오류 발생:",l);e&&e.length>0?(o(e[0].avg_rating?parseFloat(e[0].avg_rating.toFixed(1)):0),d(e[0].rating_count||0),h({grade1_avg:e[0].grade1_avg,grade1_count:e[0].grade1_count||0,grade2_avg:e[0].grade2_avg,grade2_count:e[0].grade2_count||0,grade3_avg:e[0].grade3_avg,grade3_count:e[0].grade3_count||0,grade4_avg:e[0].grade4_avg,grade4_count:e[0].grade4_count||0,grade5_avg:e[0].grade5_avg,grade5_count:e[0].grade5_count||0,grade6_avg:e[0].grade6_avg,grade6_count:e[0].grade6_count||0})):(o(0),d(0),h(null))}catch(e){console.error("별점 데이터 조회 중 오류:",e),o(0),d(0)}}(),!t||!a)return;console.log("실시간 구독 설정: meal_rating_stats:".concat(t,":").concat(a));let e=f.channel("meal_rating_stats:".concat(t,":").concat(a)).on("postgres_changes",{event:"*",schema:"public",table:"meal_rating_stats",filter:"school_code=eq.".concat(t)},e=>{console.log("실시간 업데이트 수신:",e),e.new&&(o(e.new.avg_rating?parseFloat(e.new.avg_rating.toFixed(1)):0),d(e.new.rating_count||0),h({grade1_avg:e.new.grade1_avg,grade1_count:e.new.grade1_count||0,grade2_avg:e.new.grade2_avg,grade2_count:e.new.grade2_count||0,grade3_avg:e.new.grade3_avg,grade3_count:e.new.grade3_count||0,grade4_avg:e.new.grade4_avg,grade4_count:e.new.grade4_count||0,grade5_avg:e.new.grade5_avg,grade5_count:e.new.grade5_count||0,grade6_avg:e.new.grade6_avg,grade6_count:e.new.grade6_count||0}))}).subscribe(e=>{console.log("구독 상태:",e)});return()=>{console.log("실시간 구독 해제"),f.removeChannel(e)}},[t,a,f]),n)?(0,r.jsxs)("div",{className:"flex flex-col py-1.5 px-1 ".concat(l," bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg"),children:[(0,r.jsx)("div",{className:"flex items-center justify-between",children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"bg-indigo-100 rounded-full p-1 mr-2",children:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-indigo-600",viewBox:"0 0 20 20",fill:"currentColor",children:(0,r.jsx)("path",{d:"M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"})})}),(0,r.jsx)("span",{className:"font-medium text-sm text-gray-700",children:"전교생 평균"}),(0,r.jsx)("span",{className:"ml-2 text-lg font-bold text-indigo-700",children:n}),(0,r.jsx)("div",{className:"flex items-center ml-1 space-x-0.5",children:(e=>{let a=[],l=Math.floor(e),s=e%1>=.5;for(let e=0;e<l;e++)a.push((0,r.jsx)("svg",{className:"w-4 h-4 text-yellow-500 fill-current",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{d:"M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"})},"full-".concat(e)));if(s){let e="half-gradient-".concat(t);a.push((0,r.jsxs)("svg",{className:"w-4 h-4 text-yellow-500",viewBox:"0 0 24 24",children:[(0,r.jsx)("defs",{children:(0,r.jsxs)("linearGradient",{id:e,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[(0,r.jsx)("stop",{offset:"50%",stopColor:"currentColor",stopOpacity:"1"}),(0,r.jsx)("stop",{offset:"50%",stopColor:"currentColor",stopOpacity:"0.3"})]})}),(0,r.jsx)("path",{fill:"url(#".concat(e,")"),d:"M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"})]},"half"))}let n=5-l-!!s;for(let e=0;e<n;e++)a.push((0,r.jsx)("svg",{className:"w-4 h-4 text-gray-300 fill-current",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{d:"M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"})},"empty-".concat(e)));return a})(n||0)}),(0,r.jsxs)("span",{className:"ml-1 text-xs text-gray-500",children:["(",c,"명)"]})]})}),g&&(0,r.jsx)("div",{className:"flex items-center justify-start mt-1 overflow-x-auto space-x-2 text-xs pb-1",children:[1,2,3,4,5,6].map(e=>{let t=g["grade".concat(e,"_avg")],a=g["grade".concat(e,"_count")];return t&&a>0?(0,r.jsxs)("div",{className:"flex items-center bg-white rounded-full px-1.5 py-0.5 border border-indigo-100",children:[(0,r.jsxs)("span",{className:"font-medium text-gray-600",children:["[",e,"학년]"]}),(0,r.jsx)("span",{className:"ml-1 font-bold text-indigo-600",children:t.toFixed(1)}),(0,r.jsxs)("span",{className:"ml-1 text-gray-400",children:["(",a,")"]})]},e):null})})]}):null}let v=(0,i.UU)();function w(e){let{item:t,interactive:a=!0}=e,[l,n]=(0,s.useState)(null);(0,s.useEffect)(()=>{(async()=>{let{data:e}=await v.auth.getUser();console.log("실제 사용자 정보:",null==e?void 0:e.user),n(null==e?void 0:e.user)})()},[]),(0,s.useEffect)(()=>{if(!t||!t.id)return;console.log("\uD83D\uDD0C menu_item_rating_stats 테이블 실시간 구독 설정 - 아이템 ID:",t.id);let e=v.channel("menu_item_rating_stats:".concat(t.id)).on("postgres_changes",{event:"*",schema:"public",table:"menu_item_rating_stats",filter:"menu_item_id=eq.".concat(t.id)},e=>{if(console.log("\uD83D\uDD04 아이템평점 실시간 업데이트 수신:",e),e.new){let t=e.new;d(t.avg_rating||0),u(t.rating_count||0),console.log("✅ 아이템평점 UI 업데이트 완료:",t.avg_rating,t.rating_count)}}).subscribe();return()=>{console.log("\uD83D\uDD0C menu_item_rating_stats 테이블 구독 해제 - 아이템 ID:",t.id),v.removeChannel(e)}},[null==t?void 0:t.id]);let[i,o]=(0,s.useState)(t.user_rating||null),[c,d]=(0,s.useState)(t.avg_rating||null),[m,u]=(0,s.useState)(t.rating_count||null),[g,h]=(0,s.useState)(!1);(0,s.useEffect)(()=>{console.log("MenuItemWithRating - 사용자 로그인 상태:",l?"로그인됨":"로그인 안됨"),l&&console.log("사용자 ID:",l.id)},[l]);let f=async(e,t)=>{try{if(!l||!l.id)return console.error("❌ 사용자 로그인 상태가 아닙니다"),alert("별점을 남기려면 로그인해주세요!"),!1;if(!e)return console.error("❌ 메뉴 아이템 ID가 없습니다"),!1;console.log("\uD83D\uDCBE 별점 저장 시도:",e,t);let{error:a}=await v.from("menu_item_ratings").upsert({user_id:l.id,menu_item_id:e,rating:t,updated_at:new Date().toISOString()},{onConflict:"user_id,menu_item_id"});if(a)return console.error("❌ 저장 오류:",a.message),!1;return console.log("✅ 별점 저장 성공!"),!0}catch(e){return console.error("❌ 별점 저장 중 오류:",e),!1}},p=async e=>{try{if(!l||!l.id)return console.error("❌ 사용자 로그인 상태가 아닙니다"),alert("별점을 남기려면 로그인해주세요!"),!1;if(!e)return console.error("❌ 메뉴 아이템 ID가 없습니다"),!1;console.log("\uD83D\uDDD1️ 별점 삭제 시도:",e);let{error:t}=await v.from("menu_item_ratings").delete().eq("user_id",l.id).eq("menu_item_id",e);if(t)return console.error("❌ 삭제 오류:",t.message),!1;console.log("\uD83D\uDD04 메뉴 아이템 별점 삭제 성공, 급식 평점 재계산 필요");let a=new CustomEvent("menu-item-rating-change",{detail:{menuItemId:e,deleted:!0}});return window.dispatchEvent(a),console.log("✅ 별점 삭제 성공!"),!0}catch(e){return console.error("❌ 별점 삭제 중 오류:",e),!1}},_=async e=>{try{if(console.log("➡️ 별점 정보 조회 시도 - 메뉴아이템 ID:",e),!e)return console.error("메뉴아이템 ID가 없습니다."),null;let{data:t,error:a}=await v.from("menu_item_ratings").select("rating").eq("menu_item_id",e);if(a)return console.error("평점 데이터 조회 오류:",a.message),null;let r=t||[],s=0;if(r.length>0){let e=r.reduce((e,t)=>e+t.rating,0)/r.length;s=Math.round(10*e)/10}let n=r.length;console.log("계산된 통계:",{avgRating:s,ratingCount:n});let i=null;if(l&&l.id){let{data:t,error:a}=await v.from("menu_item_ratings").select("rating").eq("menu_item_id",e).eq("user_id",l.id).limit(1);a?console.error("❌ 사용자 별점 조회 오류:",a.message):t&&t.length>0?(i=t[0].rating,console.log("✅ 사용자 별점 조회 성공:",i)):console.log("ℹ️ 사용자 별점 기록 없음")}else console.log("로그인되지 않아 사용자 별점을 조회하지 않습니다.");let o={avg_rating:s,rating_count:n,user_rating:i};return console.log("✅ 최종 별점 조회 결과:",o),o}catch(e){return console.error("별점 정보 조회 오류:",e),{avg_rating:0,rating_count:0,user_rating:null}}},y=async()=>{try{if(void 0!==t.user_rating){o(t.user_rating),d(t.avg_rating),u(t.rating_count);return}let e=await _(t.id);e?(o(e.user_rating),d(e.avg_rating),u(e.rating_count)):(o(null),d(0),u(0))}catch(e){console.error("별점 데이터 초기화 중 오류:",e)}};(0,s.useEffect)(()=>{t&&t.id&&y()},[t.id,l,t]);let w=async e=>{try{if(!l)return void alert("별점을 남기려면 로그인해주세요!");if(!t.id)return void console.error("메뉴 아이템 ID가 없습니다");if(console.log("⭐ 별점 선택:",e),h(!0),i===e){o(null),await p(t.id),console.log("클릭한 별점이 이미 저장된 별점과 같음, 별점 삭제 시도");let e=new CustomEvent("menu-item-rating-change",{detail:{menuItemId:t.id,deleted:!0,previousRating:i}});window.dispatchEvent(e),await p(t.id)?(console.log("별점 삭제 성공, UI 이미 업데이트됨"),setTimeout(async()=>{await _(t.id)},500)):(console.warn("별점 삭제 실패, 이전 상태 유지"),o(i),await _(t.id))}else{if(o(e),c&&m){let t=c*m,a=null===i?m+1:m,l=(null===i?t+e:t-i+e)/a;d(Math.round(10*l)/10),u(a)}else d(e),u(1);console.log("새로운 별점 저장 시도:",e);let a=new CustomEvent("menu-item-rating-change",{detail:{menuItemId:t.id,newRating:e,previousRating:i}});window.dispatchEvent(a),await f(t.id,e)?(console.log("별점 저장 성공, UI 이미 업데이트됨"),setTimeout(async()=>{await _(t.id)},500)):(console.warn("별점 저장 실패, 이전 상태로 복원"),o(i),await _(t.id))}}catch(e){console.error("별점 처리 중 오류:",e)}finally{h(!1)}};return(0,r.jsxs)("li",{className:"flex justify-between items-center py-2 border-b border-gray-100",children:[(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"rating-container mr-3",children:(0,r.jsx)(x,{value:i||0,onChange:w,interactive:a,showValue:!1,size:"medium"})}),(0,r.jsx)("div",{className:"text-gray-700",children:t.item_name})]}),c&&m?(0,r.jsxs)("div",{className:"text-sm text-gray-500",children:[c.toFixed(1)," (",m,"명)"]}):null]})}function b(e){let{meal:t,onShowOrigin:a,onShowNutrition:l,onUploadSuccess:n,onUploadError:i}=e,o=(0,s.useCallback)(()=>{console.log("\uD83D\uDCE3 이미지 변경 알림 받음"),n&&n()},[n]);return(0,r.jsx)("div",{className:"bg-white overflow-hidden",children:(0,r.jsxs)("div",{className:"p-2",children:[(0,r.jsx)(y,{schoolCode:t.school_code,mealId:t.id,className:"mb-2"}),(0,r.jsx)(u,{schoolCode:t.school_code,mealDate:t.meal_date,mealType:t.meal_type,onUploadSuccess:o,onUploadError:i},"uploader-".concat(t.id,"-").concat(t.meal_date)),(0,r.jsxs)("div",{className:"flex justify-between items-center my-2 text-xs",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[t.origin_info&&(0,r.jsx)("button",{onClick:()=>a(t.origin_info),className:"text-xs px-1 py-0.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors",children:"원산지"}),(t.kcal||t.ntr_info)&&(0,r.jsx)("button",{onClick:()=>l(t),className:"text-xs px-1 py-0.5 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors",children:"영양정보"})]}),t.kcal&&(0,r.jsxs)("div",{className:"bg-orange-100 text-orange-800 text-xs px-1.5 py-0.5 rounded",children:[t.kcal,"kcal"]})]}),(0,r.jsx)("div",{className:"mt-3",children:(0,r.jsx)(_,{mealId:t.id})}),(0,r.jsx)("div",{className:"mb-2",children:(0,r.jsx)("ul",{className:"space-y-2",children:t.menuItems&&t.menuItems.length>0?t.menuItems.map(e=>(0,r.jsx)(w,{item:e,interactive:!Array.isArray(t.menu_items)||1!==t.menu_items.length||"급식 정보가 없습니다"!==t.menu_items[0]},e.id)):t.menu_items.map((e,t)=>(0,r.jsx)("li",{className:"text-gray-700",children:e},t))})})]})})}console.log("MealCard 컴포넌트 로드됨, Supabase 클라이언트 초기화");var j=a(8670);async function N(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=void 0!==l?l:fetch;try{if((e.includes("/rest/v1/")||e.includes("izkumvvlkrkgiuuczffp.supabase.co/rest/v1/"))&&!e.includes("apikey="))if(["/meal_images","/profiles","/menu_item_ratings"].some(t=>e.includes(t)))console.debug("예외 처리 엔드포인트 요청 허용 (fetchWithAuth):",e);else{let a=!1;if(t.headers&&(a=t.headers instanceof Headers?t.headers.has("apikey")||t.headers.has("authorization"):Object.entries(t.headers).some(e=>{let[t,a]=e;return"string"==typeof t&&("apikey"===t.toLowerCase()||"authorization"===t.toLowerCase())})),!a)return console.warn("API 키 없는 요청 차단 (fetchWithAuth):",e,t.headers),new Response(JSON.stringify({error:"No API key found in request",message:"API 키가 필요한 요청입니다. 인증 정보를 확인하세요. (Generated by fetchWithAuth)"}),{status:401})}let l=await a(e,t);if((404===l.status||406===l.status)&&(e.includes("/meal_images")||e.includes("/comment_likes")))return console.debug("".concat(l.status," 오류 정상 처리 - ").concat(e.includes("/meal_images")?"이미지":"좋아요"," 요청:"),e),new Response(JSON.stringify({data:e.includes("select=id")?null:[]}),{status:200,headers:{"Content-Type":"application/json"}});if(406===l.status&&"undefined"!=typeof navigator&&navigator.userAgent&&(navigator.userAgent.includes("Whale")||navigator.userAgent.includes("NAVER")))return console.debug("웨일 브라우저 특수 406 오류 정상 처리:",e),new Response(JSON.stringify({data:[]}),{status:200,headers:{"Content-Type":"application/json"}});return l}catch(e){return console.error("API 요청 오류:",e),new Response(JSON.stringify({error:"API request failed",message:"네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요."}),{status:500})}}l=window.fetch,window.fetch=function(e,t){let a="";try{a="string"==typeof e?e:e instanceof URL?e.toString():e.url}catch(t){console.debug("URL 추출 오류, 문자열로 변환 시도:",t),a=String(e)}if(a.includes("izkumvvlkrkgiuuczffp.supabase.co/rest/v1/")){let r=["/meal_images","/profiles","/menu_item_ratings","/comment_likes"].some(e=>a.includes(e)),s="undefined"!=typeof navigator&&navigator.userAgent&&(navigator.userAgent.includes("Whale")||navigator.userAgent.includes("NAVER"));if(r)return console.debug("예외 처리 엔드포인트 요청 허용 ".concat(s?"(웨일 브라우저)":""," (api-helper.ts):"),a),s&&(t||(t={}),t.headers||(t.headers={}),t.headers instanceof Headers?t.headers.has("Accept")||t.headers.set("Accept","application/json"):t.headers={...t.headers,Accept:"application/json"}),l(e,t);let n=!1;try{(null==t?void 0:t.headers)&&(t.headers instanceof Headers?n=t.headers.has("apikey")||t.headers.has("authorization"):"object"==typeof t.headers&&(n=Object.keys(t.headers).some(e=>"string"==typeof e&&("apikey"===e.toLowerCase()||"authorization"===e.toLowerCase()))))}catch(e){console.debug("API 키 헤더 검증 중 오류 (무시됨):",e),n=!0}if(!n)return console.debug("권한 없는 Supabase REST API 요청 차단 (api-helper.ts):",a,null==t?void 0:t.headers),Promise.resolve(new Response(JSON.stringify({message:"No API key found in request",hint:"No 'apikey' request header or url param was found. (Generated by api-helper.ts)"}),{status:401}))}return l(e,t)};let S={MEALS:"/api/meals"};function k(e){let{onSubmit:t,placeholder:a="댓글 추가...",buttonText:l="댓글"}=e,[n,o]=(0,s.useState)(""),[c,d]=(0,s.useState)(!1),[m,u]=(0,s.useState)(!1),g=(0,s.useRef)(null),[h,f]=(0,s.useState)(null),[x,p]=(0,s.useState)("?"),_=(0,i.UU)();(0,s.useEffect)(()=>{(async()=>{try{let{data:{session:a}}=await _.auth.getSession();if(null==a?void 0:a.user){var e,t;f((null==(e=a.user.user_metadata)?void 0:e.avatar_url)||null),p(((null==(t=a.user.email)?void 0:t.charAt(0))||"?").toUpperCase())}}catch(e){console.error("사용자 정보 로드 실패:",e)}})()},[_]),(0,s.useEffect)(()=>{g.current&&(g.current.style.height="auto",g.current.style.height="".concat(g.current.scrollHeight,"px"))},[n]);let y=async e=>{if(e.preventDefault(),n.trim()&&!c)try{d(!0),await t(n)&&(o(""),u(!1),g.current&&(g.current.style.height="auto"))}finally{d(!1)}};return(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-8 h-8 overflow-hidden rounded-full",children:h?(0,r.jsx)("img",{src:h,alt:"프로필",className:"w-full h-full object-cover",onError:e=>{e.target.src="/default-avatar.png"}}):(0,r.jsx)("div",{className:"w-full h-full bg-gray-200 flex items-center justify-center text-gray-500",children:x})}),(0,r.jsxs)("form",{onSubmit:y,className:"flex-grow",children:[(0,r.jsx)("div",{className:"border-b ".concat(m?"border-black":"border-gray-300"," transition-all duration-200"),children:(0,r.jsx)("textarea",{ref:g,value:n,onChange:e=>o(e.target.value),onFocus:()=>u(!0),placeholder:a,className:"w-full p-2 focus:outline-none resize-none overflow-hidden min-h-[36px]",rows:1})}),m&&(0,r.jsxs)("div",{className:"mt-2 flex justify-end gap-2",children:[(0,r.jsx)("button",{type:"button",onClick:()=>{o(""),u(!1),g.current&&(g.current.blur(),g.current.style.height="auto")},className:"px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-full",children:"취소"}),(0,r.jsx)("button",{type:"submit",disabled:!n.trim()||c,className:"px-3 py-1.5 text-sm font-medium rounded-full ".concat(!n.trim()||c?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"),children:c?"게시 중...":l})]})]})]})}var C=a(8881),I=a(2404);function A(e){let{count:t,isLiked:a,onToggle:l,disabled:s=!1}=e;return(0,r.jsxs)("button",{onClick:e=>{e.preventDefault(),e.stopPropagation(),l()},disabled:s,className:"flex items-center ".concat(s?"opacity-50 cursor-not-allowed":""),"aria-label":a?"좋아요 취소":"좋아요",children:[(0,r.jsx)("span",{className:"mr-1 flex items-center justify-center w-5 h-5",children:a?(0,r.jsx)("svg",{viewBox:"0 0 24 24",className:"w-5 h-5 fill-blue-600",children:(0,r.jsx)("path",{d:"M7,22 L3,22 L3,10 L7,10 L7,22 Z M19.7507342,10.4137392 L14.2618608,10.4137392 L14.9110375,6.35765469 C15.1310205,4.93928291 14.06216,3.66896766 12.7595814,3.18316087 C12.5176311,3.09761964 12.2590594,3.04519397 12,3.04519397 C11.3357497,3.04519397 10.738532,3.43708398 10.4594998,4.02922829 L7.1282278,10 L10,10 L10,19.5 C10.8370479,19.5 11.5426519,19.5 12.0000108,19.5 C12.5624172,19.5 13.1374733,19.4344721 13.7251792,19.3033241 C14.5511793,19.1178695 21,17.9572276 21,17.9572276 L21,12.0643062 C21,12.0643062 20.7096832,10.7093823 19.7507342,10.4137392 Z"})}):(0,r.jsx)("svg",{viewBox:"0 0 24 24",className:"w-5 h-5 stroke-gray-500 fill-none",strokeWidth:"1.5",children:(0,r.jsx)("path",{d:"M7,22 L3,22 L3,10 L7,10 L7,22 Z M19.7507342,10.4137392 L14.2618608,10.4137392 L14.9110375,6.35765469 C15.1310205,4.93928291 14.06216,3.66896766 12.7595814,3.18316087 C12.5176311,3.09761964 12.2590594,3.04519397 12,3.04519397 C11.3357497,3.04519397 10.738532,3.43708398 10.4594998,4.02922829 L7.1282278,10 L10,10 L10,19.5 C10.8370479,19.5 11.5426519,19.5 12.0000108,19.5 C12.5624172,19.5 13.1374733,19.4344721 13.7251792,19.3033241 C14.5511793,19.1178695 21,17.9572276 21,17.9572276 L21,12.0643062 C21,12.0643062 20.7096832,10.7093823 19.7507342,10.4137392 Z"})})}),(0,r.jsx)("span",{className:"text-xs text-gray-700",children:t})]})}function E(e){var t,a,l;let{onSubmit:n,autoFocus:c=!0,placeholder:d="답글 추가...",buttonText:m="답글"}=e,[u,g]=(0,s.useState)(""),[h,f]=(0,s.useState)(!1),[x,p]=(0,s.useState)(!1),_=(0,s.useRef)(null),{user:y}=(0,o.A)();(0,i.UU)();let[v,w]=(0,s.useState)({});(0,s.useEffect)(()=>{if(y){var e,t;w({avatarUrl:null==(e=y.user_metadata)?void 0:e.avatar_url,name:null==(t=y.user_metadata)?void 0:t.name,email:y.email})}},[y]),(0,s.useEffect)(()=>{_.current&&(_.current.style.height="auto",_.current.style.height="".concat(_.current.scrollHeight,"px"))},[u]),(0,s.useEffect)(()=>{c&&_.current&&(_.current.focus(),p(!0))},[c]);let b=async e=>{if(e.preventDefault(),u.trim()&&!h)try{f(!0),await n(u)&&(g(""),p(!1),_.current&&(_.current.style.height="auto"))}finally{f(!1)}};return(0,r.jsxs)("div",{className:"flex items-start gap-2 mt-2",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-6 h-6 overflow-hidden rounded-full",children:v.avatarUrl?(0,r.jsx)("img",{src:v.avatarUrl,alt:"프로필",className:"w-full h-full object-cover",onError:e=>{e.target.src="/default-avatar.png"}}):(0,r.jsx)("div",{className:"w-full h-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs",children:(null==(t=v.name)?void 0:t[0])||(null==(l=v.email)||null==(a=l[0])?void 0:a.toUpperCase())||"?"})}),(0,r.jsxs)("form",{onSubmit:b,className:"flex-grow",children:[(0,r.jsx)("div",{className:"border-b ".concat(x?"border-black":"border-gray-300"," transition-all duration-200"),children:(0,r.jsx)("textarea",{ref:_,value:u,onChange:e=>g(e.target.value),onKeyDown:e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),b(e))},onFocus:()=>p(!0),placeholder:d,className:"w-full p-2 focus:outline-none resize-none overflow-hidden min-h-[36px] text-sm",rows:1})}),x&&(0,r.jsxs)("div",{className:"mt-2 flex justify-end gap-2",children:[(0,r.jsx)("button",{type:"button",onClick:()=>{g(""),p(!1),_.current&&(_.current.blur(),_.current.style.height="auto")},className:"px-3 py-1 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-full",children:"취소"}),(0,r.jsx)("button",{type:"submit",disabled:!u.trim()||h,className:"px-3 py-1 text-sm font-medium rounded-full ".concat(!u.trim()||h?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"),children:h?"게시 중...":m})]})]})]})}function L(e){var t,a,l,n,c,d;let{reply:m,onReplyChange:u,schoolCode:g}=e,[h,f]=(0,s.useState)(!1),[x,p]=(0,s.useState)(m.content),[_,y]=(0,s.useState)(m.user_has_liked),[v,w]=(0,s.useState)(m.likes_count),[b,j]=(0,s.useState)(!1),[N,S]=(0,s.useState)(!1),[k,L]=(0,s.useState)(!1);(0,s.useEffect)(()=>{if(!m.id)return;let e=U.channel("reply-likes-insert-".concat(m.id)).on("postgres_changes",{event:"INSERT",schema:"public",table:"reply_likes",filter:"reply_id=eq.".concat(m.id)},e=>{console.log("답글 좋아요 추가:",e),O()}).subscribe(),t=U.channel("reply-likes-delete-".concat(m.id)).on("postgres_changes",{event:"DELETE",schema:"public",table:"reply_likes"},e=>{console.log("답글 좋아요 삭제:",e);let t=e.old;t&&t.reply_id===m.id&&O()}).subscribe();return()=>{U.removeChannel(e),U.removeChannel(t)}},[m.id]),(0,s.useEffect)(()=>{let e=e=>{e.target.closest(".reply-menu")||S(!1)};return document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}},[]);let{user:q,userSchool:R}=(0,o.A)(),U=(0,i.UU)(),T=R&&g&&R.school_code===g,M=q&&q.id===m.user_id,z=(0,C.A)(new Date(m.created_at),{addSuffix:!0,locale:I.A}),P=async e=>{if(e.preventDefault(),x.trim()&&q&&M)try{let{error:e}=await U.from("comment_replies").update({content:x.trim(),updated_at:new Date().toISOString()}).eq("id",m.id);if(e)throw e;f(!1),u()}catch(e){console.error("답글 수정 중 오류:",e)}},D=async()=>{if(q&&M&&window.confirm("정말로 이 답글을 삭제하시겠습니까?"))try{let{error:e}=await U.from("comment_replies").delete().eq("id",m.id);if(e)throw e;u()}catch(e){console.error("답글 삭제 중 오류:",e)}},O=async()=>{try{let{count:e,error:t}=await U.from("reply_likes").select("*",{count:"exact",head:!0}).eq("reply_id",m.id);if(t)throw t;if(q&&q.id){let{data:e,error:t}=await U.from("reply_likes").select("id").eq("reply_id",m.id).eq("user_id",q.id).maybeSingle();!t&&e?y(!0):y(!1)}w(e||0)}catch(e){console.error("답글 좋아요 개수 가져오기 오류:",e)}},W=async()=>{if(q&&q.id&&!b){j(!0);try{let e=!_;if(y(e),w(t=>e?t+1:t-1),_){let{error:t}=await U.from("reply_likes").delete().eq("reply_id",m.id).eq("user_id",q.id);if(t)throw y(!e),w(t=>e?t-1:t+1),t}else{let{error:t}=await U.from("reply_likes").insert({reply_id:m.id,user_id:q.id});if(t)throw y(!e),w(t=>e?t-1:t+1),t}}catch(e){console.error("좋아요 처리 중 오류:",e)}finally{j(!1)}}},F=async e=>{if(!q||!e.trim())return!1;try{let{data:t,error:a}=await U.from("comment_replies").insert({comment_id:m.comment_id,user_id:q.id,content:e.trim(),parent_id:m.id});if(a)throw a;return u(),L(!1),!0}catch(e){return console.error("답글 작성 중 오류:",e),!1}};return(0,r.jsx)("div",{className:"py-2 pl-8 border-l border-gray-200",children:h?(0,r.jsxs)("form",{onSubmit:P,className:"mt-2",children:[(0,r.jsx)("input",{type:"text",value:x,onChange:e=>p(e.target.value),className:"w-full p-2 border border-gray-300 rounded",autoFocus:!0}),(0,r.jsxs)("div",{className:"mt-2 flex space-x-2",children:[(0,r.jsx)("button",{type:"submit",className:"px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600",children:"저장"}),(0,r.jsx)("button",{type:"button",onClick:()=>{f(!1),p(m.content)},className:"px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300",children:"취소"})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex items-start",children:[(0,r.jsx)("div",{className:"mr-2",children:(null==(t=m.user.user_metadata)?void 0:t.avatar_url)?(0,r.jsx)("img",{src:m.user.user_metadata.avatar_url,alt:"프로필",className:"w-5 h-5 rounded-full"}):(0,r.jsx)("div",{className:"w-5 h-5 bg-gray-200 rounded-full flex items-center justify-center",children:(0,r.jsx)("span",{className:"text-xs text-gray-500",children:(null==(l=m.user.user_metadata)||null==(a=l.name)?void 0:a[0])||(null==(n=m.user.email[0])?void 0:n.toUpperCase())||"?"})})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-xs text-gray-700",children:(null==(c=m.user.user_metadata)?void 0:c.name)||(null==(d=m.user.email)?void 0:d.split("@")[0])||"사용자"}),(0,r.jsx)("span",{className:"ml-2 text-xs text-gray-400",children:z})]}),M&&!h&&(0,r.jsxs)("div",{className:"relative reply-menu",children:[(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),S(!N)},className:"text-gray-500 hover:text-gray-700 p-1",children:(0,r.jsx)("span",{className:"text-xl leading-none",children:"⋮"})}),N&&(0,r.jsxs)("div",{className:"absolute right-0 top-6 bg-white shadow-md rounded-md py-1 z-10 w-20",children:[(0,r.jsx)("button",{onClick:()=>{f(!0),S(!1)},className:"w-full text-left px-3 py-1 text-xs hover:bg-gray-100 text-gray-700",children:"수정"}),(0,r.jsx)("button",{onClick:()=>{D(),S(!1)},className:"w-full text-left px-3 py-1 text-xs hover:bg-gray-100 text-red-500",children:"삭제"})]})]})]}),(0,r.jsx)("p",{className:"mt-1 text-sm font-medium break-words whitespace-pre-wrap",children:m.content}),(0,r.jsxs)("div",{className:"mt-1 flex items-center gap-3",children:[(0,r.jsx)(A,{count:v,isLiked:_,onToggle:q&&T?W:()=>{alert("해당 학교 학생만 좋아요를 할 수 있습니다.")},disabled:b}),q&&T&&(0,r.jsxs)("button",{onClick:()=>L(!k),className:"text-gray-500 hover:text-gray-700 flex items-center gap-1",title:"답글 작성",children:[(0,r.jsx)("svg",{viewBox:"0 0 24 24",className:"w-4 h-4 fill-current",children:(0,r.jsx)("path",{d:"M3,17.25 L3,21 L6.75,21 L17.81,9.94 L14.06,6.19 L3,17.25 Z M21.41,6.34 L17.66,2.59 C17.2706655,2.20798298 16.6593396,2.20857968 16.27,2.59 L13.13,5.73 L16.88,9.48 L20.02,6.34 C20.4,5.96 20.4,5.34 20.02,4.96 L21.41,6.34 Z"})}),(0,r.jsx)("span",{className:"text-xs",children:k?"취소":"답글"})]})]})]})]}),k&&q&&T&&(0,r.jsx)("div",{className:"mt-2",children:(0,r.jsx)(E,{onSubmit:F,placeholder:"답글 추가...",buttonText:"답글"})})]})})}function q(e){var t,a,l,n,c,d,m;let{comment:u,onCommentChange:g,schoolCode:h}=e,[f,x]=(0,s.useState)(!1),[p,_]=(0,s.useState)(u.content),[y,v]=(0,s.useState)(!1),[w,b]=(0,s.useState)(!1),[j,N]=(0,s.useState)(u.user_has_liked),[S,k]=(0,s.useState)(u.likes_count),[q,R]=(0,s.useState)(!1),[U,T]=(0,s.useState)([]),[M,z]=(0,s.useState)(u.replies_count),[P,D]=(0,s.useState)(!1),{user:O,userSchool:W}=(0,o.A)(),F=(0,i.UU)(),B=W&&h&&W.school_code===h,V=O&&O.id===u.user_id,J=(0,C.A)(new Date(u.created_at),{addSuffix:!0,locale:I.A}),Z=async()=>{try{let{count:e,error:t}=await F.from("comment_likes").select("*",{count:"exact",head:!0}).eq("comment_id",u.id);if(t)throw t;k(e||0)}catch(e){console.error("댓글 좋아요 개수 가져오기 오류:",e)}},G=async()=>{if(O&&O.id)try{let{data:e,error:t}=await F.from("comment_likes").select("id").eq("comment_id",u.id).eq("user_id",O.id).maybeSingle();N(!t&&!!e)}catch(e){console.debug("좋아요 여부 확인 중 오류 무시:",e),N(!1)}},H=async()=>{if(O&&O.id&&!q){R(!0);try{let e=!j;if(N(e),k(t=>e?t+1:Math.max(0,t-1)),e){let{error:e}=await F.from("comment_likes").insert({comment_id:u.id,user_id:O.id});e&&(console.error("좋아요 추가 오류:",e),N(!1),k(e=>Math.max(0,e-1)))}else{let{error:e}=await F.from("comment_likes").delete().eq("comment_id",u.id).eq("user_id",O.id);e&&(console.error("좋아요 취소 오류:",e),N(!0),k(e=>e+1))}Z()}catch(e){console.error("좋아요 처리 중 오류:",e)}finally{R(!1)}}};(0,s.useEffect)(()=>{if(!u.id)return;let e=F.channel("comment-likes-all-".concat(u.id)).on("postgres_changes",{event:"*",schema:"public",table:"comment_likes"},e=>{if(console.log("댓글 좋아요 변경:",e),"DELETE"===e.eventType){let t=e.old;if(t&&t.comment_id===u.id&&O&&t.user_id===O.id)return}else if("INSERT"===e.eventType){let t=e.new;if(t&&t.comment_id===u.id){if(O&&t.user_id===O.id)return;Z(),O&&G()}}}).subscribe();return()=>{F.removeChannel(e)}},[u.id,O]);let K=async()=>{if(V&&p.trim())try{let{error:e}=await F.from("comments").update({content:p.trim(),updated_at:new Date().toISOString()}).eq("id",u.id);if(e)throw e;x(!1),g()}catch(e){console.error("댓글 수정 중 오류:",e)}},$=async()=>{if(O&&V&&window.confirm("정말로 이 댓글을 삭제하시겠습니까?"))try{let{error:e}=await F.from("comments").delete().eq("id",u.id);if(e)throw e;g()}catch(e){console.error("댓글 삭제 중 오류:",e)}},Q=async()=>{if(u.id&&!P)try{D(!0);let{data:e,error:t}=await F.from("comment_replies").select("id, content, created_at, user_id, comment_id").eq("comment_id",u.id).eq("is_deleted",!1).order("created_at",{ascending:!0});if(t)throw t;let a=[];if(e&&e.length>0){let t=e.map(e=>e.user_id),{data:l,error:r}=await F.from("users").select("id, email, nickname, profile_image").in("id",t);r?console.error("사용자 정보 가져오기 오류:",r):a=l||[]}let l=e.map(e=>e.id),r={};if(l.length>0){let{data:e,error:t}=await F.from("reply_likes").select("reply_id").in("reply_id",l);if(t)throw t;r=e.reduce((e,t)=>(e[t.reply_id]=(e[t.reply_id]||0)+1,e),{})}let s={};if(O&&O.id&&l.length>0){let{data:e,error:t}=await F.from("reply_likes").select("reply_id").in("reply_id",l).eq("user_id",O.id);if(t)throw t;s=(e||[]).reduce((e,t)=>(e[t.reply_id]=!0,e),{})}let n=e.map(e=>{let t=a.find(t=>t.id===e.user_id)||null;return{id:e.id,content:e.content,created_at:e.created_at,user_id:e.user_id,comment_id:e.comment_id,user:{id:(null==t?void 0:t.id)||e.user_id||"",email:(null==t?void 0:t.email)||"",user_metadata:{name:(null==t?void 0:t.nickname)||"",avatar_url:(null==t?void 0:t.profile_image)||""}},likes_count:r[e.id]||0,user_has_liked:!!s[e.id]}});T(n),z(n.length)}catch(e){console.error("답글 불러오기 오류:",e)}finally{D(!1)}},X=async e=>{if(!O||!O.id||!u.id||!e.trim())return!1;try{let{error:t}=await F.from("comment_replies").insert({comment_id:u.id,user_id:O.id,content:e.trim()});if(t)throw t;return await Q(),z(e=>e+1),g(),!0}catch(e){return console.error("답글 추가 중 오류:",e),!1}},Y=()=>{Q()},ee=async()=>{if(u.id)try{let{data:e,error:t}=await F.from("comment_replies").select("id").eq("comment_id",u.id).eq("is_deleted",!1);!t&&e&&z(e.length)}catch(e){console.error("답글 개수 가져오기 오류:",e)}};(0,s.useEffect)(()=>{z(u.replies_count),N(u.user_has_liked),k(u.likes_count),O&&O.id&&(G(),Z())},[u.replies_count,u.user_has_liked,u.likes_count,O]),(0,s.useEffect)(()=>{if(!u.id)return;let e=F.channel("replies-insert-".concat(u.id)).on("postgres_changes",{event:"INSERT",schema:"public",table:"comment_replies",filter:"comment_id=eq.".concat(u.id)},e=>{console.log("답글 추가:",e),ee(),y&&Q()}).subscribe(),t=F.channel("replies-delete-".concat(u.id)).on("postgres_changes",{event:"DELETE",schema:"public",table:"comment_replies"},e=>{console.log("답글 삭제:",e);let t=e.old;t&&(t.comment_id,u.id)}).subscribe(),a=F.channel("replies-update-".concat(u.id)).on("postgres_changes",{event:"UPDATE",schema:"public",table:"comment_replies",filter:"comment_id=eq.".concat(u.id)},e=>{console.log("답글 업데이트:",e),ee(),y&&Q()}).subscribe(),l=F.channel("reply-likes-for-comment-".concat(u.id)).on("postgres_changes",{event:"*",schema:"public",table:"reply_likes"},e=>{let t=e.new,a=e.old,l=(null==t?void 0:t.reply_id)||(null==a?void 0:a.reply_id);y&&l&&U.some(e=>e.id===l)&&(console.log("답글 좋아요 변경:",e),Q())}).subscribe();return()=>{F.removeChannel(e),F.removeChannel(t),F.removeChannel(a),F.removeChannel(l)}},[u.id,y,U,O]);let[et,ea]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{let e=e=>{e.target.closest(".comment-menu")||ea(!1)};return document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}},[]),(0,r.jsx)("div",{className:"bg-white p-4 rounded-lg shadow-sm border border-gray-100",children:(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"flex-shrink-0",children:(null==(a=u.user)||null==(t=a.user_metadata)?void 0:t.avatar_url)?(0,r.jsx)("img",{src:u.user.user_metadata.avatar_url,alt:"프로필",className:"h-6 w-6 rounded-full"}):(0,r.jsx)("div",{className:"h-6 w-6 rounded-full bg-gray-200 flex items-center justify-center",children:(0,r.jsx)("span",{className:"text-gray-500 text-xs",children:(null==(c=u.user)||null==(n=c.user_metadata)||null==(l=n.name)?void 0:l.charAt(0))||"?"})})}),(0,r.jsxs)("div",{className:"ml-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-700",children:(null==(m=u.user)||null==(d=m.user_metadata)?void 0:d.name)||"익명"}),(0,r.jsx)("span",{className:"ml-2 text-xs text-gray-400",children:J})]})]}),V&&!f&&(0,r.jsxs)("div",{className:"relative comment-menu",children:[(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),ea(!et)},className:"text-gray-500 hover:text-gray-700 p-1",children:(0,r.jsx)("span",{className:"text-xl leading-none",children:"⋮"})}),et&&(0,r.jsxs)("div",{className:"absolute right-0 top-6 bg-white shadow-md rounded-md py-1 z-10 w-20",children:[(0,r.jsx)("button",{onClick:()=>{x(!0),ea(!1)},className:"w-full text-left px-3 py-1 text-xs hover:bg-gray-100 text-gray-700",children:"수정"}),(0,r.jsx)("button",{onClick:()=>{$(),ea(!1)},className:"w-full text-left px-3 py-1 text-xs hover:bg-gray-100 text-red-500",children:"삭제"})]})]})]}),f?(0,r.jsxs)("div",{className:"mt-2",children:[(0,r.jsx)("textarea",{value:p,onChange:e=>_(e.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",rows:3}),(0,r.jsxs)("div",{className:"mt-2 flex justify-end space-x-2",children:[(0,r.jsx)("button",{onClick:()=>x(!1),className:"px-3 py-1 text-xs text-gray-600 hover:text-gray-900",children:"취소"}),(0,r.jsx)("button",{onClick:K,className:"px-3 py-1 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600",children:"저장"})]})]}):(0,r.jsx)("p",{className:"mt-2 text-sm font-medium text-gray-800 whitespace-pre-wrap break-words",children:u.content}),(0,r.jsx)("div",{className:"mt-2 flex items-center",children:(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsx)(A,{count:S,isLiked:j,onToggle:O&&B?H:()=>{alert("해당 학교 학생만 좋아요를 할 수 있습니다.")},disabled:q}),M>0?(0,r.jsx)("button",{onClick:()=>{y||0!==U.length||Q(),v(!y)},className:"text-sm text-gray-600 hover:text-gray-900 flex items-center",children:(0,r.jsxs)("span",{children:["답글 ",M,"개>"]})}):(0,r.jsx)("button",{onClick:()=>{y||0!==U.length||Q(),v(!y)},className:"text-sm text-gray-600 hover:text-gray-900 flex items-center opacity-0 hover:opacity-50",children:(0,r.jsx)("span",{children:"답글 >"})}),O&&B&&(0,r.jsxs)("button",{className:"text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1",onClick:()=>{b(!w),y||(v(!0),0===U.length&&Q())},title:"답글 작성",children:[(0,r.jsx)("svg",{viewBox:"0 0 24 24",className:"w-4 h-4 fill-current",children:(0,r.jsx)("path",{d:"M3,17.25 L3,21 L6.75,21 L17.81,9.94 L14.06,6.19 L3,17.25 Z M21.41,6.34 L17.66,2.59 C17.2706655,2.20798298 16.6593396,2.20857968 16.27,2.59 L13.13,5.73 L16.88,9.48 L20.02,6.34 C20.4,5.96 20.4,5.34 20.02,4.96 L21.41,6.34 Z"})}),(0,r.jsxs)("span",{className:"text-xs",children:["답글 ",w?"접기":"작성"]})]})]})}),y&&(0,r.jsxs)("div",{className:"mt-1 ml-5 pl-3 relative",children:[(0,r.jsx)("div",{className:"absolute left-0 top-0 h-full",style:{width:"16px"},children:(0,r.jsx)("svg",{width:"16",height:"100%",className:"overflow-visible",children:(0,r.jsx)("path",{d:"M1,0 L1,100% Q1,100% 9,100%",stroke:"#e5e7eb",strokeWidth:"1.5",fill:"none"})})}),w&&O&&B&&(0,r.jsx)(E,{onSubmit:X}),P?(0,r.jsx)("p",{className:"text-sm text-gray-500 py-2",children:"답글을 불러오는 중..."}):U.length>0?(0,r.jsx)("div",{className:"space-y-2 my-2",children:U.map(e=>(0,r.jsx)(L,{reply:e,onReplyChange:Y,schoolCode:h},e.id))}):null]})]})})}function R(e){let{mealId:t,className:a="",schoolCode:l}=e,[n,c]=(0,s.useState)([]),[d,m]=(0,s.useState)(!0),[u,g]=(0,s.useState)(null),[h,f]=(0,s.useState)(0),[x,p]=(0,s.useState)(!0),{user:_,userSchool:y}=(0,o.A)(),v=y&&l&&y.school_code===l,w=(0,i.UU)(),b=async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(t)try{m(!0);let a=e?0:h,{data:l,error:r}=await w.from("comments").select("id, content, created_at, user_id").eq("meal_id",t).eq("is_deleted",!1).order("created_at",{ascending:!1}).range(10*a,(a+1)*10-1),s=[];if(l&&l.length>0){let e=l.map(e=>e.user_id),{data:t,error:a}=await w.from("users").select("id, email, nickname, profile_image").in("id",e);a?console.error("사용자 정보 가져오기 오류:",a):s=t||[]}if(r)throw r;let n=l.map(e=>e.id),i={};if(n.length>0){let{data:e,error:t}=await w.from("comment_likes").select("comment_id").in("comment_id",n);if(t)throw t;i=e.reduce((e,t)=>(e[t.comment_id]=(e[t.comment_id]||0)+1,e),{})}let o={};if(_&&_.id&&n.length>0){let{data:e,error:t}=await w.from("comment_likes").select("comment_id").in("comment_id",n).eq("user_id",_.id);if(t)throw t;o=(e||[]).reduce((e,t)=>(e[t.comment_id]=!0,e),{})}let d={};if(n.length>0){let{data:e,error:t}=await w.from("comment_replies").select("comment_id").in("comment_id",n).eq("is_deleted",!1);if(t)throw t;d=e.reduce((e,t)=>(e[t.comment_id]=(e[t.comment_id]||0)+1,e),{})}let u=l.map(e=>{let t=s.find(t=>t.id===e.user_id)||null;return{id:e.id,content:e.content,created_at:e.created_at,user_id:e.user_id,user:{id:(null==t?void 0:t.id)||e.user_id||"",email:(null==t?void 0:t.email)||"",user_metadata:{name:(null==t?void 0:t.nickname)||"",avatar_url:(null==t?void 0:t.profile_image)||""}},likes_count:i[e.id]||0,user_has_liked:!!o[e.id],replies_count:d[e.id]||0}});e?c(u):c(e=>[...e,...u]),p(10===u.length),f(e?1:a+1)}catch(e){console.error("댓글 로드 중 오류:",e),g("댓글을 불러오는 중 문제가 발생했습니다.")}finally{m(!1)}};(0,s.useEffect)(()=>{t&&b(!0)},[t]),(0,s.useEffect)(()=>{if(!t)return;let e=w.channel("comments-insert-".concat(t)).on("postgres_changes",{event:"INSERT",schema:"public",table:"comments",filter:"meal_id=eq.".concat(t)},e=>{console.log("댓글 추가:",e),b(!0)}).subscribe(),a=w.channel("comments-delete-".concat(t)).on("postgres_changes",{event:"DELETE",schema:"public",table:"comments"},e=>{console.log("댓글 삭제:",e);let a=e.old;a&&a.meal_id===t&&b(!0)}).subscribe(),l=w.channel("comments-update-".concat(t)).on("postgres_changes",{event:"UPDATE",schema:"public",table:"comments",filter:"meal_id=eq.".concat(t)},e=>{console.log("댓글 수정:",e),b(!0)}).subscribe(),r=w.channel("comment-likes-insert-".concat(t)).on("postgres_changes",{event:"INSERT",schema:"public",table:"comment_likes"},e=>{console.log("댓글 좋아요 추가:",e),b(!0)}).subscribe(),s=w.channel("comment-likes-delete-".concat(t)).on("postgres_changes",{event:"DELETE",schema:"public",table:"comment_likes"},e=>{console.log("댓글 좋아요 삭제:",e);let t=e.old;t&&t.comment_id&&n.map(e=>e.id).includes(t.comment_id)&&b(!0)}).subscribe();return()=>{w.removeChannel(e),w.removeChannel(a),w.removeChannel(l),w.removeChannel(r),w.removeChannel(s)}},[t]);let j=async e=>{if(!_||!_.id||!t||!e.trim())return!1;try{console.log("댓글 추가 시도:",{mealId:t,userId:_.id,content:e.trim()});let{error:a}=await w.from("comments").insert({meal_id:t,user_id:_.id,content:e.trim()});if(a)throw console.error("댓글 추가 SQL 오류:",a),a;return console.log("댓글 추가 성공, 새로고침 시도"),await b(!0),!0}catch(e){return console.error("댓글 추가 중 오류:",e),g("댓글을 추가하는 중 문제가 발생했습니다."),!1}};return(0,r.jsxs)("div",{className:"mt-4 ".concat(a),children:[(0,r.jsx)("h3",{className:"text-lg font-bold mb-4",children:"댓글"}),d?(0,r.jsx)("p",{className:"text-gray-500 mb-4",children:"로딩 중..."}):_&&v?(0,r.jsx)(k,{onSubmit:j}):_&&!v?(0,r.jsx)("p",{className:"text-gray-500 mb-4",children:"해당 학교 학생만 댓글을 작성할 수 있습니다."}):(0,r.jsx)("p",{className:"text-gray-500 mb-4",children:"댓글을 작성하려면 로그인하세요."}),(0,r.jsx)("div",{className:"mt-4 space-y-4",children:n.length>0?n.map(e=>(0,r.jsx)(q,{comment:e,onCommentChange:()=>b(!0),schoolCode:l},e.id)):d?(0,r.jsx)("p",{className:"text-gray-500",children:"댓글을 불러오는 중..."}):(0,r.jsx)("p",{className:"text-gray-500",children:"아직 댓글이 없습니다. 첫 댓글을 남겨보세요!"})}),x&&(0,r.jsx)("button",{className:"w-full py-2 mt-4 text-sm text-gray-600 hover:text-gray-900",onClick:()=>b(),disabled:d,children:d?"불러오는 중...":"더 보기"}),u&&(0,r.jsx)("p",{className:"text-red-500 mt-2",children:u})]})}var U=a(1653);function T(){(0,n.useRouter)();let e=(0,i.UU)(),{user:t,userSchool:a,loading:l,error:c}=(0,o.A)(),[d,m]=(0,s.useState)(null),[u,g]=(0,s.useState)(""),h=e=>{g(e);try{let t=new URLSearchParams(window.location.search);t.set("date",e);let a="".concat(window.location.pathname,"?").concat(t.toString());window.history.replaceState({},"",a)}catch(e){console.error("주소 갱신 오류:",e)}},[f,x]=(0,s.useState)(0),[p,_]=(0,s.useState)(!1),[y,v]=(0,s.useState)(""),{meals:w,isLoading:k,error:C,dataSource:I,fetchMealInfo:A}=function(){let[e,t]=(0,s.useState)([]),[a,l]=(0,s.useState)(!1),[r,n]=(0,s.useState)(""),[i,o]=(0,s.useState)(""),c=(0,s.useCallback)(async function(e,a){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"E10";if(!e||!a)return void n("학교 코드와 날짜가 필요합니다.");try{l(!0),n("");let s=(0,j.EK)(a),i=await N("".concat(S.MEALS,"?school_code=").concat(e,"&office_code=").concat(r,"&date=").concat(s));if(404===i.status){t([]),o("database"),n("해당 날짜의 급식 정보가 없습니다.");return}if(!i.ok)throw Error("API 호출 실패: ".concat(i.statusText));let c=await i.json();o(c.source||"unknown"),c.meals&&c.meals.length>0?t(c.meals):(t([]),n("해당 날짜의 급식 정보가 없습니다."))}catch(e){console.error("급식 정보 조회 오류:",e),t([]),n("급식 정보를 가져오는 중 오류가 발생했습니다: ".concat(e.message))}finally{l(!1)}},[]);return{meals:e,isLoading:a,error:r,dataSource:i,fetchMealInfo:c}}();(0,s.useEffect)(()=>{c&&v(c)},[c]),(0,s.useEffect)(()=>{{let e=new URLSearchParams(window.location.search).get("date"),t=e||(0,j.AV)();console.log("URL에서 날짜 초기화:",{dateFromUrl:e,dateToUse:t}),m(e),g(t)}},[]),(0,s.useEffect)(()=>{let t=new URLSearchParams(window.location.search).get("notification");t?(async()=>{console.log("CASCADE_TEST_LOG: fetchNotificationMeal called with notificationId:",t,"at",new Date().toISOString());try{let{data:a,error:l}=await e.from("notifications").select("related_type, related_id").eq("id",t).maybeSingle();if(l&&"PGRST116"!==l.code){console.error("알림 조회 오류:",l),_(!1),h((0,j.AV)());return}if(!a||!a.related_id){console.log("Notification found, but no valid related_id for id:",t,"Notification object:",a),h((0,j.AV)());return}console.log("Proceeding to fetch meal with related_id:",a.related_id);let{data:r,error:s}=await e.from("meals").select("meal_date").eq("id",a.related_id).maybeSingle();if(!(null==r?void 0:r.meal_date)){console.log("Meal not found for related_id:",a.related_id),s&&"PGRST116"!==s.code&&console.error("Error fetching meal (when meal data is missing):",s),h((0,j.AV)());return}s&&s.code;let n=r.meal_date.replace(/^(\d{4})(\d{2})(\d{2})$/,"$1-$2-$3");h(n)}catch(e){console.error("알림 관련 급식 정보 조회 중 예기치 않은 실패:",e),h((0,j.AV)())}})():d&&!l?/^\d{4}-\d{2}-\d{2}$/.test(d)?h(d):h((0,j.AV)()):u||l||!a||h((0,j.AV)())},[d,l,a,e]),(0,s.useEffect)(()=>{(null==a?void 0:a.school_code)&&u&&!p&&!k&&!l&&(console.log("급식 정보 자동 로드 - 학교: ".concat(a.school_code,", 날짜: ").concat(u)),console.log("자동 로드 시 날짜 형식: ".concat(u,", 타입: ").concat(typeof u)),A(a.school_code,u,L()))},[null==a?void 0:a.school_code,u,p,l]);let E=e=>{for(let[t,a]of Object.entries({서울:"B10",부산:"C10",대구:"D10",인천:"E10",광주:"F10",대전:"G10",울산:"H10",세종:"I10",경기:"J10",강원:"K10",충북:"M10",충남:"N10",전북:"P10",전남:"Q10",경북:"R10",경남:"S10",제주:"T10"}))if(e&&e.includes(t))return a;return"B10"},L=()=>{let e="E10";return a&&(a.office_code?e=a.office_code:a.region&&(e=E(a.region))),e},{isOpen:q,title:T,content:M,openModal:z,closeModal:P}=function(){let[e,t]=(0,s.useState)(!1),[a,l]=(0,s.useState)(""),[r,n]=(0,s.useState)("");return{isOpen:e,title:a,content:r,openModal:(0,s.useCallback)((e,a)=>{l(e),n(a),t(!0)},[]),closeModal:(0,s.useCallback)(()=>{t(!1)},[])}}(),D=e=>{if(!e||!e.ntr_info)return"영양 정보가 없습니다.";try{let t=e.ntr_info.replace(/<br\s*\/?>/gi,"\n").split(/\n/).map(e=>e.trim()).filter(Boolean);if(0===t.length)return"영양 정보가 없습니다.";let a=[];for(let e=0;e<t.length;e++)a.push(t[e]),t[e].includes("지방")&&e<t.length-1&&a.push("");return a.join("\n").trim()}catch(e){return console.error("영양소 정보 파싱 오류:",e),"영양 정보 표시 중 오류가 발생했습니다."}},O=e=>!e||Array.isArray(e)&&0===e.length||"[]"===e?"상세 원산지 정보가 없습니다.":("string"==typeof e?e:JSON.stringify(e)).replace(/<br\s*\/?>/gi,"\n");return(0,r.jsxs)("div",{className:"min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8",children:[q&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg max-w-md w-full p-6 max-h-[80vh] overflow-y-auto",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsx)("h3",{className:"text-lg font-medium text-center",children:T}),(0,r.jsx)("button",{onClick:P,className:"text-gray-500 hover:text-gray-800",children:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,r.jsx)("div",{className:"whitespace-pre-wrap break-words text-left",children:M})]})}),(0,r.jsxs)("div",{className:"max-w-4xl mx-auto",children:[a?(0,r.jsxs)("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 shadow-sm rounded p-2 mb-3 border-l-2 border-blue-500 flex items-center",children:[(0,r.jsx)("span",{className:"text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 text-base font-semibold",children:a.school_name}),(a.grade||a.class)&&(0,r.jsxs)("span",{className:"ml-2 text-gray-600 text-xs bg-white px-1.5 py-0.5 rounded-full",children:[a.grade?"".concat(a.grade,"학년"):"",a.class?" ".concat(a.class,"반"):""]})]}):(0,r.jsx)("div",{className:"mb-6"}),(0,r.jsx)(U.A,{selectedDate:u,onDateChange:e=>{g(e),h(e),(null==a?void 0:a.school_code)&&!l&&A(a.school_code,e,L())}}),(C||y||c)&&!w.length&&(0,r.jsx)("div",{className:"mt-4 p-3 bg-red-50 text-red-700 rounded-md",children:C||y||c}),!k&&!p&&!l&&(0,r.jsx)(r.Fragment,{children:w.length>0?(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[w.map(e=>(0,r.jsxs)("div",{className:"meal-wrapper",children:[(0,r.jsx)(b,{meal:e,onShowOrigin:e=>{z("원산지 정보",O(e))},onShowNutrition:e=>{z("영양 정보",D(e))},onUploadSuccess:()=>x(e=>e+1),onUploadError:e=>{v(e),setTimeout(()=>v(""),3e3)}}),(0,r.jsx)(R,{mealId:e.id,className:"mt-4",schoolCode:e.school_code})]},e.id)),I&&(0,r.jsx)("div",{className:"col-span-1 md:col-span-2 mt-2 text-right",children:(0,r.jsxs)("p",{className:"text-xs text-gray-500",children:["데이터 소스: ",(0,r.jsx)("span",{className:"font-medium",children:I})]})})]}):(0,r.jsxs)("div",{className:"bg-white shadow-md rounded-lg p-6",children:[(0,r.jsx)("div",{className:"flex items-center justify-center mb-4",children:(0,r.jsx)("div",{className:"bg-yellow-100 rounded-full p-3",children:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-8 w-8 text-yellow-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})})}),(0,r.jsxs)("h3",{className:"text-lg font-medium text-center mb-2",children:[(null==a?void 0:a.school_name)||"학교"," ",(0,j.g1)(u)," 급식 정보"]}),(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-md text-center",children:[(0,r.jsx)("p",{className:"text-gray-700 font-medium",children:C||y||c||"해당 날짜의 급식 정보가 없습니다."}),(0,r.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:"다른 날짜를 선택해보세요."}),I&&(0,r.jsxs)("p",{className:"text-xs text-gray-500 mt-4",children:["데이터 소스: ",(0,r.jsx)("span",{className:"font-medium",children:I})]})]})]})})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[418,845,838,794,145,587,315,358],()=>t(4605)),_N_E=e.O()}]);