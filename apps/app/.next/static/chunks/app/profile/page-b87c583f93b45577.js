(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[636],{1525:(e,t,s)=>{"use strict";s.d(t,{$k:()=>i,UU:()=>n});var o=s(4175);let l=null,a=()=>!0,n=()=>{if(l)return l;if(!a())return console.debug("서버 환경에서 Supabase 클라이언트 호출 - 제한된 기능"),{auth:{getSession:()=>({data:{session:null}}),getUser:()=>({data:{user:null}}),signOut:()=>Promise.resolve({error:null}),signInWithOAuth:()=>Promise.resolve({data:null,error:Error("서버 환경에서는 OAuth 불가")})},from:()=>({select:()=>({eq:()=>({single:()=>Promise.resolve({data:null,error:null}),data:[],error:null})})})};let e="https://izkumvvlkrkgiuuczffp.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VtdnZsa3JrZ2l1dWN6ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI3NzksImV4cCI6MjA2MDk4ODc3OX0.pQH_znuBuBfLBJdnMagX4_HE37Z8uraCp1_MaJFtEfc";try{return l=(0,o.kT)(e,t,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"},cookies:{get(e){if("undefined"!=typeof document){var t;let s="; ".concat(document.cookie).split("; ".concat(e,"="));if(2===s.length)return null==(t=s.pop())?void 0:t.split(";").shift()}},set(e,t,s){if("undefined"!=typeof document){let o="".concat(e,"=").concat(t);(null==s?void 0:s.maxAge)&&(o+="; max-age=".concat(s.maxAge)),(null==s?void 0:s.path)&&(o+="; path=".concat(s.path)),(null==s?void 0:s.domain)&&(o+="; domain=".concat(s.domain)),(null==s?void 0:s.secure)&&(o+="; secure"),(null==s?void 0:s.httpOnly)&&(o+="; httponly"),(null==s?void 0:s.sameSite)&&(o+="; samesite=".concat(s.sameSite)),document.cookie=o}},remove(e,t){if("undefined"!=typeof document){let s="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:00 GMT");(null==t?void 0:t.path)&&(s+="; path=".concat(t.path)),(null==t?void 0:t.domain)&&(s+="; domain=".concat(t.domain)),document.cookie=s}}},global:{fetch:function(){for(var e,s,o,l=arguments.length,a=Array(l),n=0;n<l;n++)a[n]=arguments[n];let r=String(a[0]instanceof URL?a[0].toString():a[0]),i=["/meal_images","/profiles","/menu_item_ratings","/school_infos","/quiz","/comment_likes"].some(e=>r.includes(e)||r.includes("school_infos")||r.includes("/quiz"));if(r.includes("/rest/v1/")){let e=(null==(o=a[1])?void 0:o.headers)||{};a[1]={...a[1],headers:{...e,apikey:t,Authorization:"Bearer ".concat(t),Accept:"application/json"}}}return!r.includes("/rest/v1/")||i||(null==(e=a[1])?void 0:e.headers)&&Object.entries((null==(s=a[1])?void 0:s.headers)||{}).some(e=>{let[t,s]=e;return"apikey"===t.toLowerCase()||"authorization"===t.toLowerCase()})?r.includes("/comment_likes")?(a[1]||(a[1]={}),a[1].headers||(a[1].headers={}),a[1].headers.Accept="application/json",a[1].headers["Content-Type"]="application/json",fetch(...a).then(e=>200!==e.status?(console.debug("comment_likes 요청 응답 코드 ".concat(e.status," 수정 처리")),new Response(JSON.stringify({data:[]}),{status:200,headers:{"Content-Type":"application/json"}})):e).catch(e=>(console.debug("좋아요 요청 처리 오류 포착:",e),new Response(JSON.stringify({data:[]}),{status:200})))):fetch(...a).catch(e=>{if(404===e.status)return new Response(JSON.stringify({error:"Not found",quiet:!0}),{status:404});throw e}):(console.debug("권한 없는 Supabase REST API 요청 차단:",r),Promise.resolve(new Response(JSON.stringify({message:"No API key found in request",hint:"No 'apikey' request header or url param was found."}),{status:401})))}}})}catch(s){return console.debug("Supabase 클라이언트 초기화 중 오류 발생 (무시됨)"),l=(0,o.kT)(e,t)}},r=async()=>{try{let e=n();await e.auth.signOut();{let e=[];for(let t=0;t<localStorage.length;t++){let s=localStorage.key(t);s&&(s.startsWith("sb-")||s.includes("supabase"))&&e.push(s)}e.forEach(e=>localStorage.removeItem(e)),sessionStorage.clear(),document.cookie.split(";").forEach(function(e){document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")})}l=null,console.debug("세션 완전 정리 완료")}catch(e){console.debug("세션 정리 중 오류 (무시됨):",e)}},i=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,s=n();console.log("\uD83D\uDD0D 로그인 시도 환경 정보:",{url:"https://izkumvvlkrkgiuuczffp.supabase.co",provider:e,userAgent:navigator.userAgent,cookiesEnabled:navigator.cookieEnabled,localStorage:"undefined"!=typeof localStorage,currentUrl:window.location.href});for(let o=1;o<=t;o++)try{console.log("\uD83D\uDE80 로그인 시도 ".concat(o,"/").concat(t," 시작")),o>1&&(console.log("\uD83E\uDDF9 이전 세션 정리 중..."),await r(),await new Promise(e=>setTimeout(e,1e3)));let{data:l}=await s.auth.getSession();console.log("\uD83D\uDCCA 현재 세션 상태:",l.session?"있음":"없음");let{data:a,error:n}=await s.auth.signInWithOAuth({provider:e,options:{redirectTo:"".concat(window.location.origin,"/auth/callback"),queryParams:{access_type:"offline",prompt:"consent"}}});if(console.log("✅ OAuth 요청 결과:",{data:a,error:n}),n)throw n;return{data:a,error:null}}catch(s){if(console.error("❌ 로그인 시도 ".concat(o,"/").concat(t," 실패:"),{error:s,errorMessage:null==s?void 0:s.message,errorCode:null==s?void 0:s.status,timestamp:new Date().toISOString()}),o===t)return{data:null,error:s};let e=1e3*Math.pow(2,o);console.log("⏳ ".concat(e,"ms 대기 후 재시도...")),await new Promise(t=>setTimeout(t,e))}}},7074:(e,t,s)=>{Promise.resolve().then(s.bind(s,8736))},8736:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c});var o=s(4568),l=s(7620),a=s(1525),n=s(2942),r=s(7261),i=s.n(r);function c(){var e,t;let[s,r]=(0,l.useState)(null),[c,d]=(0,l.useState)(null),[u,m]=(0,l.useState)(!0),[h,f]=(0,l.useState)(null),[g,p]=(0,l.useState)(!1),[x,v]=(0,l.useState)(null),[b,w]=(0,l.useState)(null),y=(0,n.useRouter)(),j=(0,a.UU)();(0,l.useEffect)(()=>{(async()=>{try{m(!0);let{data:{user:a},error:n}=await j.auth.getUser();if(n)throw console.error("사용자 인증 에러:",n),n;if(a){console.log("인증된 사용자 정보:",a),r(a),v("loading");let[n,i]=await Promise.allSettled([j.from("users").select("*").eq("id",a.id).single(),j.from("school_infos").select("*").eq("user_id",a.id).single()]);if("fulfilled"!==n.status||n.value.error){var e,t,s,o,l;console.error("사용자 프로필 조회 에러:",null==(e=n.value)?void 0:e.error),v("error"),(null==(s=n.value)||null==(t=s.error)?void 0:t.code)!=="PGRST116"&&f("DB 조회 에러: ".concat(null==(l=n.value)||null==(o=l.error)?void 0:o.message))}else console.log("사용자 DB 프로필:",n.value.data),d(n.value.data),v("success");"fulfilled"!==i.status||i.value.error||w(i.value.data)}else y.push("/login")}catch(e){console.error("프로필 로딩 에러:",e),f(e.message||"사용자 정보를 불러오는 중 오류가 발생했습니다.")}finally{m(!1)}})()},[j,y]);let N=async()=>{try{let{error:e}=await j.auth.signOut();if(e)throw e;y.push("/")}catch(e){f(e.message||"로그아웃 중 오류가 발생했습니다")}},k=async()=>{if(confirm("정말로 계정을 삭제하시겠습니까? \n\n이 작업은 되돌릴 수 없으며, 모든 계정 데이터가 영구적으로 삭제됩니다."))try{p(!0),f(null),console.log("회원 탈퇴 시작...");let{data:{user:e}}=await j.auth.getUser();if(!e)throw Error("로그인이 필요합니다.");console.log("회원 탈퇴 API 호출");let t=await fetch("/api/delete-account",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:e.id})}),s=await t.json();if(console.log("API 응답:",s),!t.ok)throw Error(s.error||"계정 삭제 중 API 오류가 발생했습니다.");console.log("로그아웃 처리 시작...");let{error:o}=await j.auth.signOut();if(o)throw console.error("로그아웃 오류:",o),Error("로그아웃 오류: ".concat(o.message));alert("회원 탈퇴가 성공적으로 완료되었습니다."),y.push("/")}catch(e){console.error("계정 삭제 중 오류 발생:",e),f(e.message||"계정 삭제 중 오류가 발생했습니다.")}finally{p(!1)}};return u?(0,o.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,o.jsx)("div",{className:"text-lg text-gray-600",children:"프로필 로딩 중..."})]})}):h?(0,o.jsx)("div",{className:"flex min-h-screen items-center justify-center p-4",children:(0,o.jsxs)("div",{className:"w-full max-w-md rounded-lg bg-red-50 p-6 text-center",children:[(0,o.jsx)("p",{className:"text-red-700",children:h}),(0,o.jsx)("button",{onClick:()=>y.push("/"),className:"mt-4 rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700",children:"홈으로 돌아가기"})]})}):(0,o.jsx)("div",{className:"flex min-h-screen flex-col p-4",children:(0,o.jsxs)("div",{className:"mx-auto w-full max-w-md",children:[(0,o.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,o.jsx)("h1",{className:"text-xl font-bold",children:"내 프로필"}),(0,o.jsx)(i(),{href:"/",className:"text-sm text-gray-500",children:"닫기"})]}),(0,o.jsxs)("div",{className:"mb-8",children:[(0,o.jsx)("div",{className:"flex justify-center mb-4",children:(0,o.jsx)("div",{className:"w-20 h-20 rounded-full bg-orange-500 flex items-center justify-center overflow-hidden border-2 border-orange-600",children:(null==c?void 0:c.profile_image)?(0,o.jsx)("img",{src:c.profile_image,alt:"프로필",className:"w-full h-full object-cover"}):(0,o.jsx)("div",{className:"text-white text-2xl font-bold",children:null==s||null==(e=s.email)?void 0:e.charAt(0).toUpperCase()})})}),(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("div",{className:"text-xl font-bold mb-1",children:"센드림"}),(0,o.jsx)("div",{className:"font-medium",children:(null==s?void 0:s.email)||"이메일 없음"}),(0,o.jsxs)("div",{className:"text-sm text-gray-500 mt-1",children:[(null==s||null==(t=s.app_metadata)?void 0:t.provider)||"Google"," / ",(null==s?void 0:s.created_at)?new Date(s.created_at).toLocaleDateString("ko-KR"):""," 계정 생성"]})]})]}),(0,o.jsxs)("div",{className:"mb-8 border-t border-b py-4",children:[(0,o.jsxs)("div",{className:"flex justify-between items-center mb-3",children:[(0,o.jsx)("h2",{className:"text-lg font-bold",children:"학교정보"}),(0,o.jsx)(i(),{href:"/school-search",className:"px-4 py-2 bg-green-600 text-white rounded-md text-base font-medium hover:bg-green-700 shadow-sm",children:"학교설정"})]}),b?(0,o.jsxs)("div",{children:[(0,o.jsxs)("div",{className:"text-base font-medium mb-1 flex justify-between",children:[(0,o.jsx)("span",{children:b.school_name}),(0,o.jsxs)("span",{children:[b.grade,"학년 ",b.class_number,"반"]})]}),(0,o.jsxs)("div",{className:"text-sm text-gray-700",children:[b.region," ",b.address&&b.address.substring(0,20),b.address&&b.address.length>20?"...":""]})]}):(0,o.jsx)("div",{className:"text-center py-3",children:(0,o.jsx)(i(),{href:"/school-search",className:"px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 inline-block",children:"학교 정보 설정하기"})})]}),(0,o.jsxs)("div",{className:"flex justify-center gap-4 mt-6",children:[(0,o.jsx)("button",{onClick:N,className:"rounded-md bg-blue-600 px-4 py-2 text-white text-sm hover:bg-blue-700 transition-colors",children:"로그아웃"}),(0,o.jsx)("button",{onClick:k,disabled:g,className:"rounded-md bg-red-600 px-4 py-2 text-white text-sm hover:bg-red-700 disabled:opacity-50 transition-colors",children:g?"삭제 중...":"회원 탈퇴"})]}),g&&(0,o.jsx)("div",{className:"mt-3 text-yellow-700 text-sm text-center",children:"회원 탈퇴 처리 중... 잠시만 기다려주세요."})]})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[838,261,587,315,358],()=>t(7074)),_N_E=e.O()}]);