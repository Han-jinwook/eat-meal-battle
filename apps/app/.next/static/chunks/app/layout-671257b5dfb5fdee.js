(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{1525:(e,t,r)=>{"use strict";r.d(t,{U:()=>i});var s=r(4175);let a=null,n=()=>!0,i=()=>{if(a)return a;if(!n())return console.debug("서버 환경에서 Supabase 클라이언트 호출 - 제한된 기능"),{auth:{getSession:()=>({data:{session:null}}),getUser:()=>({data:{user:null}}),signOut:()=>Promise.resolve({error:null})},from:()=>({select:()=>({eq:()=>({single:()=>Promise.resolve({data:null,error:null}),data:[],error:null})})})};let e="https://izkumvvlkrkgiuuczffp.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VtdnZsa3JrZ2l1dWN6ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI3NzksImV4cCI6MjA2MDk4ODc3OX0.pQH_znuBuBfLBJdnMagX4_HE37Z8uraCp1_MaJFtEfc";try{return a=(0,s.kT)(e,t,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce",localStorage:n()?window.localStorage:void 0},global:{fetch:function(){for(var e,r,s,a=arguments.length,n=Array(a),i=0;i<a;i++)n[i]=arguments[i];let o=String(n[0]instanceof URL?n[0].toString():n[0]),l=["/meal_images","/profiles","/menu_item_ratings","/school_infos","/quiz","/comment_likes"].some(e=>o.includes(e)||o.includes("school_infos")||o.includes("/quiz"));if(o.includes("/rest/v1/")){let e=(null==(s=n[1])?void 0:s.headers)||{};n[1]={...n[1],headers:{...e,apikey:t,Authorization:"Bearer ".concat(t),Accept:"application/json"}}}return!o.includes("/rest/v1/")||l||(null==(e=n[1])?void 0:e.headers)&&Object.entries((null==(r=n[1])?void 0:r.headers)||{}).some(e=>{let[t,r]=e;return"apikey"===t.toLowerCase()||"authorization"===t.toLowerCase()})?o.includes("/comment_likes")?(n[1]||(n[1]={}),n[1].headers||(n[1].headers={}),n[1].headers.Accept="application/json",n[1].headers["Content-Type"]="application/json",fetch(...n).then(e=>200!==e.status?(console.debug("comment_likes 요청 응답 코드 ".concat(e.status," 수정 처리")),new Response(JSON.stringify({data:[]}),{status:200,headers:{"Content-Type":"application/json"}})):e).catch(e=>(console.debug("좋아요 요청 처리 오류 포착:",e),new Response(JSON.stringify({data:[]}),{status:200})))):fetch(...n).catch(e=>{if(404===e.status)return new Response(JSON.stringify({error:"Not found",quiet:!0}),{status:404});throw e}):(console.debug("권한 없는 Supabase REST API 요청 차단:",o),Promise.resolve(new Response(JSON.stringify({message:"No API key found in request",hint:"No 'apikey' request header or url param was found."}),{status:401})))}}})}catch(r){return console.debug("Supabase 클라이언트 초기화 중 오류 발생 (무시됨)"),a=(0,s.kT)(e,t)}}},3139:()=>{},3334:(e,t,r)=>{Promise.resolve().then(r.bind(r,8558)),Promise.resolve().then(r.bind(r,9220)),Promise.resolve().then(r.bind(r,7584)),Promise.resolve().then(r.t.bind(r,4703,23)),Promise.resolve().then(r.t.bind(r,7573,23)),Promise.resolve().then(r.t.bind(r,3139,23)),Promise.resolve().then(r.bind(r,5317))},7584:(e,t,r)=>{"use strict";r.d(t,{_:()=>l,default:()=>o});var s=r(4568),a=r(7620),n=r(4175);let i=(0,a.createContext)({supabase:(0,n.kT)("https://izkumvvlkrkgiuuczffp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VtdnZsa3JrZ2l1dWN6ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI3NzksImV4cCI6MjA2MDk4ODc3OX0.pQH_znuBuBfLBJdnMagX4_HE37Z8uraCp1_MaJFtEfc"),session:null});function o(e){let{children:t,session:r}=e,[o]=(0,a.useState)(()=>(0,n.kT)("https://izkumvvlkrkgiuuczffp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VtdnZsa3JrZ2l1dWN6ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI3NzksImV4cCI6MjA2MDk4ODc3OX0.pQH_znuBuBfLBJdnMagX4_HE37Z8uraCp1_MaJFtEfc"));return(0,s.jsx)(i.Provider,{value:{supabase:o,session:r},children:t})}let l=()=>{let e=(0,a.useContext)(i);if(void 0===e)throw Error("useSupabase must be used inside SupabaseProvider");return e}},8558:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});var s=r(4568);let a=(0,r(1039).default)(()=>Promise.all([r.e(423),r.e(517)]).then(r.bind(r,8517)),{loadableGenerated:{webpack:()=>[8517]},ssr:!1});function n(){return(0,s.jsx)(a,{})}},9220:(e,t,r)=>{"use strict";r.d(t,{default:()=>u});var s=r(4568),a=r(7261),n=r.n(a),i=r(2942),o=r(1525),l=r(7620);function c(){let[e,t]=(0,l.useState)(!1),[r,a]=(0,l.useState)(0),[i,c]=(0,l.useState)([]),[d,u]=(0,l.useState)(!1),h=(0,o.U)(),m=(0,l.useRef)(null);(0,l.useEffect)(()=>{let e=e=>{m.current&&!m.current.contains(e.target)&&t(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,l.useEffect)(()=>{(async()=>{try{u(!0);let{data:{session:e}}=await h.auth.getSession();if(!(null==e?void 0:e.user))return;let{data:t,error:r}=await h.from("notification_recipients").select("\n            id,\n            notification_id,\n            is_read,\n            read_at,\n            created_at,\n            notification:notification_id (id, title, message, related_type, related_id, sender_id, school_code, created_at)\n          ").eq("recipient_id",e.user.id).order("created_at",{ascending:!1}).limit(10);if(r)return void console.error("알림 조회 오류:",r);let s=(null==t?void 0:t.map(e=>({id:e.id,notification_id:e.notification_id,is_read:e.is_read,read_at:e.read_at,created_at:e.created_at,...e.notification})))||[];c(s);let n=s.filter(e=>!e.is_read)||[];a(n.length)}catch(e){console.error("알림 데이터 로딩 오류:",e)}finally{u(!1)}})();let e=(async()=>{let{data:{session:e}}=await h.auth.getSession();if(!(null==e?void 0:e.user))return;let t=h.channel("notifications-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"notification_recipients",filter:"recipient_id=eq.".concat(e.user.id)},e=>{(async()=>{try{let{data:t,error:r}=await h.from("notifications").select("*").eq("id",e.new.notification_id).single();if(r||!t)return;let s={id:e.new.id,notification_id:e.new.notification_id,is_read:!1,created_at:e.new.created_at,...t};c(e=>[s,...e].slice(0,10)),a(e=>e+1)}catch(e){console.error("새 알림 조회 오류:",e)}})()}).subscribe();return()=>{t.unsubscribe()}})();return()=>{e&&e.then(e=>{"function"==typeof e&&e()})}},[h]);let f=async e=>{try{if(console.log("알림 읽음 처리 시도:",{notificationId:e}),!i.find(t=>t.notification_id===e))return void console.warn("읽음 처리할 알림을 찾을 수 없습니다.");c(t=>t.map(t=>t.notification_id===e?{...t,is_read:!0}:t)),a(e=>Math.max(0,e-1));let{data:{session:t}}=await h.auth.getSession(),r={"Content-Type":"application/json"};(null==t?void 0:t.access_token)&&(r.Authorization="Bearer ".concat(t.access_token));let s=async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;try{let n=new AbortController,i=setTimeout(()=>n.abort(),5e3);try{let o=await fetch("/.netlify/functions/notifications-read",{method:"POST",headers:r,body:JSON.stringify({notificationId:e}),signal:n.signal});if(clearTimeout(i),o.ok){let e=await o.json();console.log("알림 읽음 처리 API 성공:",e);return}if(o.status>=500&&t<a)return console.warn("API 호출 실패 (".concat(o.status,"), ").concat(t+1,"번째 재시도...")),await new Promise(e=>setTimeout(e,1e3)),s(t+1,a);console.warn("API 호출 실패지만 UI는 업데이트됨:",o.status)}catch(e){if(clearTimeout(i),("AbortError"===e.name||"TypeError"===e.name)&&t<a)return console.warn("API 호출 시간 초과, ".concat(t+1,"번째 재시도...")),await new Promise(e=>setTimeout(e,1e3)),s(t+1,a);throw e}}catch(e){console.error("알림 읽음 시도 중 오류:",e)}};await s()}catch(e){console.error("알림 상태 업데이트 오류:",e)}},g=async()=>{try{var e;let{data:{session:t}}=await h.auth.getSession();if(!(null==t||null==(e=t.user)?void 0:e.id))return void console.error("사용자 세션을 찾을 수 없습니다.");let r=i.filter(e=>!e.is_read);if(0===r.length)return;let{error:s}=await h.from("notification_recipients").update({is_read:!0,read_at:new Date().toISOString()}).eq("recipient_id",t.user.id).eq("is_read",!1);if(s)throw console.error("모든 알림 읽음 처리 실패:",s),Error("모든 알림 읽음 처리 실패");c(e=>e.map(e=>({...e,is_read:!0}))),a(0)}catch(e){console.error("알림 일괄 업데이트 오류:",e)}},p=e=>{let t=new Date(e),r=Math.floor((new Date().getTime()-t.getTime())/1e3);return r<60?"방금 전":r<3600?"".concat(Math.floor(r/60),"분 전"):r<86400?"".concat(Math.floor(r/3600),"시간 전"):r<604800?"".concat(Math.floor(r/86400),"일 전"):"".concat(t.getFullYear(),".").concat(String(t.getMonth()+1).padStart(2,"0"),".").concat(String(t.getDate()).padStart(2,"0"))},x=e=>{switch(e){case"meal_image":return(0,s.jsx)("svg",{className:"w-5 h-5 text-blue-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})});case"comment":return(0,s.jsx)("svg",{className:"w-5 h-5 text-green-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"})});default:return(0,s.jsx)("svg",{className:"w-5 h-5 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"})})}};return(0,s.jsxs)("div",{className:"relative",ref:m,children:[(0,s.jsxs)("button",{onClick:()=>t(!e),className:"relative p-1 rounded-full text-gray-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500","aria-label":"알림",children:[(0,s.jsx)("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"})}),r>0&&(0,s.jsx)("span",{className:"absolute top-0 right-0 block h-4 w-4 rounded-full bg-red-500 text-white text-xs font-bold flex items-center justify-center transform translate-x-1/2 -translate-y-1/4",children:r>9?"9+":r})]}),e&&(0,s.jsxs)("div",{className:"absolute right-0 mt-2 w-80 sm:w-96 bg-white rounded-md shadow-lg z-50 overflow-hidden",children:[(0,s.jsxs)("div",{className:"border-b px-4 py-2 flex justify-between items-center",children:[(0,s.jsx)("h3",{className:"text-sm font-medium text-gray-900",children:"알림"}),r>0&&(0,s.jsx)("button",{onClick:g,className:"text-xs text-blue-600 hover:text-blue-800 cursor-pointer",children:"모두 읽음 표시"})]}),(0,s.jsx)("div",{className:"max-h-96 overflow-y-auto",children:d?(0,s.jsxs)("div",{className:"p-4 text-center text-gray-500",children:[(0,s.jsxs)("svg",{className:"animate-spin h-5 w-5 text-gray-400 mx-auto mb-2",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"알림을 불러오는 중..."]}):i.length>0?i.map(e=>(0,s.jsx)("div",{className:"p-4 border-b ".concat(e.is_read?"bg-white":"bg-blue-50"," hover:bg-gray-50"),children:(0,s.jsxs)("div",{className:"flex",children:[(0,s.jsx)("div",{className:"flex-shrink-0 mr-3",children:x(e.related_type)}),(0,s.jsx)("div",{className:"flex-1 min-w-0",children:(0,s.jsxs)(n(),{href:"/?notification=".concat(e.related_id),onClick:()=>{e.is_read||f(e.notification_id),t(!1)},className:"block",children:[(0,s.jsx)("p",{className:"text-sm ".concat(e.is_read?"font-normal":"font-medium"," text-gray-900"),children:e.title}),(0,s.jsx)("p",{className:"text-sm text-gray-500 truncate",children:e.message}),(0,s.jsx)("p",{className:"text-xs text-gray-400 mt-1",children:p(e.created_at)})]})}),!e.is_read&&(0,s.jsx)("button",{onClick:()=>f(e.notification_id),className:"ml-2 text-gray-400 hover:text-gray-600","aria-label":"읽음 표시",children:(0,s.jsx)("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]})},e.id)):(0,s.jsx)("div",{className:"p-4 text-center text-gray-500",children:"새로운 알림이 없습니다."})})]})]})}let d=[{label:"급식",href:"/"},{label:"퀴즈",href:"/quiz"},{label:"배틀",href:"/battle"},{label:"랭킹",href:"/ranking"}];function u(){let e=(0,o.U)(),t=(0,i.usePathname)(),r=(0,i.useRouter)(),[a,u]=(0,l.useState)(!1),[h,m]=(0,l.useState)(null),f=(0,l.useRef)(null);(0,l.useEffect)(()=>{(async()=>{let{data:{session:t}}=await e.auth.getSession();if(null==t?void 0:t.user){var r,s;console.log("User object structure:",t.user),console.log("Profile image fields:",{"user.profile_image":t.user.profile_image,"user.user_metadata?.profile_image":null==(r=t.user.user_metadata)?void 0:r.profile_image,"user.user_metadata?.avatar_url":null==(s=t.user.user_metadata)?void 0:s.avatar_url})}m((null==t?void 0:t.user)||null)})();let{data:t}=e.auth.onAuthStateChange((e,t)=>{m((null==t?void 0:t.user)||null)});return()=>{null==t||t.subscription.unsubscribe()}},[e]),(0,l.useEffect)(()=>{let e=e=>{f.current&&!f.current.contains(e.target)&&u(!1)};return a&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[a]);let g=async()=>{await e.auth.signOut(),r.refresh()};return(0,s.jsx)("header",{className:"sticky top-0 z-40 border-b bg-white/70 backdrop-blur supports-[backdrop-filter]:bg-white/40",children:(0,s.jsxs)("div",{className:"mx-auto flex max-w-screen-xl items-center justify-between px-4 py-2 sm:px-6 lg:px-8",children:[(0,s.jsxs)(n(),{href:"/",className:"flex items-center text-lg font-bold text-indigo-600",children:[(0,s.jsx)("span",{className:"mr-2 hidden sm:inline",children:"\uD83C\uDF71"})," 급식배틀"]}),(0,s.jsx)("nav",{className:"flex overflow-x-auto gap-3 sm:gap-6 px-1 py-1 -mx-1 scrollbar-hide",children:d.map(e=>(0,s.jsx)(n(),{href:e.href,className:"text-xs sm:text-sm font-medium whitespace-nowrap px-2 py-1 rounded-full hover:bg-indigo-50 hover:text-indigo-600 transition-colors ".concat("/"===e.href?"/"===t?"bg-indigo-50 text-indigo-600":"text-gray-700":t.startsWith(e.href)?"bg-indigo-50 text-indigo-600":"text-gray-700"),children:e.label},e.href))}),(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[h&&(0,s.jsx)(c,{}),(0,s.jsxs)("div",{className:"relative",ref:f,children:[h?(0,s.jsx)("button",{onClick:()=>u(e=>!e),className:"h-8 w-8 overflow-hidden rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2",children:(()=>{var e,t;let r=null==(e=h.user_metadata)?void 0:e.avatar_url;r&&r.startsWith("http://")&&console.log("Profile image URL changed to HTTPS:",r=r.replace("http://","https://"));let a=null==(t=h.user_metadata)?void 0:t.name;if(r)return(0,s.jsx)("img",{src:r,alt:a||"User Avatar",className:"h-full w-full object-cover",onError:e=>{e.currentTarget.style.display="none";let t=e.currentTarget.parentElement;t&&a&&(t.classList.add("flex","items-center","justify-center","bg-slate-300"),t.textContent=a.charAt(0).toUpperCase())}});if(!a)return(0,s.jsx)("div",{className:"flex h-full w-full items-center justify-center bg-gray-200",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})});{let e=a.charAt(0).toUpperCase();return(0,s.jsx)("div",{className:"flex h-full w-full items-center justify-center bg-slate-300 text-slate-700 text-sm font-semibold",children:e})}})()}):(0,s.jsxs)(n(),{href:"/login",className:"flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800",children:[(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"})}),"로그인"]}),h&&a&&(0,s.jsxs)("div",{className:"absolute right-0 mt-2 w-40 origin-top-right rounded-md border bg-white shadow-lg",children:[(0,s.jsx)(n(),{href:"/profile",className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100",onClick:()=>u(!1),children:"프로필"}),(0,s.jsx)(n(),{href:"/school-search",className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100",onClick:()=>u(!1),children:"학교설정"}),(0,s.jsx)("button",{onClick:g,className:"block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100",children:"로그아웃"})]})]})]})]})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[392,838,261,921,587,315,358],()=>t(3334)),_N_E=e.O()}]);