(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1525:(e,t,a)=>{"use strict";a.d(t,{U:()=>s});var r=a(4175);let l=null,n=()=>!0,s=()=>{if(l)return l;if(!n())return console.debug("서버 환경에서 Supabase 클라이언트 호출 - 제한된 기능"),{auth:{getSession:()=>({data:{session:null}}),getUser:()=>({data:{user:null}}),signOut:()=>Promise.resolve({error:null})},from:()=>({select:()=>({eq:()=>({single:()=>Promise.resolve({data:null,error:null}),data:[],error:null})})})};let e="https://izkumvvlkrkgiuuczffp.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VtdnZsa3JrZ2l1dWN6ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI3NzksImV4cCI6MjA2MDk4ODc3OX0.pQH_znuBuBfLBJdnMagX4_HE37Z8uraCp1_MaJFtEfc";try{return l=(0,r.kT)(e,t,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce",localStorage:n()?window.localStorage:void 0},global:{fetch:function(){for(var e,a,r,l=arguments.length,n=Array(l),s=0;s<l;s++)n[s]=arguments[s];let o=String(n[0]instanceof URL?n[0].toString():n[0]),i=["/meal_images","/profiles","/menu_item_ratings","/school_infos","/quiz","/comment_likes"].some(e=>o.includes(e)||o.includes("school_infos")||o.includes("/quiz"));if(o.includes("/rest/v1/")){let e=(null==(r=n[1])?void 0:r.headers)||{};n[1]={...n[1],headers:{...e,apikey:t,Authorization:"Bearer ".concat(t),Accept:"application/json"}}}return!o.includes("/rest/v1/")||i||(null==(e=n[1])?void 0:e.headers)&&Object.entries((null==(a=n[1])?void 0:a.headers)||{}).some(e=>{let[t,a]=e;return"apikey"===t.toLowerCase()||"authorization"===t.toLowerCase()})?o.includes("/comment_likes")?(n[1]||(n[1]={}),n[1].headers||(n[1].headers={}),n[1].headers.Accept="application/json",n[1].headers["Content-Type"]="application/json",fetch(...n).then(e=>200!==e.status?(console.debug("comment_likes 요청 응답 코드 ".concat(e.status," 수정 처리")),new Response(JSON.stringify({data:[]}),{status:200,headers:{"Content-Type":"application/json"}})):e).catch(e=>(console.debug("좋아요 요청 처리 오류 포착:",e),new Response(JSON.stringify({data:[]}),{status:200})))):fetch(...n).catch(e=>{if(404===e.status)return new Response(JSON.stringify({error:"Not found",quiet:!0}),{status:404});throw e}):(console.debug("권한 없는 Supabase REST API 요청 차단:",o),Promise.resolve(new Response(JSON.stringify({message:"No API key found in request",hint:"No 'apikey' request header or url param was found."}),{status:401})))}}})}catch(a){return console.debug("Supabase 클라이언트 초기화 중 오류 발생 (무시됨)"),l=(0,r.kT)(e,t)}}},3955:e=>{e.exports={container:"StarRating_container__wcvPj",starRating:"StarRating_starRating__1zTCK",star:"StarRating_star__QCP0_",small:"StarRating_small__LixRz",medium:"StarRating_medium__lZz_C",large:"StarRating_large__lmltq",filled:"StarRating_filled__5rpji",halfFilled:"StarRating_halfFilled__9vrBQ",empty:"StarRating_empty__CGeAC",positive:"StarRating_positive__kbCSb",neutral:"StarRating_neutral__Ty9Xe",negative:"StarRating_negative__Xz_Do",ratingInfo:"StarRating_ratingInfo__ihrMI",ratingValue:"StarRating_ratingValue__f82Mo",ratingCount:"StarRating_ratingCount__kNgMm"}},4605:(e,t,a)=>{Promise.resolve().then(a.bind(a,7498))},7498:(e,t,a)=>{"use strict";let r;a.r(t),a.d(t,{default:()=>z});var l=a(4568),n=a(7620),s=a(2942),o=a(1525);function i(){let e=(0,o.U)(),[t,a]=(0,n.useState)(null),[r,l]=(0,n.useState)(null),[s,i]=(0,n.useState)(!1),[c,d]=(0,n.useState)(""),[u,m]=(0,n.useState)(0),g=(0,n.useCallback)(()=>{m(e=>e+1)},[]);return(0,n.useEffect)(()=>{(async()=>{try{i(!0),d("");let{data:{user:t},error:r}=await e.auth.getUser();if(r)throw r;if(a(t),t){let{data:a,error:r}=await e.from("school_infos").select("*").eq("user_id",t.id).single();if(r&&"PGRST116"!==r.code)throw Error("학교 정보 조회 에러: ".concat(r.message));l(null!=a?a:null)}else l(null)}catch(e){console.error("useUserSchool 오류:",e),d(e.message||"사용자 정보를 불러오는 중 오류")}finally{i(!1)}})()},[e,u]),{user:t,userSchool:r,loading:s,error:c,refresh:g}}let c=e=>{if(!e||""===e.trim())return"/images/placeholder.jpg";if(e.startsWith("/api/image-proxy")||(/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(\/|$)/.test(e)&&!e.startsWith("http")&&(e="https://".concat(e)),e.startsWith("/")&&!e.startsWith("//")))return e;try{if(e.startsWith("//"))e="https:".concat(e);else if(!e.startsWith("http"))return"/images/placeholder.jpg";if(e.includes("supabase.co")&&e.includes("/storage/")||e.startsWith("http")){let t=encodeURIComponent(e);return"/api/image-proxy?url=".concat(t)}return"/images/placeholder.jpg"}catch(e){return console.warn("이미지 URL 처리 오류:",e),"/images/placeholder.jpg"}},d=e=>{try{let t=e.currentTarget;if(t.style.display="none",t.parentElement&&(t.parentElement.style.backgroundColor="#f3f4f6",!t.parentElement.querySelector(".image-fallback"))){let e=document.createElement("div");e.innerText="이미지를 불러올 수 없습니다",e.className="image-fallback flex items-center justify-center h-full w-full text-gray-500 text-sm",t.parentElement.appendChild(e)}e.preventDefault()}catch(e){console.warn("이미지 에러 처리 중 오류 발생",e)}},u=e=>{let{src:t,alt:a,className:r="",style:n={}}=e,s=(null==t?void 0:t.startsWith("data:"))?t:c(t);return(0,l.jsx)("img",{src:s,alt:a,className:r,style:n,onError:d,loading:"lazy"})};function m(e){let{mealId:t,schoolCode:a,mealDate:r,mealType:s,onUploadSuccess:i,onUploadError:c}=e,d=(0,o.U)(),[m,g]=(0,n.useState)(!1),[h,f]=(0,n.useState)(null),[x,p]=(0,n.useState)(null),[_,v]=(0,n.useState)(!1),[y,w]=(0,n.useState)(null),[b,j]=(0,n.useState)(null),[N,S]=(0,n.useState)(null),[k,C]=(0,n.useState)(!1),[E,I]=(0,n.useState)("none"),[L,A]=(0,n.useState)(!0),R=(0,n.useRef)(null);(0,n.useEffect)(()=>{(async()=>{let{data:{user:e}}=await d.auth.getUser();e&&S(e.id)})()},[d]),(0,n.useEffect)(()=>{console.log("테스트 모드: AI 이미지 생성 버튼 항상 표시"),A(!0)},[]);let T=(0,n.useCallback)(async()=>{if(!t)return;console.log("승인된 이미지 조회:",t);let{data:e,error:a}=await d.from("meal_images").select("*").eq("meal_id",t).eq("status","approved").single();if(a){"PGRST116"!==a.code&&console.debug("기존 승인 이미지 조회 오류:",a);return}if(e){if(console.log("승인된 이미지 발견:",e.id),e.uploaded_by){let{data:t,error:a}=await d.from("users").select("nickname").eq("id",e.uploaded_by).single();!a&&t&&(e.uploader_nickname=t.nickname)}j(e),A(!1)}},[t,d]);(0,n.useEffect)(()=>{T()},[T]),(0,n.useEffect)(()=>{if(!t)return;console.log("실시간 이미지 구독 설정:",t);let e=d.channel("meal-images-".concat(t)).on("postgres_changes",{event:"*",schema:"public",table:"meal_images",filter:"meal_id=eq.".concat(t)},e=>{console.log("이미지 실시간 업데이트 수신:",e),e.new&&("approved"===e.new.status||e.old&&"approved"!==e.old.status&&"approved"===e.new.status)&&(console.log("승인된 이미지 변경 감지, 이미지 다시 가져오기"),T())}).subscribe();return()=>{console.log("이미지 실시간 구독 해제:",t),d.removeChannel(e)}},[t,d,T]);let q=async()=>{try{let e;console.log("AI 이미지 생성 버튼 클릭!"),f(null),R.current&&(R.current.value=""),g(!1),p(null),v(!1),I("generating"),console.log("메뉴 정보 조회 시도:",{schoolCode:a,mealDate:r,mealType:s});let{data:l,error:n}=await d.from("meal_menus").select("id, menu_items, meal_date, meal_type, school_code").eq("school_code",a).eq("meal_date",r).eq("meal_type",s).single();if(n)throw console.error("메뉴 정보 조회 오류:",n),Error("메뉴 정보를 찾을 수 없습니다.");if(!l||!l.menu_items||0===l.menu_items.length)throw console.error("메뉴 정보가 없습니다:",l),Error("급식 메뉴 정보가 없습니다.");console.log("메뉴 정보 조회 성공:",{menuItems:l.menu_items,menuCount:l.menu_items.length,mealDate:l.meal_date,mealType:l.meal_type,schoolCode:l.school_code});let o="/.netlify/functions/generate-meal-image";console.log("AI 이미지 생성 API 요청 URL:",o);let u=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({menu_items:l.menu_items,meal_id:t,school_code:l.school_code||a,meal_date:l.meal_date||r,meal_type:l.meal_type||s,user_id:N})});console.log("AI 이미지 생성 API 응답 상태 코드:",u.status,u.statusText);let m=await u.text();console.log("AI 이미지 생성 API 응답 텍스트(처음 200자):",m.substring(0,200));try{e=JSON.parse(m),console.log("AI 이미지 생성 API 응답 파싱 결과:",e)}catch(e){throw console.error("AI 이미지 생성 API 응답 파싱 오류:",e),console.error("파싱 오류 발생한 응답의 처음 부분:",m.substring(0,50)),Error("응답 처리 중 오류가 발생했습니다. 상태 코드: ".concat(u.status))}if(!e.success)throw Error(e.error||"AI 이미지 생성에 실패했습니다.");if(console.log("AI 이미지 생성 성공:",e.image),e.image&&e.image.uploaded_by)try{let{data:t,error:a}=await d.from("users").select("nickname, profile_image").eq("id",e.image.uploaded_by).single();!a&&t?(console.log("AI 이미지 생성 - 사용자 정보 조회 성공:",t),e.image.uploader_nickname=t.nickname,e.image.users={nickname:t.nickname,profile_image:t.profile_image}):console.error("AI 이미지 생성 - 사용자 정보 조회 오류:",a)}catch(e){console.error("AI 이미지 생성 - 사용자 정보 조회 예외:",e)}j(e.image),w({isMatch:!0,matchScore:1,explanation:"AI가 생성한 이미지입니다. 메뉴에 맞게 자동 생성되었습니다."}),I("complete"),console.log("⏱️ 이미지 업로드 후 콜백 호출 대기 중..."),setTimeout(()=>{console.log("⏱️ 콜백 호출 타이머 완료, onUploadSuccess 호출"),i&&i()},4e3);let h=x&&"object"==typeof x&&x.message?x.message:"AI 이미지 생성 중 오류가 발생했습니다.";p(h),I("error"),c&&c(h)}finally{g(!1)}},M=async e=>{try{let t;v(!0);let a=/^(localhost|127\.|\/api)/.test(window.location.hostname)?"/api/meal-images/verify":"/.netlify/functions/verify-meal-image";console.log("검증 API 요청 URL:",a);let r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageId:e})}),l=await r.text();try{t=JSON.parse(l),console.log("검증 API 응답:",t)}catch(e){if(console.error("검증 API 응답 파싱 오류:",e,l),r.ok)throw Error("응답 파싱 오류: 올바른 JSON 응답이 아닙니다");throw Error("검증 API 오류: ".concat(r.status," ").concat(r.statusText))}if(!r.ok)throw Error((null==t?void 0:t.error)||"이미지 검증 중 오류가 발생했습니다.");return w(t),t}catch(e){throw console.error("이미지 검증 오류:",e),p(e.message||"이미지 검증 중 오류가 발생했습니다."),e}finally{v(!1)}},z=async()=>{var e,l,n,o;if(!(null==(l=R.current)||null==(e=l.files)?void 0:e[0]))return void p("업로드할 이미지를 선택해주세요.");console.log("업로드 시도:",{fileName:R.current.files[0].name,fileSize:R.current.files[0].size,mealId:t||"undefined",preview:!!h}),g(!0),p(null),w(null);let u="";try{let e,l=R.current.files[0],{data:{user:c}}=await d.auth.getUser();if(!c)throw Error("로그인이 필요합니다.");let m=new FormData;m.append("file",l),m.append("meal_id",t),m.append("school_code",a),m.append("meal_date",r),m.append("meal_type",s),m.append("user_id",c.id),console.log("서버 사이드 업로드 시도...",{meal_id:t,school_code:a,meal_date:r,meal_type:s,file_name:l.name,file_size:l.size});let g=/^(localhost|127\.|\/api)/.test(window.location.hostname)?"/api/meal-images/upload":"/.netlify/functions/upload-meal-image";console.log("업로드 API 요청 URL:",g);let h=await fetch(g,{method:"POST",body:m});if(!h.ok){let e=await h.text(),t="서버 오류: ".concat(h.status," ").concat(h.statusText);try{if(e.trim().startsWith("{")){let a=JSON.parse(e);a.error&&(t=a.error)}}catch(e){console.error("응답 파싱 오류:",e)}throw p(t),Error(t)}try{let t=await h.text();e=JSON.parse(t)}catch(e){throw console.error("성공 응답 파싱 오류:",e),p("응답 데이터 파싱 중 오류가 발생했습니다"),Error("응답 데이터 파싱 오류")}console.log("업로드 성공:",e),u=e.id;try{let e=await M(u);console.log("검증 결과:",e);let{data:t}=await d.from("meal_images").select("\n            *,\n            users:uploaded_by(id, nickname, profile_image)\n          ").eq("id",u).single();if(t){let a={...t,uploader_nickname:(null==(n=t.users)?void 0:n.nickname)||null,status:e.isMatch?"approved":"rejected",explanation:e.explanation||null};j(a)}console.log("⏱️ 이미지 업로드 후 콜백 호출 대기 중..."),setTimeout(()=>{console.log("⏱️ 콜백 호출 타이머 완료, onUploadSuccess 호출"),i&&i()},2e3)}catch(e){console.error("검증 오류:",e);try{let{data:e}=await d.from("meal_images").select("\n              *,\n              users:uploaded_by(id, nickname, profile_image)\n            ").eq("id",u).single();if(e){let t={...e,uploader_nickname:(null==(o=e.users)?void 0:o.nickname)||null,status:"rejected",explanation:"이미지 검증 중 오류가 발생했습니다."};j(t)}}catch(e){console.error("이미지 정보 조회 오류:",e)}i&&i()}R.current&&(R.current.value=""),f(null)}catch(e){console.error("이미지 업로드 오류:",e),p(e.message||"이미지 업로드 중 오류가 발생했습니다."),c&&c(e.message||"이미지 업로드 중 오류가 발생했습니다.")}finally{g(!1)}},U=async()=>{if(b)try{let{data:e}=await d.from("meal_images").select("*").eq("id",b.id).single();if(!e)throw Error("이미지를 찾을 수 없습니다.");if("approved"===e.status)return void p("승인되거나 공유된 이미지는 삭제할 수 없습니다.");let{error:t}=await d.from("meal_images").delete().eq("id",b.id);if(t)throw t;try{let t=new URL(e.image_url).pathname.split("/"),a=t[t.length-1];console.log("삭제할 파일 경로:",a);let{error:r}=await d.storage.from("meal-images").remove([a]);r&&console.error("스토리지 이미지 삭제 오류:",r)}catch(e){console.error("파일 경로 추출 오류:",e)}j(null),w(null),f(null),R.current&&(R.current.value=""),i&&i()}catch(e){console.error("이미지 삭제 오류:",e),p(e.message||"이미지 삭제 중 오류가 발생했습니다.")}};return(0,l.jsx)("div",{className:"p-0 mb-0 max-w-xl mx-auto",children:b?(0,l.jsx)("div",{children:(0,l.jsxs)("div",{className:"overflow-hidden rounded-lg",children:[(0,l.jsx)("div",{className:"relative w-full h-auto",children:(0,l.jsx)(u,{src:b.image_url,alt:"급식 이미지",style:{width:"100%",height:"auto",maxHeight:"80vh",display:"block"}})}),(0,l.jsxs)("div",{className:"px-0 py-1 text-xs",children:[(0,l.jsxs)("div",{className:"flex justify-end items-center",children:["user_ai"===b.source&&b.uploader_nickname&&(0,l.jsxs)("span",{className:"text-xs text-gray-500 text-right",children:["AI로 생성한 이미지 (",b.uploader_nickname,")"]}),"user_ai"===b.source&&!b.uploader_nickname&&(0,l.jsx)("span",{className:"text-xs text-gray-500 text-right",children:"AI로 생성한 이미지"}),"auto_ai"===b.source&&(0,l.jsx)("span",{className:"text-xs text-gray-500 text-right",children:"AI로 생성한 이미지"}),"user"===b.source&&b.uploader_nickname&&(0,l.jsxs)("span",{className:"text-xs text-gray-500 text-right",children:["(",b.uploader_nickname,")"]})]}),"rejected"===b.status&&(0,l.jsx)("div",{className:"text-sm mb-2",children:"rejected"===b.status&&(0,l.jsx)("span",{className:"text-orange-600 ml-1",children:"(매칭실패, 업로드 불가)"})}),"rejected"===b.status&&b.explanation&&(0,l.jsxs)("div",{className:"text-sm text-gray-700 mb-2",children:[(0,l.jsx)("span",{className:"font-semibold",children:"사유:"})," ",b.explanation]}),"approved"!==b.status&&(0,l.jsx)("button",{onClick:U,className:"mt-2 text-sm text-red-600 hover:text-red-800",children:"삭제"})]})]})}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"mb-4",children:[(0,l.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"오늘의 급식 사진을 공유해보세요!"}),(0,l.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var a,r,l;let n=null==(a=e.target.files)?void 0:a[0];if(!n)return;if(console.log("파일 선택됨:",{fileName:n.name,fileSize:n.size,mealId:t||"undefined",fileType:n.type}),!n.type.startsWith("image/"))return void p("이미지 파일만 업로드할 수 있습니다.");if(n.size>5242880)return void p("파일 크기는 5MB 이하여야 합니다.");C(!1),I("processing"),console.log("버튼 타이머 시작"),setTimeout(()=>{C(!0),console.log("버튼 활성화 타이머 완료")},6e3);let s=new FileReader;s.onload=e=>{var t;f(null==(t=e.target)?void 0:t.result)},s.readAsDataURL(n),p(null),w(null),g(!1),v(!1),console.log("파일 로드 완료, 상태:",{file:!!n,previewSet:!!(null==(l=e.target)||null==(r=l.files)?void 0:r[0]),uploading:!1,verifying:!1,isButtonReady:!1,imageStatus:"processing"})},ref:R,className:"block w-full text-sm text-gray-500   file:mr-4 file:py-2 file:px-4   file:rounded-md file:border-0   file:text-sm file:font-semibold   file:bg-blue-50 file:text-blue-700   hover:file:bg-blue-100"})]}),h&&(0,l.jsxs)("div",{className:"mb-4",children:[(0,l.jsx)("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"미리보기:"}),(0,l.jsx)("div",{className:"relative w-full h-64 bg-gray-100 rounded-md overflow-hidden",children:(0,l.jsx)(u,{src:h,alt:"업로드 이미지 미리보기",style:{objectFit:"contain",position:"absolute",width:"100%",height:"100%"}})})]}),x&&(0,l.jsx)("div",{className:"mb-4 p-3 bg-red-50 text-red-700 rounded-md text-sm",children:x}),(0,l.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,l.jsx)("button",{disabled:m||_||!h||!k,onClick:()=>{console.log("업로드 버튼 클릭, 상태:",{uploading:m,verifying:_,preview:!!h,isDisabled:m||_||!h}),z()},className:"px-4 py-2 rounded-md text-white ".concat(m||_||!h||!k?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"),children:m||_?(0,l.jsxs)("span",{className:"flex items-center",children:[(0,l.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,l.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,l.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"AI 분석 중..."]}):!k&&h?(0,l.jsxs)("span",{className:"flex items-center",children:[(0,l.jsxs)("svg",{className:"animate-pulse -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,l.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,l.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"AI 분석 준비 중..."]}):"업로드 및 AI 검증"}),L&&(0,l.jsx)("button",{onClick:q,disabled:"generating"===E,className:"px-4 py-2 rounded-md text-white ".concat("generating"===E?"bg-gray-400 cursor-not-allowed":"bg-green-600 hover:bg-green-700"," flex items-center"),children:"generating"===E?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,l.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,l.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"AI 이미지 생성 중..."]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})}),"AI 이미지 생성"]})})]})]})})}var g=a(8556),h=a(3955),f=a.n(h);let x=e=>{let{value:t=0,onChange:a,interactive:r=!1,size:s="medium",showValue:o=!1,ratingCount:i}=e,c=(0,n.useRef)(!0),[d,u]=(0,n.useState)(!1),m=(0,n.useRef)(null),h=Math.round(10*t)/10,x={small:f().small,medium:f().medium,large:f().large}[s],p=h>=4?f().positive:h>=3?f().neutral:f().negative,_=e=>{let t=h>=e+1,a=h>=e+.5&&h<e+1;return t?(0,l.jsx)(g.gt3,{className:"".concat(f().star," ").concat(f().filled," ").concat(p)}):a?(0,l.jsx)(g.gVl,{className:"".concat(f().star," ").concat(f().halfFilled," ").concat(p)}):(0,l.jsx)(g.wei,{className:"".concat(f().star," ").concat(f().empty)})};(0,n.useEffect)(()=>()=>{c.current=!1,null!==m.current&&(window.clearTimeout(m.current),m.current=null)},[]);let v=(0,n.useCallback)(e=>{if(!d&&r)try{if(u(!0),!c.current)return;a&&a(e+1),null!==m.current&&clearTimeout(m.current),m.current=window.setTimeout(()=>{c.current&&u(!1)},300)}catch(e){console.error("별점 클릭 처리 중 오류:",e),c.current&&u(!1)}},[r,a,d]),y=n.useMemo(()=>[0,1,2,3,4].map(e=>(0,l.jsx)("span",{onClick:t=>{t.stopPropagation(),v(e)},style:{cursor:r&&!d?"pointer":"default",opacity:d?.7:1,transition:"opacity 0.2s ease-in-out"},role:"button","aria-label":"".concat(e+1,"점 평가하기"),children:_(e)},e)),[r,d,_,v]);return(0,l.jsxs)("div",{className:f().container,children:[(0,l.jsx)("div",{className:"".concat(f().starRating," ").concat(x),children:y}),o&&h>0&&(0,l.jsxs)("div",{className:f().ratingInfo,children:[(0,l.jsx)("span",{className:"".concat(f().ratingValue," ").concat(p),children:h.toFixed(1)}),void 0!==i&&(0,l.jsxs)("span",{className:f().ratingCount,children:["(",i,"명)"]})]})]})},p=(0,o.U)(),_=e=>{let{mealId:t}=e,[a,r]=(0,n.useState)(null),[s,o]=(0,n.useState)(null),[i,c]=(0,n.useState)(null),[d,u]=(0,n.useState)(!1),[m,g]=(0,n.useState)([]),h=(0,n.useRef)(!0),f=(0,n.useRef)(null);(0,n.useEffect)(()=>{(async()=>{let{data:e}=await p.auth.getUser();r(null==e?void 0:e.user)})()},[]);let x=async()=>{if(!t)return[];try{console.log("급식 메뉴 아이템 조회 시작:",t);let{data:e,error:a}=await p.from("meal_menu_items").select("id").eq("meal_id",t);if(a)return console.error("메뉴 아이템 조회 오류:",a.message),[];if(!e||0===e.length)return console.log("메뉴 아이템이 없음"),[];return console.log("메뉴 아이템 조회 결과:",e.length,"개 항목"),e.map(e=>e.id)}catch(e){return console.error("메뉴 아이템 조회 중 오류 발생:",e),[]}},_=async()=>{if(t&&a)try{let e=await x();if(0===e.length){await j(null),g([]),o(null);return}console.log("내 메뉴 아이템 평점 조회 시작:",e.length,"개 항목");let{data:t,error:r}=await p.from("menu_item_ratings").select("menu_item_id, rating").eq("user_id",a.id).in("menu_item_id",e);if(r)return void console.error("메뉴 아이템 평점 조회 오류:",r.message);if(!t||0===t.length){console.log("메뉴 아이템 평점이 없음, 급식 평점 row 삭제"),g([]),o(null),await j(null);return}if(console.log("메뉴 아이템 평점 조회 결과:",t.length,"개 항목"),g(t),!h.current)return;let l=w(t);if(null!==l){if(await j(l),!h.current)return;o(l)}}catch(e){console.error("급식 평점 계산 및 저장 중 오류 발생:",e)}},v=async()=>{if(t&&a)try{u(!0),console.log("내 급식 평점 조회 시작:",t,a.id);let e=new AbortController;e.signal;let r=setTimeout(()=>e.abort(),1e4),{data:l,error:n}=await p.from("meal_ratings").select("rating").eq("meal_id",t).eq("user_id",a.id).maybeSingle();if(clearTimeout(r),!h.current)return;if(n&&"PGRST116"!==n.code)return void console.error("내 급식 평점 조회 오류:",n.message);l?(console.log("내 급식 평점 조회 결과:",l.rating),o(l.rating)):(console.log("내 급식 평점이 없음"),o(null))}catch(e){(null==e?void 0:e.name)==="AbortError"?console.log("급식 평점 조회 요청 타임아웃"):console.error("내 급식 평점 조회 중 오류 발생:",e)}finally{h.current&&u(!1)}},y=async()=>{if(t)try{u(!0),console.log("급식 평점 통계 조회 시작:",t);let e=new AbortController;e.signal;let a=setTimeout(()=>e.abort(),1e4),{data:r,error:l}=await p.from("meal_ratings").select("rating").eq("meal_id",t);if(clearTimeout(a),!h.current)return;if(l)return void console.error("급식 평점 통계 조회 오류:",l.message);if(r&&r.length>0){let e=r.reduce((e,t)=>e+t.rating,0)/r.length;console.log("급식 평점 통계 조회 결과:",e),c(e)}else console.log("급식 평점 통계가 없음"),c(null)}catch(e){(null==e?void 0:e.name)==="AbortError"?console.log("급식 평점 통계 조회 요청 타임아웃"):console.error("급식 평점 통계 조회 중 오류 발생:",e)}finally{h.current&&u(!1)}},w=e=>e&&0!==e.length?e.reduce((e,t)=>e+t.rating,0)/e.length:null,b=async e=>{if(!t||!a)return console.log("급식 ID 또는 사용자 정보가 없음"),!1;try{u(!0),console.log("급식 평점 저장 시작:",t,a.id,e);let r=new AbortController;r.signal;let l=setTimeout(()=>r.abort(),1e4),{error:n}=await p.from("meal_ratings").upsert({user_id:a.id,meal_id:t,rating:e,updated_at:new Date().toISOString()},{onConflict:"user_id,meal_id"});if(clearTimeout(l),!h.current)return!1;if(n)return console.error("급식 평점 저장 오류:",n.message),!1;console.log("급식 평점 저장 성공!");try{let r=new CustomEvent("meal-rating-change",{detail:{mealId:t,userId:a.id,rating:e}});window.dispatchEvent(r)}catch(e){console.error("이벤트 발생 중 오류:",e)}return!0}catch(e){return(null==e?void 0:e.name)==="AbortError"?console.log("급식 평점 저장 요청 타임아웃"):console.error("급식 평점 저장 중 오류 발생:",e),!1}finally{h.current&&u(!1)}},j=async e=>{if(!t||!a||d)return!1;try{if(null!==e&&(e<1||e>5)){console.log("유효하지 않은 평점. 평점 삭제:",e);let{error:r}=await p.from("meal_ratings").delete().eq("user_id",a.id).eq("meal_id",t);if(r)return console.error("평점 삭제 오류:",r.message),!1;return h.current&&o(null),!0}return b(e)}catch(e){return console.error("평점 저장 또는 삭제 중 오류 발생:",e),!1}finally{h.current&&u(!1)}};(0,n.useEffect)(()=>(window.addEventListener("menu-item-rating-change",N),window.addEventListener("focus",S),()=>{h.current=!1,window.removeEventListener("menu-item-rating-change",N),window.removeEventListener("focus",S),null!==f.current&&(clearTimeout(f.current),f.current=null)}),[t,a]);let N=e=>{if(!("detail"in e)||!e.detail)return;let t=e.detail;if(t.menuItemId){if(!h.current)return void console.log("언마운트된 컴포넌트의 이벤트 처리 무시");if(console.log("메뉴 아이템 평점 변경 감지:",t),t.deleted&&s)m.length<=1&&o(null);else if(t.newRating&&!s)o(t.newRating);else if(t.newRating&&s){let e=[...m],a=e.findIndex(e=>e.menu_item_id===t.menuItemId);a>=0?e[a]={...e[a],rating:t.newRating}:e.push({menu_item_id:t.menuItemId,rating:t.newRating}),o(w(e))}null!==f.current&&(clearTimeout(f.current),f.current=null),f.current=window.setTimeout(async()=>{h.current&&(await _(),h.current&&y())},500)}},S=()=>{h.current&&(console.log("윈도우 포커스 감지 - 평점 정보 갱신"),v(),y())};return(0,n.useEffect)(()=>{a&&t&&(console.log("데이터 로드 시작:",t,"유저 ID:",null==a?void 0:a.id),v(),_(),y(),console.log("DEBUG: 현재 사용자 상태:",a?"로그인됨":"미로그인","유저 객체:",a),console.log("DEBUG: 현재 myRating 값:",s))},[a,t]),(0,l.jsx)("div",{className:"my-4",children:(0,l.jsxs)("div",{className:"text-lg font-medium",children:["오늘 나의 평가는?",a&&null!==s&&(0,l.jsxs)("span",{className:"ml-1",children:["(",s.toFixed(1),")"]})]})})};function v(e){let{schoolCode:t,mealId:a,className:r=""}=e,[s,i]=(0,n.useState)(null),[c,d]=(0,n.useState)(0),[u,m]=(0,n.useState)(""),[g,h]=(0,n.useState)(null),f=(0,o.U)();return((0,n.useEffect)(()=>{if(async function(){if(t)try{let{data:e,error:r}=await f.from("meal_rating_stats").select("\n            avg_rating, \n            rating_count, \n            grade1_avg, \n            grade1_count,\n            grade2_avg, \n            grade2_count,\n            grade3_avg, \n            grade3_count,\n            grade4_avg, \n            grade4_count,\n            grade5_avg, \n            grade5_count,\n            grade6_avg, \n            grade6_count\n          ").eq("school_code",t).eq("meal_id",a).order("updated_at",{ascending:!1}).limit(1);if(r)return void console.error("별점 통계 데이터를 가져오는 중 오류 발생:",r);e&&e.length>0?(i(e[0].avg_rating?parseFloat(e[0].avg_rating.toFixed(1)):0),d(e[0].rating_count||0),h({grade1_avg:e[0].grade1_avg,grade1_count:e[0].grade1_count||0,grade2_avg:e[0].grade2_avg,grade2_count:e[0].grade2_count||0,grade3_avg:e[0].grade3_avg,grade3_count:e[0].grade3_count||0,grade4_avg:e[0].grade4_avg,grade4_count:e[0].grade4_count||0,grade5_avg:e[0].grade5_avg,grade5_count:e[0].grade5_count||0,grade6_avg:e[0].grade6_avg,grade6_count:e[0].grade6_count||0})):(i(0),d(0),h(null))}catch(e){console.error("별점 데이터 조회 중 오류:",e),i(0),d(0)}}(),!t||!a)return;console.log("실시간 구독 설정: meal_rating_stats:".concat(t,":").concat(a));let e=f.channel("meal_rating_stats:".concat(t,":").concat(a)).on("postgres_changes",{event:"*",schema:"public",table:"meal_rating_stats",filter:"school_code=eq.".concat(t)},e=>{console.log("실시간 업데이트 수신:",e),e.new&&(i(e.new.avg_rating?parseFloat(e.new.avg_rating.toFixed(1)):0),d(e.new.rating_count||0),h({grade1_avg:e.new.grade1_avg,grade1_count:e.new.grade1_count||0,grade2_avg:e.new.grade2_avg,grade2_count:e.new.grade2_count||0,grade3_avg:e.new.grade3_avg,grade3_count:e.new.grade3_count||0,grade4_avg:e.new.grade4_avg,grade4_count:e.new.grade4_count||0,grade5_avg:e.new.grade5_avg,grade5_count:e.new.grade5_count||0,grade6_avg:e.new.grade6_avg,grade6_count:e.new.grade6_count||0}))}).subscribe(e=>{console.log("구독 상태:",e)});return()=>{console.log("실시간 구독 해제"),f.removeChannel(e)}},[t,a,f]),s)?(0,l.jsxs)("div",{className:"flex flex-col py-1.5 px-1 ".concat(r," bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg"),children:[(0,l.jsx)("div",{className:"flex items-center justify-between",children:(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("div",{className:"bg-indigo-100 rounded-full p-1 mr-2",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-indigo-600",viewBox:"0 0 20 20",fill:"currentColor",children:(0,l.jsx)("path",{d:"M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"})})}),(0,l.jsx)("span",{className:"font-medium text-sm text-gray-700",children:"전교생 평균"}),(0,l.jsx)("span",{className:"ml-2 text-lg font-bold text-indigo-700",children:s}),(0,l.jsx)("div",{className:"flex items-center ml-1 space-x-0.5",children:(e=>{let a=[],r=Math.floor(e),n=e%1>=.5;for(let e=0;e<r;e++)a.push((0,l.jsx)("svg",{className:"w-4 h-4 text-yellow-500 fill-current",viewBox:"0 0 24 24",children:(0,l.jsx)("path",{d:"M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"})},"full-".concat(e)));if(n){let e="half-gradient-".concat(t);a.push((0,l.jsxs)("svg",{className:"w-4 h-4 text-yellow-500",viewBox:"0 0 24 24",children:[(0,l.jsx)("defs",{children:(0,l.jsxs)("linearGradient",{id:e,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[(0,l.jsx)("stop",{offset:"50%",stopColor:"currentColor",stopOpacity:"1"}),(0,l.jsx)("stop",{offset:"50%",stopColor:"currentColor",stopOpacity:"0.3"})]})}),(0,l.jsx)("path",{fill:"url(#".concat(e,")"),d:"M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"})]},"half"))}let s=5-r-!!n;for(let e=0;e<s;e++)a.push((0,l.jsx)("svg",{className:"w-4 h-4 text-gray-300 fill-current",viewBox:"0 0 24 24",children:(0,l.jsx)("path",{d:"M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"})},"empty-".concat(e)));return a})(s||0)}),(0,l.jsxs)("span",{className:"ml-1 text-xs text-gray-500",children:["(",c,"명)"]})]})}),g&&(0,l.jsx)("div",{className:"flex items-center justify-start mt-1 overflow-x-auto space-x-2 text-xs pb-1",children:[1,2,3,4,5,6].map(e=>{let t=g["grade".concat(e,"_avg")],a=g["grade".concat(e,"_count")];return t&&a>0?(0,l.jsxs)("div",{className:"flex items-center bg-white rounded-full px-1.5 py-0.5 border border-indigo-100",children:[(0,l.jsxs)("span",{className:"font-medium text-gray-600",children:["[",e,"학년]"]}),(0,l.jsx)("span",{className:"ml-1 font-bold text-indigo-600",children:t.toFixed(1)}),(0,l.jsxs)("span",{className:"ml-1 text-gray-400",children:["(",a,")"]})]},e):null})})]}):null}let y=(0,o.U)();function w(e){let{item:t}=e,[a,r]=(0,n.useState)(null);(0,n.useEffect)(()=>{(async()=>{let{data:e}=await y.auth.getUser();console.log("실제 사용자 정보:",null==e?void 0:e.user),r(null==e?void 0:e.user)})()},[]),(0,n.useEffect)(()=>{if(!t||!t.id)return;console.log("\uD83D\uDD0C menu_item_rating_stats 테이블 실시간 구독 설정 - 아이템 ID:",t.id);let e=y.channel("menu_item_rating_stats:".concat(t.id)).on("postgres_changes",{event:"*",schema:"public",table:"menu_item_rating_stats",filter:"menu_item_id=eq.".concat(t.id)},e=>{if(console.log("\uD83D\uDD04 아이템평점 실시간 업데이트 수신:",e),e.new){let t=e.new;c(t.avg_rating||0),u(t.rating_count||0),console.log("✅ 아이템평점 UI 업데이트 완료:",t.avg_rating,t.rating_count)}}).subscribe();return()=>{console.log("\uD83D\uDD0C menu_item_rating_stats 테이블 구독 해제 - 아이템 ID:",t.id),y.removeChannel(e)}},[null==t?void 0:t.id]);let[s,o]=(0,n.useState)(t.user_rating||null),[i,c]=(0,n.useState)(t.avg_rating||null),[d,u]=(0,n.useState)(t.rating_count||null),[m,g]=(0,n.useState)(!1);(0,n.useEffect)(()=>{console.log("MenuItemWithRating - 사용자 로그인 상태:",a?"로그인됨":"로그인 안됨"),a&&console.log("사용자 ID:",a.id)},[a]);let h=async(e,t)=>{try{if(!a||!a.id)return console.error("❌ 사용자 로그인 상태가 아닙니다"),alert("별점을 남기려면 로그인해주세요!"),!1;if(!e)return console.error("❌ 메뉴 아이템 ID가 없습니다"),!1;console.log("\uD83D\uDCBE 별점 저장 시도:",e,t);let{error:r}=await y.from("menu_item_ratings").upsert({user_id:a.id,menu_item_id:e,rating:t,updated_at:new Date().toISOString()},{onConflict:"user_id,menu_item_id"});if(r)return console.error("❌ 저장 오류:",r.message),!1;return console.log("✅ 별점 저장 성공!"),!0}catch(e){return console.error("❌ 별점 저장 중 오류:",e),!1}},f=async e=>{try{if(!a||!a.id)return console.error("❌ 사용자 로그인 상태가 아닙니다"),alert("별점을 남기려면 로그인해주세요!"),!1;if(!e)return console.error("❌ 메뉴 아이템 ID가 없습니다"),!1;console.log("\uD83D\uDDD1️ 별점 삭제 시도:",e);let{error:t}=await y.from("menu_item_ratings").delete().eq("user_id",a.id).eq("menu_item_id",e);if(t)return console.error("❌ 삭제 오류:",t.message),!1;console.log("\uD83D\uDD04 메뉴 아이템 별점 삭제 성공, 급식 평점 재계산 필요");let r=new CustomEvent("menu-item-rating-change",{detail:{menuItemId:e,deleted:!0}});return window.dispatchEvent(r),console.log("✅ 별점 삭제 성공!"),!0}catch(e){return console.error("❌ 별점 삭제 중 오류:",e),!1}},p=async e=>{try{if(console.log("➡️ 별점 정보 조회 시도 - 메뉴아이템 ID:",e),!e)return console.error("메뉴아이템 ID가 없습니다."),null;let{data:t,error:r}=await y.from("menu_item_ratings").select("rating").eq("menu_item_id",e);if(r)return console.error("평점 데이터 조회 오류:",r.message),null;let l=t||[],n=0;if(l.length>0){let e=l.reduce((e,t)=>e+t.rating,0)/l.length;n=Math.round(10*e)/10}let s=l.length;console.log("계산된 통계:",{avgRating:n,ratingCount:s});let o=null;if(a&&a.id){let{data:t,error:r}=await y.from("menu_item_ratings").select("rating").eq("menu_item_id",e).eq("user_id",a.id).limit(1);r?console.error("❌ 사용자 별점 조회 오류:",r.message):t&&t.length>0?(o=t[0].rating,console.log("✅ 사용자 별점 조회 성공:",o)):console.log("ℹ️ 사용자 별점 기록 없음")}else console.log("로그인되지 않아 사용자 별점을 조회하지 않습니다.");let i={avg_rating:n,rating_count:s,user_rating:o};return console.log("✅ 최종 별점 조회 결과:",i),i}catch(e){return console.error("별점 정보 조회 오류:",e),{avg_rating:0,rating_count:0,user_rating:null}}},_=async()=>{try{if(void 0!==t.user_rating){o(t.user_rating),c(t.avg_rating),u(t.rating_count);return}let e=await p(t.id);e?(o(e.user_rating),c(e.avg_rating),u(e.rating_count)):(o(null),c(0),u(0))}catch(e){console.error("별점 데이터 초기화 중 오류:",e)}};(0,n.useEffect)(()=>{t&&t.id&&_()},[t.id,a,t]);let v=async e=>{try{if(!a)return void alert("별점을 남기려면 로그인해주세요!");if(!t.id)return void console.error("메뉴 아이템 ID가 없습니다");if(console.log("⭐ 별점 선택:",e),g(!0),s===e){o(null),await f(t.id),console.log("클릭한 별점이 이미 저장된 별점과 같음, 별점 삭제 시도");let e=new CustomEvent("menu-item-rating-change",{detail:{menuItemId:t.id,deleted:!0,previousRating:s}});window.dispatchEvent(e),await f(t.id)?(console.log("별점 삭제 성공, UI 이미 업데이트됨"),setTimeout(async()=>{await p(t.id)},500)):(console.warn("별점 삭제 실패, 이전 상태 유지"),o(s),await p(t.id))}else{if(o(e),i&&d){let t=i*d,a=null===s?d+1:d,r=(null===s?t+e:t-s+e)/a;c(Math.round(10*r)/10),u(a)}else c(e),u(1);console.log("새로운 별점 저장 시도:",e);let a=new CustomEvent("menu-item-rating-change",{detail:{menuItemId:t.id,newRating:e,previousRating:s}});window.dispatchEvent(a),await h(t.id,e)?(console.log("별점 저장 성공, UI 이미 업데이트됨"),setTimeout(async()=>{await p(t.id)},500)):(console.warn("별점 저장 실패, 이전 상태로 복원"),o(s),await p(t.id))}}catch(e){console.error("별점 처리 중 오류:",e)}finally{g(!1)}};return(0,l.jsxs)("li",{className:"flex justify-between items-center py-2 border-b border-gray-100",children:[(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("div",{className:"rating-container mr-3",children:(0,l.jsx)(x,{value:s||0,onChange:v,interactive:!0,showValue:!1,size:"medium"})}),(0,l.jsx)("div",{className:"text-gray-700",children:t.item_name})]}),i&&d?(0,l.jsxs)("div",{className:"text-sm text-gray-500",children:[i.toFixed(1)," (",d,"명)"]}):null]})}function b(e){let{meal:t,onShowOrigin:a,onShowNutrition:r,onUploadSuccess:s,onUploadError:o}=e,i=(0,n.useCallback)(()=>{console.log("\uD83D\uDCE3 이미지 변경 알림 받음"),s&&s()},[s]);return(0,l.jsx)("div",{className:"bg-white overflow-hidden",children:(0,l.jsxs)("div",{className:"p-2",children:[(0,l.jsx)(v,{schoolCode:t.school_code,mealId:t.id,className:"mb-2"}),(0,l.jsx)(m,{mealId:t.id,schoolCode:t.school_code,mealDate:t.meal_date,mealType:t.meal_type,onUploadSuccess:i,onUploadError:o},"uploader-".concat(t.id,"-").concat(t.meal_date)),(0,l.jsxs)("div",{className:"flex justify-between items-center my-2 text-xs",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[t.origin_info&&(0,l.jsx)("button",{onClick:()=>a(t.origin_info),className:"text-xs px-1 py-0.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors",children:"원산지"}),(t.kcal||t.ntr_info)&&(0,l.jsx)("button",{onClick:()=>r(t),className:"text-xs px-1 py-0.5 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors",children:"영양정보"})]}),t.kcal&&(0,l.jsxs)("div",{className:"bg-orange-100 text-orange-800 text-xs px-1.5 py-0.5 rounded",children:[t.kcal,"kcal"]})]}),(0,l.jsx)("div",{className:"mt-3",children:(0,l.jsx)(_,{mealId:t.id})}),(0,l.jsx)("div",{className:"mb-2",children:(0,l.jsx)("ul",{className:"space-y-2",children:t.menuItems&&t.menuItems.length>0?t.menuItems.map(e=>(0,l.jsx)(w,{item:e},e.id)):t.menu_items.map((e,t)=>(0,l.jsx)("li",{className:"text-gray-700",children:e},t))})})]})})}console.log("MealCard 컴포넌트 로드됨, Supabase 클라이언트 초기화");let j=e=>{if(!e)return e;let t=e;8!==e.length||e.includes("-")||(t="".concat(e.slice(0,4),"-").concat(e.slice(4,6),"-").concat(e.slice(6,8)));let a=new Date(t);if(isNaN(a.getTime()))return t;let r=["일","월","화","수","목","금","토"][a.getDay()];return"".concat(t," (").concat(r,")")},N=e=>e?8!==e.length||e.includes("-")?e.replace(/-/g,""):(console.log("이미 API 형식인 날짜: ".concat(e)),e):"",S=()=>{let e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return"".concat(t,"-").concat(a,"-").concat(r)};async function k(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=void 0!==r?r:fetch;try{if((e.includes("/rest/v1/")||e.includes("izkumvvlkrkgiuuczffp.supabase.co/rest/v1/"))&&!e.includes("apikey="))if(["/meal_images","/profiles","/menu_item_ratings"].some(t=>e.includes(t)))console.debug("예외 처리 엔드포인트 요청 허용 (fetchWithAuth):",e);else{let a=!1;if(t.headers&&(a=t.headers instanceof Headers?t.headers.has("apikey")||t.headers.has("authorization"):Object.entries(t.headers).some(e=>{let[t,a]=e;return"string"==typeof t&&("apikey"===t.toLowerCase()||"authorization"===t.toLowerCase())})),!a)return console.warn("API 키 없는 요청 차단 (fetchWithAuth):",e,t.headers),new Response(JSON.stringify({error:"No API key found in request",message:"API 키가 필요한 요청입니다. 인증 정보를 확인하세요. (Generated by fetchWithAuth)"}),{status:401})}let r=await a(e,t);if((404===r.status||406===r.status)&&(e.includes("/meal_images")||e.includes("/comment_likes")))return console.debug("".concat(r.status," 오류 정상 처리 - ").concat(e.includes("/meal_images")?"이미지":"좋아요"," 요청:"),e),new Response(JSON.stringify({data:e.includes("select=id")?null:[]}),{status:200,headers:{"Content-Type":"application/json"}});if(406===r.status&&"undefined"!=typeof navigator&&navigator.userAgent&&(navigator.userAgent.includes("Whale")||navigator.userAgent.includes("NAVER")))return console.debug("웨일 브라우저 특수 406 오류 정상 처리:",e),new Response(JSON.stringify({data:[]}),{status:200,headers:{"Content-Type":"application/json"}});return r}catch(e){return console.error("API 요청 오류:",e),new Response(JSON.stringify({error:"API request failed",message:"네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요."}),{status:500})}}r=window.fetch,window.fetch=function(e,t){let a="";try{a="string"==typeof e?e:e instanceof URL?e.toString():e.url}catch(t){console.debug("URL 추출 오류, 문자열로 변환 시도:",t),a=String(e)}if(a.includes("izkumvvlkrkgiuuczffp.supabase.co/rest/v1/")){let l=["/meal_images","/profiles","/menu_item_ratings","/comment_likes"].some(e=>a.includes(e)),n="undefined"!=typeof navigator&&navigator.userAgent&&(navigator.userAgent.includes("Whale")||navigator.userAgent.includes("NAVER"));if(l)return console.debug("예외 처리 엔드포인트 요청 허용 ".concat(n?"(웨일 브라우저)":""," (api-helper.ts):"),a),n&&(t||(t={}),t.headers||(t.headers={}),t.headers instanceof Headers?t.headers.has("Accept")||t.headers.set("Accept","application/json"):t.headers={...t.headers,Accept:"application/json"}),r(e,t);let s=!1;try{(null==t?void 0:t.headers)&&(t.headers instanceof Headers?s=t.headers.has("apikey")||t.headers.has("authorization"):"object"==typeof t.headers&&(s=Object.keys(t.headers).some(e=>"string"==typeof e&&("apikey"===e.toLowerCase()||"authorization"===e.toLowerCase()))))}catch(e){console.debug("API 키 헤더 검증 중 오류 (무시됨):",e),s=!0}if(!s)return console.debug("권한 없는 Supabase REST API 요청 차단 (api-helper.ts):",a,null==t?void 0:t.headers),Promise.resolve(new Response(JSON.stringify({message:"No API key found in request",hint:"No 'apikey' request header or url param was found. (Generated by api-helper.ts)"}),{status:401}))}return r(e,t)};let C={MEALS:"/api/meals"};function E(e){let{onSubmit:t,placeholder:a="댓글 추가...",buttonText:r="댓글"}=e,[s,i]=(0,n.useState)(""),[c,d]=(0,n.useState)(!1),[u,m]=(0,n.useState)(!1),g=(0,n.useRef)(null),[h,f]=(0,n.useState)(null),[x,p]=(0,n.useState)("?"),_=(0,o.U)();(0,n.useEffect)(()=>{(async()=>{try{let{data:{session:a}}=await _.auth.getSession();if(null==a?void 0:a.user){var e,t;f((null==(e=a.user.user_metadata)?void 0:e.avatar_url)||null),p(((null==(t=a.user.email)?void 0:t.charAt(0))||"?").toUpperCase())}}catch(e){console.error("사용자 정보 로드 실패:",e)}})()},[_]),(0,n.useEffect)(()=>{g.current&&(g.current.style.height="auto",g.current.style.height="".concat(g.current.scrollHeight,"px"))},[s]);let v=async e=>{if(e.preventDefault(),s.trim()&&!c)try{d(!0),await t(s)&&(i(""),m(!1),g.current&&(g.current.style.height="auto"))}finally{d(!1)}};return(0,l.jsxs)("div",{className:"flex items-start gap-3",children:[(0,l.jsx)("div",{className:"flex-shrink-0 w-8 h-8 overflow-hidden rounded-full",children:h?(0,l.jsx)("img",{src:h,alt:"프로필",className:"w-full h-full object-cover",onError:e=>{e.target.src="/default-avatar.png"}}):(0,l.jsx)("div",{className:"w-full h-full bg-gray-200 flex items-center justify-center text-gray-500",children:x})}),(0,l.jsxs)("form",{onSubmit:v,className:"flex-grow",children:[(0,l.jsx)("div",{className:"border-b ".concat(u?"border-black":"border-gray-300"," transition-all duration-200"),children:(0,l.jsx)("textarea",{ref:g,value:s,onChange:e=>i(e.target.value),onFocus:()=>m(!0),placeholder:a,className:"w-full p-2 focus:outline-none resize-none overflow-hidden min-h-[36px]",rows:1})}),u&&(0,l.jsxs)("div",{className:"mt-2 flex justify-end gap-2",children:[(0,l.jsx)("button",{type:"button",onClick:()=>{i(""),m(!1),g.current&&(g.current.blur(),g.current.style.height="auto")},className:"px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-full",children:"취소"}),(0,l.jsx)("button",{type:"submit",disabled:!s.trim()||c,className:"px-3 py-1.5 text-sm font-medium rounded-full ".concat(!s.trim()||c?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"),children:c?"게시 중...":r})]})]})]})}var I=a(8881),L=a(2404);function A(e){let{count:t,isLiked:a,onToggle:r,disabled:n=!1}=e;return(0,l.jsxs)("button",{onClick:e=>{e.preventDefault(),e.stopPropagation(),r()},disabled:n,className:"flex items-center ".concat(n?"opacity-50 cursor-not-allowed":""),"aria-label":a?"좋아요 취소":"좋아요",children:[(0,l.jsx)("span",{className:"mr-1 flex items-center justify-center w-5 h-5",children:a?(0,l.jsx)("svg",{viewBox:"0 0 24 24",className:"w-5 h-5 fill-blue-600",children:(0,l.jsx)("path",{d:"M7,22 L3,22 L3,10 L7,10 L7,22 Z M19.7507342,10.4137392 L14.2618608,10.4137392 L14.9110375,6.35765469 C15.1310205,4.93928291 14.06216,3.66896766 12.7595814,3.18316087 C12.5176311,3.09761964 12.2590594,3.04519397 12,3.04519397 C11.3357497,3.04519397 10.738532,3.43708398 10.4594998,4.02922829 L7.1282278,10 L10,10 L10,19.5 C10.8370479,19.5 11.5426519,19.5 12.0000108,19.5 C12.5624172,19.5 13.1374733,19.4344721 13.7251792,19.3033241 C14.5511793,19.1178695 21,17.9572276 21,17.9572276 L21,12.0643062 C21,12.0643062 20.7096832,10.7093823 19.7507342,10.4137392 Z"})}):(0,l.jsx)("svg",{viewBox:"0 0 24 24",className:"w-5 h-5 stroke-gray-500 fill-none",strokeWidth:"1.5",children:(0,l.jsx)("path",{d:"M7,22 L3,22 L3,10 L7,10 L7,22 Z M19.7507342,10.4137392 L14.2618608,10.4137392 L14.9110375,6.35765469 C15.1310205,4.93928291 14.06216,3.66896766 12.7595814,3.18316087 C12.5176311,3.09761964 12.2590594,3.04519397 12,3.04519397 C11.3357497,3.04519397 10.738532,3.43708398 10.4594998,4.02922829 L7.1282278,10 L10,10 L10,19.5 C10.8370479,19.5 11.5426519,19.5 12.0000108,19.5 C12.5624172,19.5 13.1374733,19.4344721 13.7251792,19.3033241 C14.5511793,19.1178695 21,17.9572276 21,17.9572276 L21,12.0643062 C21,12.0643062 20.7096832,10.7093823 19.7507342,10.4137392 Z"})})}),(0,l.jsx)("span",{className:"text-xs text-gray-700",children:t})]})}function R(e){var t,a,r;let{onSubmit:s,autoFocus:c=!0,placeholder:d="답글 추가...",buttonText:u="답글"}=e,[m,g]=(0,n.useState)(""),[h,f]=(0,n.useState)(!1),[x,p]=(0,n.useState)(!1),_=(0,n.useRef)(null),{user:v}=i();(0,o.U)();let[y,w]=(0,n.useState)({});(0,n.useEffect)(()=>{if(v){var e,t;w({avatarUrl:null==(e=v.user_metadata)?void 0:e.avatar_url,name:null==(t=v.user_metadata)?void 0:t.name,email:v.email})}},[v]),(0,n.useEffect)(()=>{_.current&&(_.current.style.height="auto",_.current.style.height="".concat(_.current.scrollHeight,"px"))},[m]),(0,n.useEffect)(()=>{c&&_.current&&(_.current.focus(),p(!0))},[c]);let b=async e=>{if(e.preventDefault(),m.trim()&&!h)try{f(!0),await s(m)&&(g(""),p(!1),_.current&&(_.current.style.height="auto"))}finally{f(!1)}};return(0,l.jsxs)("div",{className:"flex items-start gap-2 mt-2",children:[(0,l.jsx)("div",{className:"flex-shrink-0 w-6 h-6 overflow-hidden rounded-full",children:y.avatarUrl?(0,l.jsx)("img",{src:y.avatarUrl,alt:"프로필",className:"w-full h-full object-cover",onError:e=>{e.target.src="/default-avatar.png"}}):(0,l.jsx)("div",{className:"w-full h-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs",children:(null==(t=y.name)?void 0:t[0])||(null==(r=y.email)||null==(a=r[0])?void 0:a.toUpperCase())||"?"})}),(0,l.jsxs)("form",{onSubmit:b,className:"flex-grow",children:[(0,l.jsx)("div",{className:"border-b ".concat(x?"border-black":"border-gray-300"," transition-all duration-200"),children:(0,l.jsx)("textarea",{ref:_,value:m,onChange:e=>g(e.target.value),onKeyDown:e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),b(e))},onFocus:()=>p(!0),placeholder:d,className:"w-full p-2 focus:outline-none resize-none overflow-hidden min-h-[36px] text-sm",rows:1})}),x&&(0,l.jsxs)("div",{className:"mt-2 flex justify-end gap-2",children:[(0,l.jsx)("button",{type:"button",onClick:()=>{g(""),p(!1),_.current&&(_.current.blur(),_.current.style.height="auto")},className:"px-3 py-1 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-full",children:"취소"}),(0,l.jsx)("button",{type:"submit",disabled:!m.trim()||h,className:"px-3 py-1 text-sm font-medium rounded-full ".concat(!m.trim()||h?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"),children:h?"게시 중...":u})]})]})]})}function T(e){var t,a,r,s,c,d;let{reply:u,onReplyChange:m,schoolCode:g}=e,[h,f]=(0,n.useState)(!1),[x,p]=(0,n.useState)(u.content),[_,v]=(0,n.useState)(u.user_has_liked),[y,w]=(0,n.useState)(u.likes_count),[b,j]=(0,n.useState)(!1),[N,S]=(0,n.useState)(!1),[k,C]=(0,n.useState)(!1);(0,n.useEffect)(()=>{if(!u.id)return;let e=q.channel("reply-likes-insert-".concat(u.id)).on("postgres_changes",{event:"INSERT",schema:"public",table:"reply_likes",filter:"reply_id=eq.".concat(u.id)},e=>{console.log("답글 좋아요 추가:",e),O()}).subscribe(),t=q.channel("reply-likes-delete-".concat(u.id)).on("postgres_changes",{event:"DELETE",schema:"public",table:"reply_likes"},e=>{console.log("답글 좋아요 삭제:",e);let t=e.old;t&&t.reply_id===u.id&&O()}).subscribe();return()=>{q.removeChannel(e),q.removeChannel(t)}},[u.id]),(0,n.useEffect)(()=>{let e=e=>{e.target.closest(".reply-menu")||S(!1)};return document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}},[]);let{user:E,userSchool:T}=i(),q=(0,o.U)(),M=T&&g&&T.school_code===g,z=E&&E.id===u.user_id,U=(0,I.A)(new Date(u.created_at),{addSuffix:!0,locale:L.A}),D=async e=>{if(e.preventDefault(),x.trim()&&E&&z)try{let{error:e}=await q.from("comment_replies").update({content:x.trim(),updated_at:new Date().toISOString()}).eq("id",u.id);if(e)throw e;f(!1),m()}catch(e){console.error("답글 수정 중 오류:",e)}},P=async()=>{if(E&&z&&window.confirm("정말로 이 답글을 삭제하시겠습니까?"))try{let{error:e}=await q.from("comment_replies").delete().eq("id",u.id);if(e)throw e;m()}catch(e){console.error("답글 삭제 중 오류:",e)}},O=async()=>{try{let{count:e,error:t}=await q.from("reply_likes").select("*",{count:"exact",head:!0}).eq("reply_id",u.id);if(t)throw t;if(E&&E.id){let{data:e,error:t}=await q.from("reply_likes").select("id").eq("reply_id",u.id).eq("user_id",E.id).maybeSingle();!t&&e?v(!0):v(!1)}w(e||0)}catch(e){console.error("답글 좋아요 개수 가져오기 오류:",e)}},B=async()=>{if(E&&E.id&&!b){j(!0);try{let e=!_;if(v(e),w(t=>e?t+1:t-1),_){let{error:t}=await q.from("reply_likes").delete().eq("reply_id",u.id).eq("user_id",E.id);if(t)throw v(!e),w(t=>e?t-1:t+1),t}else{let{error:t}=await q.from("reply_likes").insert({reply_id:u.id,user_id:E.id});if(t)throw v(!e),w(t=>e?t-1:t+1),t}}catch(e){console.error("좋아요 처리 중 오류:",e)}finally{j(!1)}}},F=async e=>{if(!E||!e.trim())return!1;try{let{data:t,error:a}=await q.from("comment_replies").insert({comment_id:u.comment_id,user_id:E.id,content:e.trim(),parent_id:u.id});if(a)throw a;return m(),C(!1),!0}catch(e){return console.error("답글 작성 중 오류:",e),!1}};return(0,l.jsx)("div",{className:"py-2 pl-8 border-l border-gray-200",children:h?(0,l.jsxs)("form",{onSubmit:D,className:"mt-2",children:[(0,l.jsx)("input",{type:"text",value:x,onChange:e=>p(e.target.value),className:"w-full p-2 border border-gray-300 rounded",autoFocus:!0}),(0,l.jsxs)("div",{className:"mt-2 flex space-x-2",children:[(0,l.jsx)("button",{type:"submit",className:"px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600",children:"저장"}),(0,l.jsx)("button",{type:"button",onClick:()=>{f(!1),p(u.content)},className:"px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300",children:"취소"})]})]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"flex items-start",children:[(0,l.jsx)("div",{className:"mr-2",children:(null==(t=u.user.user_metadata)?void 0:t.avatar_url)?(0,l.jsx)("img",{src:u.user.user_metadata.avatar_url,alt:"프로필",className:"w-5 h-5 rounded-full"}):(0,l.jsx)("div",{className:"w-5 h-5 bg-gray-200 rounded-full flex items-center justify-center",children:(0,l.jsx)("span",{className:"text-xs text-gray-500",children:(null==(r=u.user.user_metadata)||null==(a=r.name)?void 0:a[0])||(null==(s=u.user.email[0])?void 0:s.toUpperCase())||"?"})})}),(0,l.jsxs)("div",{className:"flex-1",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-xs text-gray-700",children:(null==(c=u.user.user_metadata)?void 0:c.name)||(null==(d=u.user.email)?void 0:d.split("@")[0])||"사용자"}),(0,l.jsx)("span",{className:"ml-2 text-xs text-gray-400",children:U})]}),z&&!h&&(0,l.jsxs)("div",{className:"relative reply-menu",children:[(0,l.jsx)("button",{onClick:e=>{e.stopPropagation(),S(!N)},className:"text-gray-500 hover:text-gray-700 p-1",children:(0,l.jsx)("span",{className:"text-xl leading-none",children:"⋮"})}),N&&(0,l.jsxs)("div",{className:"absolute right-0 top-6 bg-white shadow-md rounded-md py-1 z-10 w-20",children:[(0,l.jsx)("button",{onClick:()=>{f(!0),S(!1)},className:"w-full text-left px-3 py-1 text-xs hover:bg-gray-100 text-gray-700",children:"수정"}),(0,l.jsx)("button",{onClick:()=>{P(),S(!1)},className:"w-full text-left px-3 py-1 text-xs hover:bg-gray-100 text-red-500",children:"삭제"})]})]})]}),(0,l.jsx)("p",{className:"mt-1 text-sm font-medium break-words whitespace-pre-wrap",children:u.content}),(0,l.jsxs)("div",{className:"mt-1 flex items-center gap-3",children:[(0,l.jsx)(A,{count:y,isLiked:_,onToggle:E&&M?B:()=>{alert("해당 학교 학생만 좋아요를 할 수 있습니다.")},disabled:b}),E&&M&&(0,l.jsxs)("button",{onClick:()=>C(!k),className:"text-gray-500 hover:text-gray-700 flex items-center gap-1",title:"답글 작성",children:[(0,l.jsx)("svg",{viewBox:"0 0 24 24",className:"w-4 h-4 fill-current",children:(0,l.jsx)("path",{d:"M3,17.25 L3,21 L6.75,21 L17.81,9.94 L14.06,6.19 L3,17.25 Z M21.41,6.34 L17.66,2.59 C17.2706655,2.20798298 16.6593396,2.20857968 16.27,2.59 L13.13,5.73 L16.88,9.48 L20.02,6.34 C20.4,5.96 20.4,5.34 20.02,4.96 L21.41,6.34 Z"})}),(0,l.jsx)("span",{className:"text-xs",children:k?"취소":"답글"})]})]})]})]}),k&&E&&M&&(0,l.jsx)("div",{className:"mt-2",children:(0,l.jsx)(R,{onSubmit:F,placeholder:"답글 추가...",buttonText:"답글"})})]})})}function q(e){var t,a,r,s,c,d,u;let{comment:m,onCommentChange:g,schoolCode:h}=e,[f,x]=(0,n.useState)(!1),[p,_]=(0,n.useState)(m.content),[v,y]=(0,n.useState)(!1),[w,b]=(0,n.useState)(!1),[j,N]=(0,n.useState)(m.user_has_liked),[S,k]=(0,n.useState)(m.likes_count),[C,E]=(0,n.useState)(!1),[q,M]=(0,n.useState)([]),[z,U]=(0,n.useState)(m.replies_count),[D,P]=(0,n.useState)(!1),{user:O,userSchool:B}=i(),F=(0,o.U)(),J=B&&h&&B.school_code===h,W=O&&O.id===m.user_id,Z=(0,I.A)(new Date(m.created_at),{addSuffix:!0,locale:L.A}),V=async()=>{try{let{count:e,error:t}=await F.from("comment_likes").select("*",{count:"exact",head:!0}).eq("comment_id",m.id);if(t)throw t;k(e||0)}catch(e){console.error("댓글 좋아요 개수 가져오기 오류:",e)}},G=async()=>{if(O&&O.id)try{let{data:e,error:t}=await F.from("comment_likes").select("id").eq("comment_id",m.id).eq("user_id",O.id).maybeSingle();N(!t&&!!e)}catch(e){console.debug("좋아요 여부 확인 중 오류 무시:",e),N(!1)}},H=async()=>{if(O&&O.id&&!C){E(!0);try{let e=!j;if(N(e),k(t=>e?t+1:Math.max(0,t-1)),e){let{error:e}=await F.from("comment_likes").insert({comment_id:m.id,user_id:O.id});e&&(console.error("좋아요 추가 오류:",e),N(!1),k(e=>Math.max(0,e-1)))}else{let{error:e}=await F.from("comment_likes").delete().eq("comment_id",m.id).eq("user_id",O.id);e&&(console.error("좋아요 취소 오류:",e),N(!0),k(e=>e+1))}V()}catch(e){console.error("좋아요 처리 중 오류:",e)}finally{E(!1)}}};(0,n.useEffect)(()=>{if(!m.id)return;let e=F.channel("comment-likes-all-".concat(m.id)).on("postgres_changes",{event:"*",schema:"public",table:"comment_likes"},e=>{if(console.log("댓글 좋아요 변경:",e),"DELETE"===e.eventType){let t=e.old;if(t&&t.comment_id===m.id&&O&&t.user_id===O.id)return}else if("INSERT"===e.eventType){let t=e.new;if(t&&t.comment_id===m.id){if(O&&t.user_id===O.id)return;V(),O&&G()}}}).subscribe();return()=>{F.removeChannel(e)}},[m.id,O]);let Q=async()=>{if(W&&p.trim())try{let{error:e}=await F.from("comments").update({content:p.trim(),updated_at:new Date().toISOString()}).eq("id",m.id);if(e)throw e;x(!1),g()}catch(e){console.error("댓글 수정 중 오류:",e)}},X=async()=>{if(O&&W&&window.confirm("정말로 이 댓글을 삭제하시겠습니까?"))try{let{error:e}=await F.from("comments").delete().eq("id",m.id);if(e)throw e;g()}catch(e){console.error("댓글 삭제 중 오류:",e)}},$=async()=>{if(m.id&&!D)try{P(!0);let{data:e,error:t}=await F.from("comment_replies").select("id, content, created_at, user_id, comment_id").eq("comment_id",m.id).eq("is_deleted",!1).order("created_at",{ascending:!0});if(t)throw t;let a=[];if(e&&e.length>0){let t=e.map(e=>e.user_id),{data:r,error:l}=await F.from("users").select("id, email, nickname, profile_image").in("id",t);l?console.error("사용자 정보 가져오기 오류:",l):a=r||[]}let r=e.map(e=>e.id),l={};if(r.length>0){let{data:e,error:t}=await F.from("reply_likes").select("reply_id").in("reply_id",r);if(t)throw t;l=e.reduce((e,t)=>(e[t.reply_id]=(e[t.reply_id]||0)+1,e),{})}let n={};if(O&&O.id&&r.length>0){let{data:e,error:t}=await F.from("reply_likes").select("reply_id").in("reply_id",r).eq("user_id",O.id);if(t)throw t;n=(e||[]).reduce((e,t)=>(e[t.reply_id]=!0,e),{})}let s=e.map(e=>{let t=a.find(t=>t.id===e.user_id)||null;return{id:e.id,content:e.content,created_at:e.created_at,user_id:e.user_id,comment_id:e.comment_id,user:{id:(null==t?void 0:t.id)||e.user_id||"",email:(null==t?void 0:t.email)||"",user_metadata:{name:(null==t?void 0:t.nickname)||"",avatar_url:(null==t?void 0:t.profile_image)||""}},likes_count:l[e.id]||0,user_has_liked:!!n[e.id]}});M(s),U(s.length)}catch(e){console.error("답글 불러오기 오류:",e)}finally{P(!1)}},K=async e=>{if(!O||!O.id||!m.id||!e.trim())return!1;try{let{error:t}=await F.from("comment_replies").insert({comment_id:m.id,user_id:O.id,content:e.trim()});if(t)throw t;return await $(),U(e=>e+1),g(),!0}catch(e){return console.error("답글 추가 중 오류:",e),!1}},Y=()=>{$()},ee=async()=>{if(m.id)try{let{data:e,error:t}=await F.from("comment_replies").select("id").eq("comment_id",m.id).eq("is_deleted",!1);!t&&e&&U(e.length)}catch(e){console.error("답글 개수 가져오기 오류:",e)}};(0,n.useEffect)(()=>{U(m.replies_count),N(m.user_has_liked),k(m.likes_count),O&&O.id&&(G(),V())},[m.replies_count,m.user_has_liked,m.likes_count,O]),(0,n.useEffect)(()=>{if(!m.id)return;let e=F.channel("replies-insert-".concat(m.id)).on("postgres_changes",{event:"INSERT",schema:"public",table:"comment_replies",filter:"comment_id=eq.".concat(m.id)},e=>{console.log("답글 추가:",e),ee(),v&&$()}).subscribe(),t=F.channel("replies-delete-".concat(m.id)).on("postgres_changes",{event:"DELETE",schema:"public",table:"comment_replies"},e=>{console.log("답글 삭제:",e);let t=e.old;t&&(t.comment_id,m.id)}).subscribe(),a=F.channel("replies-update-".concat(m.id)).on("postgres_changes",{event:"UPDATE",schema:"public",table:"comment_replies",filter:"comment_id=eq.".concat(m.id)},e=>{console.log("답글 업데이트:",e),ee(),v&&$()}).subscribe(),r=F.channel("reply-likes-for-comment-".concat(m.id)).on("postgres_changes",{event:"*",schema:"public",table:"reply_likes"},e=>{let t=e.new,a=e.old,r=(null==t?void 0:t.reply_id)||(null==a?void 0:a.reply_id);v&&r&&q.some(e=>e.id===r)&&(console.log("답글 좋아요 변경:",e),$())}).subscribe();return()=>{F.removeChannel(e),F.removeChannel(t),F.removeChannel(a),F.removeChannel(r)}},[m.id,v,q,O]);let[et,ea]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{let e=e=>{e.target.closest(".comment-menu")||ea(!1)};return document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}},[]),(0,l.jsx)("div",{className:"bg-white p-4 rounded-lg shadow-sm border border-gray-100",children:(0,l.jsxs)("div",{className:"flex flex-col",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("div",{className:"flex-shrink-0",children:(null==(a=m.user)||null==(t=a.user_metadata)?void 0:t.avatar_url)?(0,l.jsx)("img",{src:m.user.user_metadata.avatar_url,alt:"프로필",className:"h-6 w-6 rounded-full"}):(0,l.jsx)("div",{className:"h-6 w-6 rounded-full bg-gray-200 flex items-center justify-center",children:(0,l.jsx)("span",{className:"text-gray-500 text-xs",children:(null==(c=m.user)||null==(s=c.user_metadata)||null==(r=s.name)?void 0:r.charAt(0))||"?"})})}),(0,l.jsxs)("div",{className:"ml-2",children:[(0,l.jsx)("span",{className:"text-xs text-gray-700",children:(null==(u=m.user)||null==(d=u.user_metadata)?void 0:d.name)||"익명"}),(0,l.jsx)("span",{className:"ml-2 text-xs text-gray-400",children:Z})]})]}),W&&!f&&(0,l.jsxs)("div",{className:"relative comment-menu",children:[(0,l.jsx)("button",{onClick:e=>{e.stopPropagation(),ea(!et)},className:"text-gray-500 hover:text-gray-700 p-1",children:(0,l.jsx)("span",{className:"text-xl leading-none",children:"⋮"})}),et&&(0,l.jsxs)("div",{className:"absolute right-0 top-6 bg-white shadow-md rounded-md py-1 z-10 w-20",children:[(0,l.jsx)("button",{onClick:()=>{x(!0),ea(!1)},className:"w-full text-left px-3 py-1 text-xs hover:bg-gray-100 text-gray-700",children:"수정"}),(0,l.jsx)("button",{onClick:()=>{X(),ea(!1)},className:"w-full text-left px-3 py-1 text-xs hover:bg-gray-100 text-red-500",children:"삭제"})]})]})]}),f?(0,l.jsxs)("div",{className:"mt-2",children:[(0,l.jsx)("textarea",{value:p,onChange:e=>_(e.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",rows:3}),(0,l.jsxs)("div",{className:"mt-2 flex justify-end space-x-2",children:[(0,l.jsx)("button",{onClick:()=>x(!1),className:"px-3 py-1 text-xs text-gray-600 hover:text-gray-900",children:"취소"}),(0,l.jsx)("button",{onClick:Q,className:"px-3 py-1 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600",children:"저장"})]})]}):(0,l.jsx)("p",{className:"mt-2 text-sm font-medium text-gray-800 whitespace-pre-wrap break-words",children:m.content}),(0,l.jsx)("div",{className:"mt-2 flex items-center",children:(0,l.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,l.jsx)(A,{count:S,isLiked:j,onToggle:O&&J?H:()=>{alert("해당 학교 학생만 좋아요를 할 수 있습니다.")},disabled:C}),z>0?(0,l.jsx)("button",{onClick:()=>{v||0!==q.length||$(),y(!v)},className:"text-sm text-gray-600 hover:text-gray-900 flex items-center",children:(0,l.jsxs)("span",{children:["답글 ",z,"개>"]})}):(0,l.jsx)("button",{onClick:()=>{v||0!==q.length||$(),y(!v)},className:"text-sm text-gray-600 hover:text-gray-900 flex items-center opacity-0 hover:opacity-50",children:(0,l.jsx)("span",{children:"답글 >"})}),O&&J&&(0,l.jsxs)("button",{className:"text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1",onClick:()=>{b(!w),v||(y(!0),0===q.length&&$())},title:"답글 작성",children:[(0,l.jsx)("svg",{viewBox:"0 0 24 24",className:"w-4 h-4 fill-current",children:(0,l.jsx)("path",{d:"M3,17.25 L3,21 L6.75,21 L17.81,9.94 L14.06,6.19 L3,17.25 Z M21.41,6.34 L17.66,2.59 C17.2706655,2.20798298 16.6593396,2.20857968 16.27,2.59 L13.13,5.73 L16.88,9.48 L20.02,6.34 C20.4,5.96 20.4,5.34 20.02,4.96 L21.41,6.34 Z"})}),(0,l.jsxs)("span",{className:"text-xs",children:["답글 ",w?"접기":"작성"]})]})]})}),v&&(0,l.jsxs)("div",{className:"mt-1 ml-5 pl-3 relative",children:[(0,l.jsx)("div",{className:"absolute left-0 top-0 h-full",style:{width:"16px"},children:(0,l.jsx)("svg",{width:"16",height:"100%",className:"overflow-visible",children:(0,l.jsx)("path",{d:"M1,0 L1,100% Q1,100% 9,100%",stroke:"#e5e7eb",strokeWidth:"1.5",fill:"none"})})}),w&&O&&J&&(0,l.jsx)(R,{onSubmit:K}),D?(0,l.jsx)("p",{className:"text-sm text-gray-500 py-2",children:"답글을 불러오는 중..."}):q.length>0?(0,l.jsx)("div",{className:"space-y-2 my-2",children:q.map(e=>(0,l.jsx)(T,{reply:e,onReplyChange:Y,schoolCode:h},e.id))}):null]})]})})}function M(e){let{mealId:t,className:a="",schoolCode:r}=e,[s,c]=(0,n.useState)([]),[d,u]=(0,n.useState)(!0),[m,g]=(0,n.useState)(null),[h,f]=(0,n.useState)(0),[x,p]=(0,n.useState)(!0),{user:_,userSchool:v}=i(),y=v&&r&&v.school_code===r,w=(0,o.U)(),b=async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(t)try{u(!0);let a=e?0:h,{data:r,error:l}=await w.from("comments").select("id, content, created_at, user_id").eq("meal_id",t).eq("is_deleted",!1).order("created_at",{ascending:!1}).range(10*a,(a+1)*10-1),n=[];if(r&&r.length>0){let e=r.map(e=>e.user_id),{data:t,error:a}=await w.from("users").select("id, email, nickname, profile_image").in("id",e);a?console.error("사용자 정보 가져오기 오류:",a):n=t||[]}if(l)throw l;let s=r.map(e=>e.id),o={};if(s.length>0){let{data:e,error:t}=await w.from("comment_likes").select("comment_id").in("comment_id",s);if(t)throw t;o=e.reduce((e,t)=>(e[t.comment_id]=(e[t.comment_id]||0)+1,e),{})}let i={};if(_&&_.id&&s.length>0){let{data:e,error:t}=await w.from("comment_likes").select("comment_id").in("comment_id",s).eq("user_id",_.id);if(t)throw t;i=(e||[]).reduce((e,t)=>(e[t.comment_id]=!0,e),{})}let d={};if(s.length>0){let{data:e,error:t}=await w.from("comment_replies").select("comment_id").in("comment_id",s).eq("is_deleted",!1);if(t)throw t;d=e.reduce((e,t)=>(e[t.comment_id]=(e[t.comment_id]||0)+1,e),{})}let m=r.map(e=>{let t=n.find(t=>t.id===e.user_id)||null;return{id:e.id,content:e.content,created_at:e.created_at,user_id:e.user_id,user:{id:(null==t?void 0:t.id)||e.user_id||"",email:(null==t?void 0:t.email)||"",user_metadata:{name:(null==t?void 0:t.nickname)||"",avatar_url:(null==t?void 0:t.profile_image)||""}},likes_count:o[e.id]||0,user_has_liked:!!i[e.id],replies_count:d[e.id]||0}});e?c(m):c(e=>[...e,...m]),p(10===m.length),f(e?1:a+1)}catch(e){console.error("댓글 로드 중 오류:",e),g("댓글을 불러오는 중 문제가 발생했습니다.")}finally{u(!1)}};(0,n.useEffect)(()=>{t&&b(!0)},[t]),(0,n.useEffect)(()=>{if(!t)return;let e=w.channel("comments-insert-".concat(t)).on("postgres_changes",{event:"INSERT",schema:"public",table:"comments",filter:"meal_id=eq.".concat(t)},e=>{console.log("댓글 추가:",e),b(!0)}).subscribe(),a=w.channel("comments-delete-".concat(t)).on("postgres_changes",{event:"DELETE",schema:"public",table:"comments"},e=>{console.log("댓글 삭제:",e);let a=e.old;a&&a.meal_id===t&&b(!0)}).subscribe(),r=w.channel("comments-update-".concat(t)).on("postgres_changes",{event:"UPDATE",schema:"public",table:"comments",filter:"meal_id=eq.".concat(t)},e=>{console.log("댓글 수정:",e),b(!0)}).subscribe(),l=w.channel("comment-likes-insert-".concat(t)).on("postgres_changes",{event:"INSERT",schema:"public",table:"comment_likes"},e=>{console.log("댓글 좋아요 추가:",e),b(!0)}).subscribe(),n=w.channel("comment-likes-delete-".concat(t)).on("postgres_changes",{event:"DELETE",schema:"public",table:"comment_likes"},e=>{console.log("댓글 좋아요 삭제:",e);let t=e.old;t&&t.comment_id&&s.map(e=>e.id).includes(t.comment_id)&&b(!0)}).subscribe();return()=>{w.removeChannel(e),w.removeChannel(a),w.removeChannel(r),w.removeChannel(l),w.removeChannel(n)}},[t]);let j=async e=>{if(!_||!_.id||!t||!e.trim())return!1;try{console.log("댓글 추가 시도:",{mealId:t,userId:_.id,content:e.trim()});let{error:a}=await w.from("comments").insert({meal_id:t,user_id:_.id,content:e.trim()});if(a)throw console.error("댓글 추가 SQL 오류:",a),a;return console.log("댓글 추가 성공, 새로고침 시도"),await b(!0),!0}catch(e){return console.error("댓글 추가 중 오류:",e),g("댓글을 추가하는 중 문제가 발생했습니다."),!1}};return(0,l.jsxs)("div",{className:"mt-4 ".concat(a),children:[(0,l.jsx)("h3",{className:"text-lg font-bold mb-4",children:"댓글"}),d?(0,l.jsx)("p",{className:"text-gray-500 mb-4",children:"로딩 중..."}):_&&y?(0,l.jsx)(E,{onSubmit:j}):_&&!y?(0,l.jsx)("p",{className:"text-gray-500 mb-4",children:"해당 학교 학생만 댓글을 작성할 수 있습니다."}):(0,l.jsx)("p",{className:"text-gray-500 mb-4",children:"댓글을 작성하려면 로그인하세요."}),(0,l.jsx)("div",{className:"mt-4 space-y-4",children:s.length>0?s.map(e=>(0,l.jsx)(q,{comment:e,onCommentChange:()=>b(!0),schoolCode:r},e.id)):d?(0,l.jsx)("p",{className:"text-gray-500",children:"댓글을 불러오는 중..."}):(0,l.jsx)("p",{className:"text-gray-500",children:"아직 댓글이 없습니다. 첫 댓글을 남겨보세요!"})}),x&&(0,l.jsx)("button",{className:"w-full py-2 mt-4 text-sm text-gray-600 hover:text-gray-900",onClick:()=>b(),disabled:d,children:d?"불러오는 중...":"더 보기"}),m&&(0,l.jsx)("p",{className:"text-red-500 mt-2",children:m})]})}function z(){(0,s.useRouter)();let e=(0,o.U)(),{user:t,userSchool:a,loading:r,error:c}=i(),[d,u]=(0,n.useState)(null),[m,g]=(0,n.useState)(""),h=e=>{g(e);try{let t=new URLSearchParams(window.location.search);t.set("date",e);let a="".concat(window.location.pathname,"?").concat(t.toString());window.history.replaceState({},"",a)}catch(e){console.error("주소 갱신 오류:",e)}},[f,x]=(0,n.useState)(0),[p,_]=(0,n.useState)(!1),[v,y]=(0,n.useState)(""),{meals:w,isLoading:E,error:I,dataSource:L,fetchMealInfo:A}=function(){let[e,t]=(0,n.useState)([]),[a,r]=(0,n.useState)(!1),[l,s]=(0,n.useState)(""),[o,i]=(0,n.useState)(""),c=(0,n.useCallback)(async function(e,a){let l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"E10";if(!e||!a)return void s("학교 코드와 날짜가 필요합니다.");try{r(!0),s("");let n=N(a),o=await k("".concat(C.MEALS,"?school_code=").concat(e,"&office_code=").concat(l,"&date=").concat(n));if(404===o.status){t([]),i("database"),s("해당 날짜의 급식 정보가 없습니다.");return}if(!o.ok)throw Error("API 호출 실패: ".concat(o.statusText));let c=await o.json();i(c.source||"unknown"),c.meals&&c.meals.length>0?t(c.meals):(t([]),s("해당 날짜의 급식 정보가 없습니다."))}catch(e){console.error("급식 정보 조회 오류:",e),t([]),s("급식 정보를 가져오는 중 오류가 발생했습니다: ".concat(e.message))}finally{r(!1)}},[]);return{meals:e,isLoading:a,error:l,dataSource:o,fetchMealInfo:c}}();(0,n.useEffect)(()=>{c&&y(c)},[c]),(0,n.useEffect)(()=>{{let e=new URLSearchParams(window.location.search).get("date"),t=e||S();console.log("URL에서 날짜 초기화:",{dateFromUrl:e,dateToUse:t}),u(e),g(t)}},[]),(0,n.useEffect)(()=>{let t=new URLSearchParams(window.location.search).get("notification");t?(async()=>{console.log("CASCADE_TEST_LOG: fetchNotificationMeal called with notificationId:",t,"at",new Date().toISOString());try{let{data:a,error:r}=await e.from("notifications").select("related_type, related_id").eq("id",t).maybeSingle();if(r&&"PGRST116"!==r.code){console.error("알림 조회 오류:",r),_(!1),h(S());return}if(!a||!a.related_id){console.log("Notification found, but no valid related_id for id:",t,"Notification object:",a),h(S());return}console.log("Proceeding to fetch meal with related_id:",a.related_id);let{data:l,error:n}=await e.from("meals").select("meal_date").eq("id",a.related_id).maybeSingle();if(!(null==l?void 0:l.meal_date)){console.log("Meal not found for related_id:",a.related_id),n&&"PGRST116"!==n.code&&console.error("Error fetching meal (when meal data is missing):",n),h(S());return}n&&n.code;let s=l.meal_date.replace(/^(\d{4})(\d{2})(\d{2})$/,"$1-$2-$3");h(s)}catch(e){console.error("알림 관련 급식 정보 조회 중 예기치 않은 실패:",e),h(S())}})():d&&!r?/^\d{4}-\d{2}-\d{2}$/.test(d)?h(d):h(S()):m||r||!a||h(S())},[d,r,a,e]),(0,n.useEffect)(()=>{(null==a?void 0:a.school_code)&&m&&!p&&!E&&!r&&(console.log("급식 정보 자동 로드 - 학교: ".concat(a.school_code,", 날짜: ").concat(m)),console.log("자동 로드 시 날짜 형식: ".concat(m,", 타입: ").concat(typeof m)),A(a.school_code,m,T()))},[null==a?void 0:a.school_code,m,p,r]);let R=e=>{for(let[t,a]of Object.entries({서울:"B10",부산:"C10",대구:"D10",인천:"E10",광주:"F10",대전:"G10",울산:"H10",세종:"I10",경기:"J10",강원:"K10",충북:"M10",충남:"N10",전북:"P10",전남:"Q10",경북:"R10",경남:"S10",제주:"T10"}))if(e&&e.includes(t))return a;return"B10"},T=()=>{let e="E10";return a&&(a.office_code?e=a.office_code:a.region&&(e=R(a.region))),e},{isOpen:q,title:z,content:U,openModal:D,closeModal:P}=function(){let[e,t]=(0,n.useState)(!1),[a,r]=(0,n.useState)(""),[l,s]=(0,n.useState)("");return{isOpen:e,title:a,content:l,openModal:(0,n.useCallback)((e,a)=>{r(e),s(a),t(!0)},[]),closeModal:(0,n.useCallback)(()=>{t(!1)},[])}}(),O=e=>{if(!e||!e.ntr_info)return"영양 정보가 없습니다.";try{let t=e.ntr_info.replace(/<br\s*\/?>/gi,"\n").split(/\n/).map(e=>e.trim()).filter(Boolean);if(0===t.length)return"영양 정보가 없습니다.";let a=[];for(let e=0;e<t.length;e++)a.push(t[e]),t[e].includes("지방")&&e<t.length-1&&a.push("");return a.join("\n").trim()}catch(e){return console.error("영양소 정보 파싱 오류:",e),"영양 정보 표시 중 오류가 발생했습니다."}},B=e=>!e||Array.isArray(e)&&0===e.length||"[]"===e?"상세 원산지 정보가 없습니다.":("string"==typeof e?e:JSON.stringify(e)).replace(/<br\s*\/?>/gi,"\n");return(0,l.jsxs)("div",{className:"min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8",children:[q&&(0,l.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:(0,l.jsxs)("div",{className:"bg-white rounded-lg max-w-md w-full p-6 max-h-[80vh] overflow-y-auto",children:[(0,l.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,l.jsx)("h3",{className:"text-lg font-medium text-center",children:z}),(0,l.jsx)("button",{onClick:P,className:"text-gray-500 hover:text-gray-800",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,l.jsx)("div",{className:"whitespace-pre-wrap break-words text-left",children:U})]})}),(0,l.jsxs)("div",{className:"max-w-4xl mx-auto",children:[a?(0,l.jsxs)("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 shadow-sm rounded p-2 mb-3 border-l-2 border-blue-500 flex items-center",children:[(0,l.jsx)("span",{className:"text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 text-base font-semibold",children:a.school_name}),(0,l.jsx)("span",{className:"ml-2 text-gray-600 text-xs bg-white px-1.5 py-0.5 rounded-full",children:a.region})]}):(0,l.jsx)("div",{className:"mb-6"}),(0,l.jsxs)("div",{className:"mb-2 mt-1",children:[(0,l.jsx)("input",{type:"date",id:"date",value:m,onChange:e=>{let t=e.target.value;h(t),y(""),(null==a?void 0:a.school_code)&&(A(a.school_code,t,T()),setTimeout(()=>{x(e=>e+1)},300))},className:"sr-only"}),(0,l.jsx)("button",{onClick:()=>{var e;let t=document.getElementById("date");null==t||null==(e=t.showPicker)||e.call(t)},className:"w-full flex items-center justify-between px-2 py-1.5 bg-blue-50 rounded border border-blue-100 shadow-sm",children:m&&(()=>{let e=new Date(m);if(!isNaN(e.getTime())){let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),n=["일","월","화","수","목","금","토"][e.getDay()];return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("span",{className:"text-blue-600 mr-1",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),(0,l.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"".concat(t,"-").concat(a,"-").concat(r)}),(0,l.jsx)("span",{className:"ml-1 text-xs font-medium px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded",children:n})]}),(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5 text-blue-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})}return m})()})]}),(I||v||c)&&!w.length&&(0,l.jsx)("div",{className:"mt-4 p-3 bg-red-50 text-red-700 rounded-md",children:I||v||c}),!E&&!p&&!r&&(0,l.jsx)(l.Fragment,{children:w.length>0?(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[w.map(e=>(0,l.jsxs)("div",{className:"meal-wrapper",children:[(0,l.jsx)(b,{meal:e,onShowOrigin:e=>{D("원산지 정보",B(e))},onShowNutrition:e=>{D("영양 정보",O(e))},onUploadSuccess:()=>x(e=>e+1),onUploadError:e=>{y(e),setTimeout(()=>y(""),3e3)}}),(0,l.jsx)(M,{mealId:e.id,className:"mt-4",schoolCode:e.school_code})]},e.id)),L&&(0,l.jsx)("div",{className:"col-span-1 md:col-span-2 mt-2 text-right",children:(0,l.jsxs)("p",{className:"text-xs text-gray-500",children:["데이터 소스: ",(0,l.jsx)("span",{className:"font-medium",children:L})]})})]}):(0,l.jsxs)("div",{className:"bg-white shadow-md rounded-lg p-6",children:[(0,l.jsx)("div",{className:"flex items-center justify-center mb-4",children:(0,l.jsx)("div",{className:"bg-yellow-100 rounded-full p-3",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-8 w-8 text-yellow-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})})}),(0,l.jsxs)("h3",{className:"text-lg font-medium text-center mb-2",children:[(null==a?void 0:a.school_name)||"학교"," ",j(m)," 급식 정보"]}),(0,l.jsxs)("div",{className:"bg-gray-50 p-4 rounded-md text-center",children:[(0,l.jsx)("p",{className:"text-gray-700 font-medium",children:I||v||c||"해당 날짜의 급식 정보가 없습니다."}),(0,l.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:"다른 날짜를 선택해보세요."}),L&&(0,l.jsxs)("p",{className:"text-xs text-gray-500 mt-4",children:["데이터 소스: ",(0,l.jsx)("span",{className:"font-medium",children:L})]})]})]})})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[418,845,838,794,587,315,358],()=>t(4605)),_N_E=e.O()}]);