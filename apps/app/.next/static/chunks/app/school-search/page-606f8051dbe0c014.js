(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[681],{906:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>l});var o=s(4568),a=s(7620),n=s(2942),r=s(1525);function l(){let e=(0,n.useRouter)(),t=(0,r.UU)(),[s,l]=(0,a.useState)(""),[i,c]=(0,a.useState)([]),[d,u]=(0,a.useState)(null),[m,h]=(0,a.useState)({grade:"",classNumber:""}),[g,p]=(0,a.useState)(!1),[f,b]=(0,a.useState)(""),[v,x]=(0,a.useState)(null),[N,_]=(0,a.useState)(!1),[S,y]=(0,a.useState)(!1);(0,a.useEffect)(()=>{(async()=>{let{data:{user:s}}=await t.auth.getUser();x(s),s||(b("로그인이 필요합니다"),setTimeout(()=>{e.push("/login")},2e3))})()},[e,t.auth]);let w=async()=>{if(!s.trim())return void b("검색어를 입력해주세요");p(!0),b("");try{let e,t=window.location.origin;e=t.includes("lunbat.com")||t.includes("netlify")?"".concat(t,"/.netlify/functions/schools?keyword=").concat(encodeURIComponent(s)):"".concat(t,"/api/schools?keyword=").concat(encodeURIComponent(s)),console.log("학교 검색 API 요청 URL:",e);let o=await fetch(e);if(!o.ok)throw console.error("학교 검색 API 응답 오류:",o.status,o.statusText),Error("학교 검색에 실패했습니다");let a=await o.json();c(a.schools||[]),p(!1)}catch(e){b("학교 검색 중 오류가 발생했습니다"),c([]),p(!1)}},C=e=>{u(e),c([]),l("")},j=e=>{let{name:t,value:s}=e.target;h(e=>({...e,[t]:s}))},k=async()=>{if(!v)return void b("로그인이 필요합니다");if(!d)return void b("학교를 선택해주세요");if(!m.grade)return void b("학년을 선택해주세요");if(!m.classNumber)return void b("반을 선택해주세요");_(!0),b("");try{let{data:s,error:o}=await t.from("school_infos").select("*").eq("user_id",v.id).single();if(o&&"PGRST116"!==o.code)throw o;let a={user_id:v.id,school_code:d.SD_SCHUL_CODE,school_name:d.SCHUL_NM,school_type:d.SCHUL_KND_SC_NM,region:d.LCTN_SC_NM,address:d.ORG_RDNMA,office_code:d.ATPT_OFCDC_SC_CODE,grade:m.grade,class_number:m.classNumber,updated_at:new Date().toISOString()};if(s){let{error:e}=await t.from("school_infos").update(a).eq("user_id",v.id);if(e)throw e}else{let{error:e}=await t.from("school_infos").insert([a]);if(e)throw e}y(!0),_(!1),setTimeout(()=>{e.push("/")},2e3)}catch(e){console.error("학교 정보 저장 오류:",e),b(e.message||"학교 정보 저장 중 오류가 발생했습니다"),_(!1)}};return(0,o.jsxs)("div",{className:"max-w-lg mx-auto p-4",children:[(0,o.jsx)("h1",{className:"text-2xl font-bold mb-6",children:"학교 설정"}),(0,o.jsx)("div",{className:"mb-6",children:(0,o.jsx)("form",{onSubmit:e=>{e.preventDefault(),w()},children:(0,o.jsxs)("div",{className:"flex",children:[(0,o.jsx)("input",{type:"text",value:s,onChange:e=>l(e.target.value),className:"flex-grow p-2 border rounded-l",placeholder:"학교 이름 입력 (2글자 이상)"}),(0,o.jsx)("button",{type:"submit",disabled:g,className:"bg-blue-500 hover:bg-blue-600 text-white px-4 rounded-r disabled:bg-gray-400",children:"검색"})]})})}),i.length>0&&(0,o.jsxs)("div",{className:"mb-6",children:[(0,o.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"검색 결과"}),(0,o.jsx)("ul",{className:"border rounded divide-y",children:i.map(e=>(0,o.jsxs)("li",{className:"p-3 cursor-pointer hover:bg-gray-100 ".concat((null==d?void 0:d.SD_SCHUL_CODE)===e.SD_SCHUL_CODE?"bg-blue-50":""),onClick:()=>C(e),children:[(0,o.jsx)("div",{className:"font-medium",children:e.SCHUL_NM}),(0,o.jsxs)("div",{className:"text-sm text-gray-600",children:[e.LCTN_SC_NM," | ",e.SCHUL_KND_SC_NM]}),(0,o.jsx)("div",{className:"text-xs text-gray-500",children:e.ORG_RDNMA})]},e.SD_SCHUL_CODE))})]}),d&&(0,o.jsxs)("div",{className:"mb-6 p-4 border rounded bg-gray-50",children:[(0,o.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"선택한 학교"}),(0,o.jsx)("div",{className:"font-medium",children:d.SCHUL_NM}),(0,o.jsxs)("div",{className:"text-sm text-gray-600",children:[d.LCTN_SC_NM," | ",d.SCHUL_KND_SC_NM]}),(0,o.jsx)("div",{className:"text-xs text-gray-500 mb-4",children:d.ORG_RDNMA}),(0,o.jsxs)("div",{className:"mt-4 grid grid-cols-2 gap-4",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{htmlFor:"grade",className:"block text-sm font-medium text-gray-700 mb-1",children:"학년"}),(0,o.jsxs)("select",{id:"grade",name:"grade",value:m.grade,onChange:j,className:"w-full p-2 border rounded",children:[(0,o.jsx)("option",{value:"",children:"선택하세요"}),(()=>{if(!d)return[1,2,3];let e=d.SCHUL_KND_SC_NM;return"초등학교"===e?[1,2,3,4,5,6]:("중학교"===e||e.includes("고등학교"),[1,2,3])})().map(e=>(0,o.jsxs)("option",{value:e,children:[e,"학년"]},e))]})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{htmlFor:"classNumber",className:"block text-sm font-medium text-gray-700 mb-1",children:"반"}),(0,o.jsxs)("select",{id:"classNumber",name:"classNumber",value:m.classNumber,onChange:j,className:"w-full p-2 border rounded",children:[(0,o.jsx)("option",{value:"",children:"선택하세요"}),Array.from({length:15},(e,t)=>t+1).map(e=>(0,o.jsxs)("option",{value:e,children:[e,"반"]},e))]})]})]})]}),d&&(0,o.jsxs)("div",{className:"mt-6",children:[S?(0,o.jsxs)("div",{className:"p-4 bg-green-100 border border-green-400 text-green-700 rounded mb-4",children:[(0,o.jsx)("p",{className:"font-medium",children:"학교 정보가 성공적으로 저장되었습니다!"}),(0,o.jsx)("p",{className:"text-sm mt-1",children:"잠시 후 메인 페이지로 이동합니다..."})]}):(0,o.jsx)("button",{onClick:k,disabled:N,className:"w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded font-medium disabled:bg-gray-400 disabled:cursor-not-allowed",children:N?"저장 중...":"정보 저장하기"}),f&&(0,o.jsx)("div",{className:"mt-3 p-3 bg-red-100 border border-red-400 text-red-700 rounded text-sm",children:f})]})]})}},1525:(e,t,s)=>{"use strict";s.d(t,{$k:()=>i,UU:()=>r});var o=s(4175);let a=null,n=()=>!0,r=()=>{if(a)return a;if(!n())return console.debug("서버 환경에서 Supabase 클라이언트 호출 - 제한된 기능"),{auth:{getSession:()=>({data:{session:null}}),getUser:()=>({data:{user:null}}),signOut:()=>Promise.resolve({error:null}),signInWithOAuth:()=>Promise.resolve({data:null,error:Error("서버 환경에서는 OAuth 불가")})},from:()=>({select:()=>({eq:()=>({single:()=>Promise.resolve({data:null,error:null}),data:[],error:null})})})};let e="https://izkumvvlkrkgiuuczffp.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VtdnZsa3JrZ2l1dWN6ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI3NzksImV4cCI6MjA2MDk4ODc3OX0.pQH_znuBuBfLBJdnMagX4_HE37Z8uraCp1_MaJFtEfc";try{return a=(0,o.kT)(e,t,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"},cookies:{get(e){if("undefined"!=typeof document){var t;let s="; ".concat(document.cookie).split("; ".concat(e,"="));if(2===s.length)return null==(t=s.pop())?void 0:t.split(";").shift()}},set(e,t,s){if("undefined"!=typeof document){let o="".concat(e,"=").concat(t);(null==s?void 0:s.maxAge)&&(o+="; max-age=".concat(s.maxAge)),(null==s?void 0:s.path)&&(o+="; path=".concat(s.path)),(null==s?void 0:s.domain)&&(o+="; domain=".concat(s.domain)),(null==s?void 0:s.secure)&&(o+="; secure"),(null==s?void 0:s.httpOnly)&&(o+="; httponly"),(null==s?void 0:s.sameSite)&&(o+="; samesite=".concat(s.sameSite)),document.cookie=o}},remove(e,t){if("undefined"!=typeof document){let s="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:00 GMT");(null==t?void 0:t.path)&&(s+="; path=".concat(t.path)),(null==t?void 0:t.domain)&&(s+="; domain=".concat(t.domain)),document.cookie=s}}},global:{fetch:function(){for(var e,s,o,a=arguments.length,n=Array(a),r=0;r<a;r++)n[r]=arguments[r];let l=String(n[0]instanceof URL?n[0].toString():n[0]),i=["/meal_images","/profiles","/menu_item_ratings","/school_infos","/quiz","/comment_likes"].some(e=>l.includes(e)||l.includes("school_infos")||l.includes("/quiz"));if(l.includes("/rest/v1/")){let e=(null==(o=n[1])?void 0:o.headers)||{};n[1]={...n[1],headers:{...e,apikey:t,Authorization:"Bearer ".concat(t),Accept:"application/json"}}}return!l.includes("/rest/v1/")||i||(null==(e=n[1])?void 0:e.headers)&&Object.entries((null==(s=n[1])?void 0:s.headers)||{}).some(e=>{let[t,s]=e;return"apikey"===t.toLowerCase()||"authorization"===t.toLowerCase()})?l.includes("/comment_likes")?(n[1]||(n[1]={}),n[1].headers||(n[1].headers={}),n[1].headers.Accept="application/json",n[1].headers["Content-Type"]="application/json",fetch(...n).then(e=>200!==e.status?(console.debug("comment_likes 요청 응답 코드 ".concat(e.status," 수정 처리")),new Response(JSON.stringify({data:[]}),{status:200,headers:{"Content-Type":"application/json"}})):e).catch(e=>(console.debug("좋아요 요청 처리 오류 포착:",e),new Response(JSON.stringify({data:[]}),{status:200})))):fetch(...n).catch(e=>{if(404===e.status)return new Response(JSON.stringify({error:"Not found",quiet:!0}),{status:404});throw e}):(console.debug("권한 없는 Supabase REST API 요청 차단:",l),Promise.resolve(new Response(JSON.stringify({message:"No API key found in request",hint:"No 'apikey' request header or url param was found."}),{status:401})))}}})}catch(s){return console.debug("Supabase 클라이언트 초기화 중 오류 발생 (무시됨)"),a=(0,o.kT)(e,t)}},l=async()=>{try{let e=r();await e.auth.signOut();{let e=[];for(let t=0;t<localStorage.length;t++){let s=localStorage.key(t);s&&(s.startsWith("sb-")||s.includes("supabase"))&&e.push(s)}e.forEach(e=>localStorage.removeItem(e)),sessionStorage.clear(),document.cookie.split(";").forEach(function(e){document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")})}a=null,console.debug("세션 완전 정리 완료")}catch(e){console.debug("세션 정리 중 오류 (무시됨):",e)}},i=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,s=r();console.log("\uD83D\uDD0D 로그인 시도 환경 정보:",{url:"https://izkumvvlkrkgiuuczffp.supabase.co",provider:e,userAgent:navigator.userAgent,cookiesEnabled:navigator.cookieEnabled,localStorage:"undefined"!=typeof localStorage,currentUrl:window.location.href});for(let o=1;o<=t;o++)try{console.log("\uD83D\uDE80 로그인 시도 ".concat(o,"/").concat(t," 시작")),o>1&&(console.log("\uD83E\uDDF9 이전 세션 정리 중..."),await l(),await new Promise(e=>setTimeout(e,1e3)));let{data:a}=await s.auth.getSession();console.log("\uD83D\uDCCA 현재 세션 상태:",a.session?"있음":"없음");let{data:n,error:r}=await s.auth.signInWithOAuth({provider:e,options:{redirectTo:"".concat(window.location.origin,"/auth/callback"),queryParams:{access_type:"offline",prompt:"consent"}}});if(console.log("✅ OAuth 요청 결과:",{data:n,error:r}),r)throw r;return{data:n,error:null}}catch(s){if(console.error("❌ 로그인 시도 ".concat(o,"/").concat(t," 실패:"),{error:s,errorMessage:null==s?void 0:s.message,errorCode:null==s?void 0:s.status,timestamp:new Date().toISOString()}),o===t)return{data:null,error:s};let e=1e3*Math.pow(2,o);console.log("⏳ ".concat(e,"ms 대기 후 재시도...")),await new Promise(t=>setTimeout(t,e))}}},7192:(e,t,s)=>{Promise.resolve().then(s.bind(s,906))}},e=>{var t=t=>e(e.s=t);e.O(0,[838,587,315,358],()=>t(7192)),_N_E=e.O()}]);