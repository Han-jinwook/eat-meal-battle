(()=>{var e={};e.id=80,e.ids=[80],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10523:(e,t,r)=>{"use strict";r.d(t,{UU:()=>n});var s=r(98811);let o=null,a=()=>!1,n=()=>{if(o)return o;if(!a())return console.debug("서버 환경에서 Supabase 클라이언트 호출 - 제한된 기능"),{auth:{getSession:()=>({data:{session:null}}),getUser:()=>({data:{user:null}}),signOut:()=>Promise.resolve({error:null}),signInWithOAuth:()=>Promise.resolve({data:null,error:Error("서버 환경에서는 OAuth 불가")})},from:()=>({select:()=>({eq:()=>({single:()=>Promise.resolve({data:null,error:null}),data:[],error:null})})})};let e="https://izkumvvlkrkgiuuczffp.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VtdnZsa3JrZ2l1dWN6ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI3NzksImV4cCI6MjA2MDk4ODc3OX0.pQH_znuBuBfLBJdnMagX4_HE37Z8uraCp1_MaJFtEfc";try{return o=(0,s.kT)(e,t,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"},cookies:{get(e){if("undefined"!=typeof document){let t=`; ${document.cookie}`.split(`; ${e}=`);if(2===t.length)return t.pop()?.split(";").shift()}},set(e,t,r){if("undefined"!=typeof document){let s=`${e}=${t}`;r?.maxAge&&(s+=`; max-age=${r.maxAge}`),r?.path&&(s+=`; path=${r.path}`),r?.domain&&(s+=`; domain=${r.domain}`),r?.secure&&(s+="; secure"),r?.httpOnly&&(s+="; httponly"),r?.sameSite&&(s+=`; samesite=${r.sameSite}`),document.cookie=s}},remove(e,t){if("undefined"!=typeof document){let r=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 GMT`;t?.path&&(r+=`; path=${t.path}`),t?.domain&&(r+=`; domain=${t.domain}`),document.cookie=r}}},global:{fetch:(...e)=>{let r=String(e[0]instanceof URL?e[0].toString():e[0]),s=["/meal_images","/profiles","/menu_item_ratings","/school_infos","/quiz","/comment_likes"].some(e=>r.includes(e)||r.includes("school_infos")||r.includes("/quiz"));if(r.includes("/rest/v1/")){let r=e[1]?.headers||{};e[1]={...e[1],headers:{...r,apikey:t,Authorization:`Bearer ${t}`,Accept:"application/json"}}}return!r.includes("/rest/v1/")||s||e[1]?.headers&&Object.entries(e[1]?.headers||{}).some(([e,t])=>"apikey"===e.toLowerCase()||"authorization"===e.toLowerCase())?r.includes("/comment_likes")?(e[1]||(e[1]={}),e[1].headers||(e[1].headers={}),e[1].headers.Accept="application/json",e[1].headers["Content-Type"]="application/json",fetch(...e).then(e=>200!==e.status?(console.debug(`comment_likes 요청 응답 코드 ${e.status} 수정 처리`),new Response(JSON.stringify({data:[]}),{status:200,headers:{"Content-Type":"application/json"}})):e).catch(e=>(console.debug("좋아요 요청 처리 오류 포착:",e),new Response(JSON.stringify({data:[]}),{status:200})))):fetch(...e).catch(e=>{if(404===e.status)return new Response(JSON.stringify({error:"Not found",quiet:!0}),{status:404});throw e}):(console.debug("권한 없는 Supabase REST API 요청 차단:",r),Promise.resolve(new Response(JSON.stringify({message:"No API key found in request",hint:"No 'apikey' request header or url param was found."}),{status:401})))}}})}catch(r){return console.debug("Supabase 클라이언트 초기화 중 오류 발생 (무시됨)"),o=(0,s.kT)(e,t)}}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},80388:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>k,routeModule:()=>g,serverHooks:()=>q,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{GET:()=>m,POST:()=>y});var o=r(48106),a=r(48819),n=r(12050),i=r(4235),c=r(10523),u=r(18156);let l=()=>{let e="https://izkumvvlkrkgiuuczffp.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VtdnZsa3JrZ2l1dWN6ZmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI3NzksImV4cCI6MjA2MDk4ODc3OX0.pQH_znuBuBfLBJdnMagX4_HE37Z8uraCp1_MaJFtEfc";if(!e||!t)throw Error("Supabase 환경 변수가 설정되지 않았습니다");return(0,u.UU)(e,t)};class d{async getWeeklyCriteria(e,t,r,s,o){try{if(o<1||o>6)return console.error("유효하지 않은 주차:",o),0;let a=`week_${o}_days`,{data:n,error:i}=await this.supabase.from("champion_criteria").select(a).eq("school_code",e).eq("grade",t).eq("year",r).eq("month",s).single();if(i)return console.error("주간 장원 조건 조회 실패:",i),0;return n?.[a]||0}catch(e){return console.error("주간 장원 조건 조회 중 오류:",e),0}}async getMonthlyCriteria(e,t,r,s){try{let{data:o,error:a}=await this.supabase.from("champion_criteria").select("month_total").eq("school_code",e).eq("grade",t).eq("year",r).eq("month",s).single();if(a)return console.error("월간 장원 조건 조회 실패:",a),0;return o?.month_total||0}catch(e){return console.error("월간 장원 조건 조회 중 오류:",e),0}}async updateUserWeeklyCorrect(e,t,r,s,o,a,n){try{if(a<1||a>6)return console.error("유효하지 않은 주차:",a),!1;let i=`week_${a}_correct`,{data:c,error:u}=await this.supabase.from("quiz_champions").select("id").eq("user_id",e).eq("school_code",t).eq("grade",r).eq("year",s).eq("month",o).single();if(u&&"PGRST116"!==u.code)return console.error("사용자 성적 조회 실패:",u),!1;if(c){let{error:e}=await this.supabase.from("quiz_champions").update({[i]:n}).eq("id",c.id);if(e)return console.error("사용자 주간 성적 업데이트 실패:",e),!1}else{let{error:a}=await this.supabase.from("quiz_champions").insert({user_id:e,school_code:t,grade:r,year:s,month:o,[i]:n,correct_count:n});if(a)return console.error("사용자 주간 성적 삽입 실패:",a),!1}return!0}catch(e){return console.error("사용자 주간 성적 저장 중 오류:",e),!1}}async checkAndUpdateChampionStatus(e,t,r,s,o,a){try{let n=!1;if(a){let i=await this.getWeeklyCriteria(t,r,s,o,a),{data:c,error:u}=await this.supabase.from("quiz_champions").select(`week_${a}_correct`).eq("user_id",e).eq("school_code",t).eq("grade",r).eq("year",s).eq("month",o).single();if(!u&&c){let e=c[`week_${a}_correct`]||0;n=i>0&&e===i}await this.updateUserChampionRecord(e,t,r,s,o,a,n),n&&await this.updateSchoolChampion(e,t,r,s,o,a,"weekly")}else{let a=await this.getMonthlyCriteria(t,r,s,o),{data:i,error:c}=await this.supabase.from("quiz_champions").select("correct_count").eq("user_id",e).eq("school_code",t).eq("grade",r).eq("year",s).eq("month",o).single();if(!c&&i){let e=i.correct_count||0;n=a>0&&e===a}await this.updateUserChampionRecord(e,t,r,s,o,void 0,n),n&&await this.updateSchoolChampion(e,t,r,s,o,void 0,"monthly")}return n}catch(e){return console.error("장원 상태 검사 중 오류:",e),!1}}async updateUserChampionRecord(e,t,r,s,o,a,n=!1){try{let{data:i,error:c}=await this.supabase.from("user_champion_records").select("id").eq("user_id",e).eq("school_code",t).eq("grade",r).eq("year",s).eq("month",o).single(),u={};if(a?u[`week_${a}_champion`]=n:u.month_champion=n,c&&"PGRST116"!==c.code)return console.error("장원 기록 조회 실패:",c),!1;if(i){let{error:e}=await this.supabase.from("user_champion_records").update(u).eq("id",i.id);if(e)return console.error("장원 기록 업데이트 실패:",e),!1}else{let a={user_id:e,school_code:t,grade:r,year:s,month:o,...u},{error:n}=await this.supabase.from("user_champion_records").insert(a);if(n)return console.error("장원 기록 삽입 실패:",n),!1}return!0}catch(e){return console.error("장원 기록 저장 중 오류:",e),!1}}async updateSchoolChampion(e,t,r,s,o,a,n="weekly"){try{let{data:i,error:c}=await this.supabase.from("school_champions").select("id").eq("school_code",t).eq("grade",r).eq("year",s).eq("month",o).eq("period_type",n).eq("week",a||null).single();if(c&&"PGRST116"!==c.code)return console.error("학교별 장원 기록 조회 실패:",c),!1;if(i){let{error:t}=await this.supabase.from("school_champions").update({champion_user_id:e}).eq("id",i.id);if(t)return console.error("학교별 장원 기록 업데이트 실패:",t),!1}else{let{error:i}=await this.supabase.from("school_champions").insert({school_code:t,grade:r,year:s,month:o,week:a||null,period_type:n,champion_user_id:e});if(i)return console.error("학교별 장원 기록 삽입 실패:",i),!1}return!0}catch(e){return console.error("학교별 장원 기록 저장 중 오류:",e),!1}}async getUserChampionRecords(e,t,r,s,o){try{let{data:a,error:n}=await this.supabase.from("user_champion_records").select("*").eq("user_id",e).eq("school_code",t).eq("grade",r).eq("year",s).eq("month",o).single();if(n)return console.error("사용자 장원 기록 조회 실패:",n),null;return a}catch(e){return console.error("사용자 장원 기록 조회 중 오류:",e),null}}constructor(){this.supabase=l()}}class p{getWeekInfo(e){let t=e.getFullYear(),r=e.getMonth(),s=new Date(t,r,1),o=new Date(s),a=s.getDay();o.setDate(1+(0===a?1:(8-a)%7));let n=Math.floor(Math.floor((e.getTime()-o.getTime())/864e5)/7)+1,i=new Date(o);i.setDate(o.getDate()+(n-1)*7);let c=new Date(i);return c.setDate(i.getDate()+6),{year:t,month:r+1,week_number:n,start_date:i,end_date:c}}async calculateMealDays(e,t,r,s){try{let o=r.toISOString().split("T")[0],a=s.toISOString().split("T")[0],{data:n,error:i}=await this.supabase.from("meals").select("date").eq("school_code",e).eq("grade",t).gte("date",o).lte("date",a);if(i)return console.error("급식일수 계산 오류:",i),0;return n?.length||0}catch(e){return console.error("급식일수 계산 예외:",e),0}}async getQuizResults(e,t,r,s,o){try{let a=s.toISOString().split("T")[0],n=o.toISOString().split("T")[0],{data:i,error:c}=await this.supabase.from("quiz_results").select("*").eq("user_id",e).eq("school_code",t).eq("grade",r).gte("date",a).lte("date",n);if(c)return console.error("퀴즈 결과 조회 오류:",c),{total_quiz_days:0,correct_count:0,accuracy_rate:0,avg_answer_time:0};let u=i||[],l=u.filter(e=>e.is_correct).length,d=u.length,p=u.reduce((e,t)=>e+(t.answer_time||0),0);return{total_quiz_days:d,correct_count:l,accuracy_rate:d>0?l/d*100:0,avg_answer_time:d>0?p/d:0}}catch(e){return console.error("퀴즈 결과 조회 예외:",e),{total_quiz_days:0,correct_count:0,accuracy_rate:0,avg_answer_time:0}}}async calculateWeeklyStatistics(e,t,r,s,o,a){try{let n=this.getWeekInfoByWeekNumber(s,o-1,a);if(!n)return console.error(`유효하지 않은 주차 정보: ${s}년 ${o}월 ${a}주차`),null;let i=await this.calculateMealDays(t,r,n.start_date,n.end_date),c=await this.getQuizResults(e,t,r,n.start_date,n.end_date),u=await this.criteriaService.getWeeklyCriteria(t,r,s,o,a),l=i>0&&c.correct_count===i;return u>0&&(l=c.correct_count===u),await this.criteriaService.updateUserWeeklyCorrect(e,t,r,s,o,a,c.correct_count),l&&await this.criteriaService.checkAndUpdateChampionStatus(e,t,r,s,o,a),{user_id:e,school_code:t,grade:r,year:s,month:o,week_number:a,period_type:"weekly",total_meal_days:u>0?u:i,total_count:c.total_quiz_days,correct_count:c.correct_count,accuracy_rate:c.accuracy_rate,avg_answer_time:c.avg_answer_time,is_champion:l,determined_at:l?new Date:void 0}}catch(e){return console.error("주장원 통계 계산 오류:",e),null}}async calculateMonthlyStatistics(e,t,r,s,o){try{let a=new Date(s,o-1,1),n=new Date(s,o,0),i=await this.calculateMealDays(t,r,a,n),c=await this.getQuizResults(e,t,r,a,n),u=await this.criteriaService.getMonthlyCriteria(t,r,s,o),l=i>0&&c.correct_count===i;return u>0&&(l=c.correct_count===u),l&&await this.criteriaService.checkAndUpdateChampionStatus(e,t,r,s,o),{user_id:e,school_code:t,grade:r,year:s,month:o,period_type:"monthly",total_meal_days:u>0?u:i,total_count:c.total_quiz_days,correct_count:c.correct_count,accuracy_rate:c.accuracy_rate,avg_answer_time:c.avg_answer_time,is_champion:l,determined_at:l?new Date:void 0}}catch(e){return console.error("월장원 통계 계산 오류:",e),null}}getWeekInfoByWeekNumber(e,t,r){try{if(r<=0)return console.error("유효하지 않은 주차 번호:",r),null;if(t<0||t>11)return console.error("유효하지 않은 월 (0-11 범위를 벗어남):",t),null;let s=new Date(e,t,1),o=new Date(s),a=s.getDay();o.setDate(1+(0===a?1:(8-a)%7));let n=new Date(o);if(n.setDate(o.getDate()+(r-1)*7),n.getMonth()!==t)return console.error(`주차 번호 ${r}는 ${e}년 ${t+1}월에 존재하지 않음`),null;let i=new Date(n);return i.setDate(n.getDate()+6),{year:e,month:t+1,week_number:r,start_date:n,end_date:i}}catch(e){return console.error("주차 정보 계산 오류:",e),null}}async saveStatistics(e){try{let{error:t}=await this.supabase.from("quiz_champion_history").upsert([{user_id:e.user_id,school_code:e.school_code,grade:e.grade,year:e.year,month:e.month,week_number:e.week_number,period_type:e.period_type,total_meal_days:e.total_meal_days,total_count:e.total_count,correct_count:e.correct_count,accuracy_rate:e.accuracy_rate,avg_answer_time:e.avg_answer_time,is_champion:e.is_champion,determined_at:e.determined_at?.toISOString(),is_current:!0}],{onConflict:"user_id,school_code,grade,year,month,week_number,period_type"});if(t)return console.error("통계 저장 오류:",t),!1;return!0}catch(e){return console.error("통계 저장 예외:",e),!1}}async getUserChampionRecords(e,t,r,s,o){return this.criteriaService.getUserChampionRecords(e,t,r,s,o)}constructor(){this.supabase=(0,c.UU)(),this.criteriaService=new d}}let h=new p,_=new d;async function m(e){try{let{searchParams:t}=new URL(e.url),r=t.get("user_id"),s=t.get("school_code"),o=t.get("grade")?parseInt(t.get("grade")):null,a=t.get("year")?parseInt(t.get("year")):null,n=t.get("month")?parseInt(t.get("month")):null;if(!r||!s||!o||!a||!n)return i.NextResponse.json({error:"필수 파라미터가 누락되었습니다",required:["user_id","school_code","grade","year","month"]},{status:400});let u=(0,c.UU)();if(!u)return i.NextResponse.json({error:"Supabase 클라이언트 초기화 실패"},{status:500});let{error:l}=await u.auth.getUser();if(l)return i.NextResponse.json({error:"인증 실패",details:l.message},{status:401});let d=await h.getUserChampionRecords(r,s,o,a,n);if(!d)return i.NextResponse.json({user_id:r,school_code:s,grade:o,year:a,month:n,week_1_champion:!1,week_2_champion:!1,week_3_champion:!1,week_4_champion:!1,week_5_champion:!1,month_champion:!1});return i.NextResponse.json(d)}catch(e){return console.error("장원 기록 조회 실패:",e),i.NextResponse.json({error:"장원 기록 조회 중 오류 발생",details:e?.message},{status:500})}}async function y(e){try{let{user_id:t,school_code:r,grade:s,year:o,month:a,week_number:n,period_type:u="weekly"}=await e.json();if(!t||!r||!s||!o||!a)return i.NextResponse.json({error:"필수 파라미터가 누락되었습니다",required:["user_id","school_code","grade","year","month"]},{status:400});if("weekly"===u&&!n)return i.NextResponse.json({error:"주간 장원 계산에는 week_number가 필요합니다"},{status:400});let l=(0,c.UU)();if(!l)return i.NextResponse.json({error:"Supabase 클라이언트 초기화 실패"},{status:500});let{error:d}=await l.auth.getUser();if(d)return i.NextResponse.json({error:"인증 실패",details:d.message},{status:401});let p=!1;return p="weekly"===u?await _.checkAndUpdateChampionStatus(t,r,s,o,a,n):await _.checkAndUpdateChampionStatus(t,r,s,o,a),i.NextResponse.json({user_id:t,school_code:r,grade:s,year:o,month:a,week_number:"weekly"===u?n:void 0,period_type:u,is_champion:p})}catch(e){return console.error("장원 상태 계산 실패:",e),i.NextResponse.json({error:"장원 상태 계산 중 오류 발생",details:e?.message},{status:500})}}let g=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/champion/records/route",pathname:"/api/champion/records",filename:"route",bundlePath:"app/api/champion/records/route"},resolvedPagePath:"D:\\Windsurf\\eat-meal-battle\\apps\\app\\src\\app\\api\\champion\\records\\route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:f,workUnitAsyncStorage:w,serverHooks:q}=g;function k(){return(0,n.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:w})}},80408:()=>{},81630:e=>{"use strict";e.exports=require("http")},87032:()=>{},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[50,744,156,811],()=>r(80388));module.exports=s})();